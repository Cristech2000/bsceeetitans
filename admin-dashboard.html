<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!-- Add this to the head section of your HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging-compat.js"></script>
    <!-- Add this to your head section with other Firebase imports -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - BSCEEE Y2S1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .logo {
            text-align: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .logo h2 {
            color: #004080;
            font-size: 1.5em;
        }

        .logo p {
            color: #666;
            font-size: 0.9em;
        }

        .nav-links {
            list-style: none;
            padding: 20px 0;
        }

        .nav-links li {
            padding: 12px 25px;
            margin: 5px 0;
        }

        .nav-links li a {
            text-decoration: none;
            color: #333;
            display: flex;
            align-items: center;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-links li a i {
            margin-right: 10px;
            font-size: 1.2em;
            width: 20px;
            text-align: center;
        }

        .nav-links li a:hover {
            color: #004080;
            transform: translateX(5px);
        }

        .nav-links li.active a {
            color: #004080;
            background: rgba(0, 64, 128, 0.1);
            border-radius: 8px;
            margin: 0 -10px;
            padding: 12px 15px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #004080;
            font-size: 2em;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #004080;
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card i {
            font-size: 2.5em;
            color: #004080;
            margin-bottom: 15px;
        }

        .card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .card .number {
            font-size: 2em;
            font-weight: bold;
            color: #004080;
            margin: 10px 0;
        }

        .card .description {
            color: #666;
            font-size: 0.9em;
        }

        /* Content Sections */
        .content-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .section-header h2 {
            color: #004080;
            font-size: 1.5em;
        }

        .btn {
            background: #004080;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s ease;
        }

        .btn:hover {
            background: #003366;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            color: #004080;
            font-weight: 600;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .tab {
            padding: 12px 25px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1em;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #004080;
            border-bottom: 2px solid #004080;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #004080;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-item {
            background: linear-gradient(135deg, #004080, #0066cc);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .action-btn {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .action-btn:hover {
            border-color: #004080;
            transform: translateY(-2px);
        }

        .action-btn i {
            font-size: 2em;
            color: #004080;
            margin-bottom: 10px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
            }

            .dashboard-cards {
                grid-template-columns: 1fr;
            }
        }








        /* Timetable Styles */
        .timetable-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
        }

        .timetable-table th {
            background: #004080;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
        }

        .timetable-table td {
            padding: 10px;
            border: 1px solid #ddd;
            vertical-align: top;
        }

        .timetable-table input,
        .timetable-table textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .timetable-table textarea {
            height: 60px;
            resize: vertical;
        }

        .timetable-table .time-slot {
            background: #f8f9fa;
            font-weight: 600;
            text-align: center;
        }

        .timetable-table .delete-row {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .timetable-table .delete-row:hover {
            background: #c82333;
        }





        /* Section Creator Styles - NEW VERSION */
        .section-fields {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #004080;
            position: relative;
            z-index: 1;
        }

        .item-preview {
            background: white;
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .item-preview .item-info {
            flex: 1;
        }

        .item-preview .item-actions {
            display: flex;
            gap: 5px;
        }

        .section-preview-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
        }

        .section-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .section-type-badge {
            background: #004080;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .section-content-preview {
            max-height: 200px;
            overflow: hidden;
            position: relative;
        }

        .section-content-preview::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(transparent, white);
        }

        /* Ensure buttons are clickable */
        #sectionCreatorTab .btn {
            position: relative;
            z-index: 1000;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #sectionCreatorTab .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        #createSectionBtn {
            background: #28a745 !important;
            border-color: #1e7e34 !important;
        }

        #createSectionBtn:hover {
            background: #218838 !important;
            transform: translateY(-2px) !important;
        }

        #testButton {
            background: #17a2b8 !important;
            border-color: #117a8b !important;
        }

        #testButton:hover {
            background: #138496 !important;
        }



        /* Add this to your CSS */
        .badge {
            background: #004080;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }





        /* ==================== ANNOUNCEMENTS STYLES ==================== */

        /* Form enhancements */
        .form-text {
            color: #6c757d;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .form-check {
            margin-bottom: 10px;
        }

        .form-check-input {
            margin-right: 8px;
        }

        .form-check-label {
            cursor: pointer;
        }

        /* Dropdown styles */
        .dropdown-menu {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 10px;
        }

        /* Badge styles */
        .badge {
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 5px;
        }

        /* Status badges */
        .status-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-scheduled {
            background: #cce5ff;
            color: #004085;
        }

        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }

        .status-archived {
            background: #e2e3e5;
            color: #383d41;
        }

        /* Type badges */
        .type-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .type-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .type-warning {
            background: #fff3cd;
            color: #856404;
        }

        .type-important {
            background: #f8d7da;
            color: #721c24;
        }

        .type-urgent {
            background: #dc3545;
            color: white;
        }

        .type-event {
            background: #d4edda;
            color: #155724;
        }

        .type-success {
            background: #d4edda;
            color: #155724;
        }

        /* Preview styles */
        #previewContent {
            transition: all 0.3s ease;
        }

        .preview-announcement {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid;
        }

        .preview-info {
            border-left-color: #17a2b8;
            background: #e7f3ff;
        }

        .preview-warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .preview-important {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .preview-urgent {
            border-left-color: #dc3545;
            background: #dc3545;
            color: white;
        }

        .preview-event {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .preview-success {
            border-left-color: #28a745;
            background: #d4edda;
        }

        /* Table actions */
        .table-actions {
            display: flex;
            gap: 5px;
        }

        .table-btn {
            padding: 4px 8px;
            font-size: 0.85em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .table-btn:hover {
            transform: translateY(-1px);
        }

        .btn-view {
            background: #17a2b8;
            color: white;
        }

        .btn-edit {
            background: #ffc107;
            color: #212529;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-copy {
            background: #6c757d;
            color: white;
        }

        /* Modal overlay */
        .modal {
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .closeBtn {
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }

        .closeBtn:hover {
            color: #000;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 20px;
        }

        .page-btn {
            padding: 5px 12px;
            border: 1px solid #dee2e6;
            background: white;
            color: #004080;
            cursor: pointer;
            border-radius: 4px;
        }

        .page-btn:hover {
            background: #004080;
            color: white;
        }

        .page-btn.active {
            background: #004080;
            color: white;
            border-color: #004080;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 10px !important;
            }

            .modal-content {
                margin: 10px;
                padding: 20px;
            }

            .table-container {
                overflow-x: auto;
                font-size: 0.9em;
            }

            .table-actions {
                flex-wrap: wrap;
            }
        }

        /* Loading spinner */
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .fa-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }



        /* Add these to your existing CSS */
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .table-actions {
            display: flex;
            gap: 5px;
        }

        .table-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .btn-view {
            background: #17a2b8;
            color: white;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>

    <div class="admin-container">

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <h2><i class="fas fa-cogs"></i> Admin Panel</h2>
                <p>BSCEEE Y2S1</p>
            </div>
            <ul class="nav-links">
                <li class="active"><a href="#" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt"></i>
                        Dashboard</a></li>
                <li><a href="#" onclick="showSection('content')"><i class="fas fa-edit"></i> Content Management</a></li>
                <li><a href="#" onclick="showSection('registrations')"><i class="fas fa-users"></i> Student
                        Registrations</a></li>
                <!-- In the sidebar section, add this line after the "Pending Students" menu item -->
                <li><a href="#" onclick="showSection('tripShifts')"><i class="fas fa-bus"></i> Trip Shifts</a></li>
                <li><a href="#" onclick="showSection('complaints')"><i class="fas fa-exclamation-circle"></i> Academic
                        Complaints</a></li>
                <li><a href="#" onclick="showSection('groups')"><i class="fas fa-layer-group"></i> Group Management</a>
                </li>
                <li><a href="#" onclick="showSection('pending')"><i class="fas fa-clock"></i> Pending Students</a></li>
                <li><a href="#" onclick="showSection('announcements')"><i class="fas fa-bullhorn"></i> Announcements</a>
                </li>
                <li><a href="#" onclick="showSection('users')"><i class="fas fa-user-shield"></i> User Management</a>
                </li>
                <li><a href="#" onclick="showSection('settings')"><i class="fas fa-cog"></i> Settings</a></li>
                <li><a href="#" onclick="showSection('practicalHub')"><i class="fas fa-microchip"></i> Practical
                        Electronics Hub</a></li>
                <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">

            <!-- Header -->
            <div class="header">
                <h1 id="currentSection">Dashboard Overview</h1>
                <div class="user-info">
                    <img src="https://ui-avatars.com/api/?name=Admin+User&background=004080&color=fff" alt="Admin">
                    <span id="adminName">Welcome, Admin</span>
                </div>
            </div>

            <!-- Dashboard Overview -->
            <div id="dashboardSection" class="content-section">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="totalStudents">0</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalGroups">0</div>
                        <div class="stat-label">Groups Formed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="pendingStudents">0</div>
                        <div class="stat-label">Pending Students</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="completionRate">0%</div>
                        <div class="stat-label">Registration Complete</div>
                    </div>
                </div>

                <div class="quick-actions">
                    <div class="action-btn" onclick="showSection('content')">
                        <i class="fas fa-edit"></i>
                        <h3>Edit Website</h3>
                        <p>Update homepage content</p>
                    </div>
                    <div class="action-btn" onclick="showSection('registrations')">
                        <i class="fas fa-users"></i>
                        <h3>View Registrations</h3>
                        <p>Student applications</p>
                    </div>
                    <div class="action-btn" onclick="showSection('groups')">
                        <i class="fas fa-layer-group"></i>
                        <h3>Manage Groups</h3>
                        <p>Group assignments</p>
                    </div>
                    <div class="action-btn" onclick="showSection('announcements')">
                        <i class="fas fa-bullhorn"></i>
                        <h3>Post Announcement</h3>
                        <p>Class updates</p>
                    </div>
                </div>

                <div class="dashboard-cards">
                    <div class="card">
                        <i class="fas fa-user-plus"></i>
                        <h3>Individual Registrations</h3>
                        <div class="number" id="individualRegs">0</div>
                        <p class="description">Students registered individually</p>
                    </div>
                    <div class="card">
                        <i class="fas fa-users"></i>
                        <h3>Group Registrations</h3>
                        <div class="number" id="groupRegs">0</div>
                        <p class="description">Complete groups formed</p>
                    </div>
                    <div class="card">
                        <i class="fas fa-clock"></i>
                        <h3>Pending Approval</h3>
                        <div class="number" id="pendingApproval">0</div>
                        <p class="description">Awaiting group placement</p>
                    </div>
                    <div class="card">
                        <i class="fas fa-chart-line"></i>
                        <h3>Progress</h3>
                        <div class="number" id="progressPercent">0%</div>
                        <p class="description">Overall completion</p>
                    </div>
                </div>
            </div>


            <!-- Announcements Management Section -->
            <div id="announcementsSection" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-bullhorn"></i> Announcements Management</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="showAnnouncementsTab('create')">
                            <i class="fas fa-plus"></i> New Announcement
                        </button>
                        <button class="btn btn-secondary" onclick="loadAnnouncements()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tabs">
                    <div class="tab active" onclick="showAnnouncementsTab('create')">
                        <i class="fas fa-plus-circle"></i> Create
                    </div>
                    <div class="tab" onclick="showAnnouncementsTab('manage')">
                        <i class="fas fa-list"></i> Manage <span id="activeCountBadge" class="badge">0</span>
                    </div>
                    <div class="tab" onclick="showAnnouncementsTab('history')">
                        <i class="fas fa-history"></i> History
                    </div>
                    <div class="tab" onclick="showAnnouncementsTab('settings')">
                        <i class="fas fa-cog"></i> Settings
                    </div>

                </div>

                <!-- Tab 1: Create Announcement -->
                <div id="createAnnouncementTab" class="tab-content active">
                    <div style="max-width: 800px; margin: 0 auto;">
                        <h3 style="margin-bottom: 20px; color: #004080;">Create New Announcement</h3>

                        <div class="form-group">
                            <label><i class="fas fa-heading"></i> Announcement Title *</label>
                            <input type="text" id="announcementTitle" class="form-control"
                                placeholder="Enter a clear, descriptive title" maxlength="100">
                            <small class="form-text">Max 100 characters</small>
                        </div>

                        <div class="form-group">
                            <label><i class="fas fa-comment-alt"></i> Announcement Message *</label>
                            <textarea id="announcementMessage" class="form-control" rows="5"
                                placeholder="Enter the full announcement message"></textarea>
                            <small class="form-text">You can use basic HTML tags like &lt;strong&gt;, &lt;em&gt;,
                                &lt;a&gt;</small>
                        </div>

                        <div class="form-row" style="display: flex; gap: 20px; margin-bottom: 20px;">
                            <div class="form-group" style="flex: 1;">
                                <label><i class="fas fa-tag"></i> Type</label>
                                <select id="announcementType" class="form-control">
                                    <option value="info" style="background: #e7f3ff;">‚ÑπÔ∏è Information</option>
                                    <option value="warning" style="background: #fff3cd;">‚ö†Ô∏è Warning</option>
                                    <option value="important" style="background: #f8d7da;">‚ùó Important</option>
                                    <option value="urgent" style="background: #dc3545; color: white;">üö® Urgent</option>
                                    <option value="event" style="background: #d4edda;">üìÖ Event</option>
                                    <option value="success" style="background: #d4edda;">‚úÖ Success</option>
                                </select>
                            </div>

                            <div class="form-group" style="flex: 1;">
                                <label><i class="fas fa-users"></i> Audience</label>
                                <select id="announcementAudience" class="form-control">
                                    <option value="all">üë• All Students</option>
                                    <option value="year2">üéì Year 2 Only</option>
                                    <option value="bsc-eee">‚ö° BSC EEE Only</option>
                                    <option value="faculty">üë®‚Äçüè´ Faculty</option>
                                    <option value="admins">üîê Admins Only</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label><i class="fas fa-bell"></i> Notification Options</label>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                <div class="form-check" style="margin-bottom: 10px;">
                                    <input class="form-check-input" type="checkbox" id="sendPushNotification" checked>
                                    <label class="form-check-label" for="sendPushNotification">
                                        <strong>Send as Push Notification</strong><br>
                                        <small>Users will receive a browser notification</small>
                                    </label>
                                </div>

                                <div class="form-check" style="margin-bottom: 10px;">
                                    <input class="form-check-input" type="checkbox" id="showOnWebsite" checked>
                                    <label class="form-check-label" for="showOnWebsite">
                                        <strong>Show on Website Banner</strong><br>
                                        <small>Display announcement prominently on homepage</small>
                                    </label>
                                </div>

                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="markAsImportant">
                                    <label class="form-check-label" for="markAsImportant">
                                        <strong>Mark as Important</strong><br>
                                        <small>Adds a star icon and pins to top</small>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="form-row" style="display: flex; gap: 20px; margin-bottom: 20px;">
                            <div class="form-group" style="flex: 1;">
                                <label><i class="fas fa-calendar-plus"></i> Schedule (Optional)</label>
                                <input type="datetime-local" id="announcementSchedule" class="form-control">
                                <small class="form-text">Schedule for future date/time</small>
                            </div>

                            <div class="form-group" style="flex: 1;">
                                <label><i class="fas fa-calendar-times"></i> Expiry (Optional)</label>
                                <input type="datetime-local" id="announcementExpiry" class="form-control">
                                <small class="form-text">Auto-remove after this date</small>
                            </div>
                        </div>

                        <div class="form-group">
                            <label><i class="fas fa-link"></i> Link (Optional)</label>
                            <input type="url" id="announcementLink" class="form-control"
                                placeholder="https://example.com (for more information)">
                        </div>

                        <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee;">
                            <div style="display: flex; gap: 15px; justify-content: center;">
                                <button class="btn" onclick="createAnnouncement()"
                                    style="background: #28a745; padding: 12px 30px; font-size: 1.1em;">
                                    <i class="fas fa-paper-plane"></i> Publish Announcement
                                </button>

                                <button class="btn btn-secondary" onclick="previewAnnouncement()"
                                    style="padding: 12px 25px;">
                                    <i class="fas fa-eye"></i> Preview
                                </button>

                                <button class="btn btn-secondary" onclick="clearAnnouncementForm()"
                                    style="background: #6c757d; padding: 12px 25px;">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                        </div>

                        <!-- Preview Section -->
                        <div id="announcementPreview" style="margin-top: 30px; display: none;">
                            <h4 style="color: #004080; margin-bottom: 15px;">
                                <i class="fas fa-desktop"></i> Preview
                            </h4>
                            <div id="previewContent" style="background: white; border: 2px solid #dee2e6; 
                     border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <!-- Preview will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 2: Manage Announcements -->
                <div id="manageAnnouncementsTab" class="tab-content" style="display: none;">
                    <div
                        style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="color: #004080;">Active Announcements</h3>
                        <div>
                            <button class="btn btn-secondary" onclick="exportAnnouncements()"
                                style="margin-right: 10px;">
                                <i class="fas fa-file-excel"></i> Export
                            </button>
                            <div class="dropdown" style="display: inline-block;">
                                <button class="btn btn-secondary dropdown-toggle" type="button" data-toggle="dropdown"
                                    style="background: #6c757d;">
                                    <i class="fas fa-filter"></i> Filter
                                </button>
                                <div class="dropdown-menu" style="padding: 10px; min-width: 200px;">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="filterActive" checked
                                            onchange="filterAnnouncements()">
                                        <label class="form-check-label" for="filterActive">Active</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="filterScheduled"
                                            onchange="filterAnnouncements()">
                                        <label class="form-check-label" for="filterScheduled">Scheduled</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="filterExpired"
                                            onchange="filterAnnouncements()">
                                        <label class="form-check-label" for="filterExpired">Expired</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="announcementsTable" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th width="100">Type</th>
                                    <th width="100">Audience</th>
                                    <th width="120">Status</th>
                                    <th width="150">Created</th>
                                    <th width="80">Views</th>
                                    <th width="150">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="announcementsTableBody">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 30px;">
                                        <div style="color: #6c757d;">
                                            <i class="fas fa-bullhorn fa-2x" style="margin-bottom: 10px;"></i><br>
                                            No announcements yet. Create your first one!
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="announcementsPagination" style="margin-top: 20px; text-align: center; display: none;">
                        <!-- Pagination will be inserted here -->
                    </div>
                </div>

                <!-- Tab 3: History -->
                <div id="historyAnnouncementTab" class="tab-content" style="display: none;">
                    <h3 style="color: #004080; margin-bottom: 20px;">Announcements History</h3>

                    <div class="table-container">
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Published</th>
                                    <th>Expired/Archived</th>
                                    <th>Total Views</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 30px;">
                                        <i class="fas fa-spinner fa-spin"></i> Loading history...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab 4: Settings -->
                <div id="settingsAnnouncementTab" class="tab-content" style="display: none;">
                    <h3 style="color: #004080; margin-bottom: 20px;">Announcement Settings</h3>

                    <div style="max-width: 600px;">
                        <div class="form-group">
                            <label>Default Announcement Duration</label>
                            <select id="defaultDuration" class="form-control">
                                <option value="7">7 days</option>
                                <option value="14" selected>14 days</option>
                                <option value="30">30 days</option>
                                <option value="0">Never expire</option>
                            </select>
                            <small class="form-text">How long announcements stay active by default</small>
                        </div>

                        <div class="form-group">
                            <label>Maximum Active Announcements</label>
                            <input type="number" id="maxActiveAnnouncements" class="form-control" value="5" min="1"
                                max="20" step="1">
                            <small class="form-text">Maximum number of active announcements shown at once</small>
                        </div>

                        <div class="form-group">
                            <label>Auto-archive after</label>
                            <select id="autoArchiveDays" class="form-control">
                                <option value="30">30 days</option>
                                <option value="60">60 days</option>
                                <option value="90">90 days</option>
                                <option value="0">Never auto-archive</option>
                            </select>
                            <small class="form-text">Automatically move old announcements to history</small>
                        </div>

                        <div class="form-group">
                            <label>Notification Settings</label>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enablePushNotifications"
                                        checked>
                                    <label class="form-check-label" for="enablePushNotifications">
                                        Enable Push Notifications
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableEmailNotifications">
                                    <label class="form-check-label" for="enableEmailNotifications">
                                        Enable Email Notifications (Future)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableSound" checked>
                                    <label class="form-check-label" for="enableSound">
                                        Play sound for new announcements
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Default Audience</label>
                            <select id="defaultAudience" class="form-control">
                                <option value="all" selected>All Students</option>
                                <option value="year2">Year 2 Only</option>
                                <option value="bsc-eee">BSC EEE Only</option>
                            </select>
                            <small class="form-text">Default audience for new announcements</small>
                        </div>

                        <div style="margin-top: 30px;">
                            <button class="btn" onclick="saveAnnouncementSettings()"
                                style="background: #004080; padding: 10px 30px;">
                                <i class="fas fa-save"></i> Save Settings
                            </button>
                            <button class="btn btn-secondary" onclick="resetAnnouncementSettings()"
                                style="margin-left: 10px;">
                                <i class="fas fa-undo"></i> Reset to Defaults
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Edit Announcement Modal -->
                <div id="editAnnouncementModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                        <span class="closeBtn" onclick="closeEditModal()">&times;</span>
                        <h3 id="editModalTitle">Edit Announcement</h3>
                        <div id="editAnnouncementForm">
                            <!-- Edit form will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>


            <!-- Registrations Section -->
            <div id="registrationsSection" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-users"></i> Student Registrations</h2>
                    <button class="btn" onclick="downloadRegistrations()">
                        <i class="fas fa-download"></i> Export Excel
                    </button>
                </div>
                <div class="table-container">
                    <table id="registrationsTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Full Name</th>
                                <th>Reg Number</th>
                                <th>Phone Number</th>
                                <th>Timestamp</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 20px;">
                                    Click "Load Registrations" to view data
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="loadRegistrationsTable()">
                        <i class="fas fa-sync"></i> Load Registrations
                    </button>
                </div>
            </div>
            <!-- Add this after the existing sections, before the closing </div> of main-content -->
            <div id="tripShiftsSection" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-bus"></i> Trip Shift Registrations</h2>
                    <button class="btn" onclick="exportTripShifts()">
                        <i class="fas fa-download"></i> Export Excel
                    </button>
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="showTripShiftTab('shift1')">Shift 1 (51 students)</div>
                    <div class="tab" onclick="showTripShiftTab('shift2')">Shift 2 (52 students)</div>
                    <div class="tab" onclick="showTripShiftTab('stats')">Statistics</div>
                </div>

                <!-- Shift 1 Tab -->
                <div id="shift1Tab" class="tab-content active">
                    <h3>Shift 1 Registrations <span id="shift1Count" class="badge">0/51</span></h3>
                    <div class="table-container">
                        <table id="shift1Table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Full Name</th>
                                    <th>Registration Number</th>
                                    <th>Timestamp</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 20px;">
                                        Click "Load Shift 1" to view registrations
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="loadTripShift('shift1')">
                            <i class="fas fa-sync"></i> Load Shift 1
                        </button>
                    </div>
                </div>

                <!-- Shift 2 Tab -->
                <div id="shift2Tab" class="tab-content" style="display: none;">
                    <h3>Shift 2 Registrations <span id="shift2Count" class="badge">0/52</span></h3>
                    <div class="table-container">
                        <table id="shift2Table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Full Name</th>
                                    <th>Registration Number</th>
                                    <th>Timestamp</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 20px;">
                                        Click "Load Shift 2" to view registrations
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="loadTripShift('shift2')">
                            <i class="fas fa-sync"></i> Load Shift 2
                        </button>
                    </div>
                </div>

                <!-- Statistics Tab -->
                <div id="statsTab" class="tab-content" style="display: none;">
                    <h3>Trip Shift Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="totalTripRegs">0</div>
                            <div class="stat-label">Total Registered</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="shift1Percentage">0%</div>
                            <div class="stat-label">Shift 1 Capacity</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="shift2Percentage">0%</div>
                            <div class="stat-label">Shift 2 Capacity</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="availableSpots">0</div>
                            <div class="stat-label">Remaining Spots</div>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="loadTripShiftStats()">
                            <i class="fas fa-chart-bar"></i> Load Statistics
                        </button>
                    </div>
                </div>
            </div>
            <!-- Complaints Section -->
            <div id="complaintsSection" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-exclamation-circle"></i> Academic Support Complaints</h2>
                    <button class="btn" onclick="exportComplaintsToExcel()">
                        <i class="fas fa-download"></i> Export to Excel
                    </button>
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="showComplaintsSubTab('missingMarks')">Missing Marks Complaints
                    </div>
                    <div class="tab" onclick="showComplaintsSubTab('anonymousIssues')">Anonymous Class Issues</div>
                    <div class="tab" onclick="showComplaintsSubTab('courseRegistrationIssues')">courseRegistrationIssues
                    </div>

                </div>

                <!-- Missing Marks Complaints -->
                <div id="missingMarksTab" class="tab-content active">
                    <div class="tabs">
                        <div class="tab active" onclick="showComplaintsYear('year1')">1st Year</div>
                        <div class="tab" onclick="showComplaintsYear('year2')">2nd Year</div>
                        <div class="tab" onclick="showComplaintsYear('year3')">3rd Year</div>
                        <div class="tab" onclick="showComplaintsYear('year4')">4th Year</div>
                        <div class="tab" onclick="showComplaintsYear('year5')">5th Year</div>
                    </div>

                    <div id="complaintsContent">
                        <h3 id="complaintsYearTitle">1st Year Complaints</h3>
                        <div class="table-container">
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Registration No</th>
                                        <th>Unit</th>
                                        <th>Lecturer</th>
                                        <th>Submitted At</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="complaintsTableBody">
                                    <tr>
                                        <td colspan="6" style="text-align: center; padding: 20px;">
                                            Select a year and click "Load Complaints" to view data
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn" onclick="loadComplaintsForYear(currentComplaintsYear)">
                                <i class="fas fa-sync"></i> Load Complaints
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Anonymous Issues -->
                <div id="anonymousIssuesTab" class="tab-content" style="display: none;">
                    <h3>Anonymous Class Issues</h3>
                    <div class="table-container">
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Issue Type</th>
                                    <th>Description</th>
                                    <th>Year</th>
                                    <th>Submitted At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="anonymousIssuesTableBody">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 20px;">
                                        Click "Load Issues" to view data
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="loadAnonymousIssues()">
                            <i class="fas fa-sync"></i> Load Issues
                        </button>
                    </div>
                </div>



                <!-- In the complaints section, change the courseRegistrationIssuesTab ID -->
                <div id="courseRegistrationIssuesTab" class="tab-content" style="display: none;">
                    <div class="tabs">
                        <div class="tab active" onclick="handleCourseIssuesTab('pending')">
                            Pending Issues <span id="pendingIssuesCount" class="badge">0</span>
                        </div>
                        <div class="tab" onclick="handleCourseIssuesTab('resolved')">
                            Resolved Issues
                        </div>
                        <div class="tab" onclick="handleCourseIssuesTab('all')">
                            All Issues
                        </div>
                    </div>

                    <!-- Pending Issues Tab -->
                    <div id="pendingCourseIssuesTab" class="tab-content active">
                        <!-- Change the IDs of all tables and bodies to be unique -->
                        <div class="table-container">
                            <table id="coursePendingIssuesTable" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Name</th>
                                        <th>Registration No</th>
                                        <th>Issue Type</th>
                                        <th>Year</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="coursePendingIssuesBody">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 30px;">
                                            Loading pending issues...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Resolved Issues Tab -->
                    <div id="resolvedCourseIssuesTab" class="tab-content" style="display: none;">
                        <div class="table-container">
                            <table id="courseResolvedIssuesTable" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Name</th>
                                        <th>Registration No</th>
                                        <th>Issue Type</th>
                                        <th>Resolved By</th>
                                        <th>Resolved On</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="courseResolvedIssuesBody">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 30px;">
                                            Loading resolved issues...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- All Issues Tab -->
                    <div id="allCourseIssuesTab" class="tab-content" style="display: none;">
                        <div class="table-container">
                            <table id="courseAllIssuesTable" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Name</th>
                                        <th>Registration No</th>
                                        <th>Issue Type</th>
                                        <th>Year</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="courseAllIssuesBody">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 30px;">
                                            Loading all issues...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>








            </div>
            <!-- Content Management Section -->
            <div id="contentSection" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-edit"></i> Website Content Management</h2>
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="showContentTab('homepage')">Homepage</div>
                    <div class="tab" onclick="showContentTab('announcements')">Announcements</div>
                    <div class="tab" onclick="showContentTab('timetable')">Timetable</div>
                    <div class="tab" onclick="showContentTab('quiz')">Weekly Quiz</div>
                    <div class="tab" onclick="showContentTab('studydocs')">Study Documents</div>
                    <div class="tab" onclick="showContentTab('personnel')">Personnel</div>
                    <div class="tab" onclick="showContentTab('sectionCreator')">Section Editor</div>
                </div>
                <div id="homepageTab" class="tab-content active">
                    <h3>Homepage Sections</h3>
                    <div class="quick-actions">
                        <div class="action-btn" onclick="editContent('hero')">
                            <i class="fas fa-heading"></i>
                            <h3>Hero Section</h3>
                            <p>Main title & subtitle</p>
                        </div>
                        <div class="action-btn" onclick="editContent('about')">
                            <i class="fas fa-info-circle"></i>
                            <h3>About Section</h3>
                            <p>Website description</p>
                        </div>
                        <div class="action-btn" onclick="editContent('features')">
                            <i class="fas fa-users"></i>
                            <h3>Who We Are</h3>
                            <p>Class information</p>
                        </div>
                        <div class="action-btn" onclick="editContent('news')">
                            <i class="fas fa-newspaper"></i>
                            <h3>Latest News</h3>
                            <p>News & updates</p>
                        </div>
                        <div class="action-btn" onclick="editContent('funFacts')">
                            <i class="fas fa-lightbulb"></i>
                            <h3>Fun Facts</h3>
                            <p>Engineering facts</p>
                        </div>
                        <div class="action-btn" onclick="editContent('spotlight')">
                            <i class="fas fa-star"></i>
                            <h3>Student Spotlight</h3>
                            <p>Featured students</p>
                        </div>
                    </div>
                </div>

                <!-- STUDY DOCS TAB - MOVED TO BE AT SAME LEVEL AS OTHER TABS -->
                <div id="studydocsTab" class="tab-content" style="display: none;">
                    <h3>Study Documents Management</h3>

                    <div class="form-group">
                        <label>Select Semester:</label>
                        <select id="semesterSelect" class="form-control" onchange="toggleCustomInputs()">
                            <option value="year1sem1">Year 1 Semester 1</option>
                            <option value="year1sem2">Year 1 Semester 2</option>
                            <option value="year2sem1">Year 2 Semester 1</option>
                            <option value="year2sem2">Year 2 Semester 2</option>
                            <option value="other">Other (Custom)</option>
                        </select>
                    </div>

                    <div id="customSemesterGroup" class="form-group" style="display: none;">
                        <label>Custom Semester Name:</label>
                        <input type="text" id="customSemester" class="form-control"
                            placeholder="e.g., Year 3 Semester 1, Year 1 Trimester 2">
                        <small>Enter any semester name (will be converted to lowercase, no spaces)</small>
                    </div>

                    <div class="form-group">
                        <label>Select Course:</label>
                        <select id="courseSelect" class="form-control" onchange="toggleCustomInputs()">
                            <option value="EENG111">EENG 111</option>
                            <option value="EENG112">EENG 112</option>
                            <option value="EENG291">EENG 291</option>
                            <option value="EENG271">EENG 271</option>
                            <option value="other">Other (Custom)</option>
                        </select>
                    </div>

                    <div id="customCourseGroup" class="form-group" style="display: none;">
                        <label>Custom Course Code:</label>
                        <input type="text" id="customCourse" class="form-control"
                            placeholder="e.g., MATH 201, PHYS 101">
                        <small>Enter any course code (will be converted to uppercase, no spaces)</small>
                    </div>

                    <div class="form-group">
                        <label>Document Type:</label>
                        <select id="docTypeSelect" class="form-control">
                            <option value="exam">Exam Paper</option>
                            <option value="cat">CAT</option>
                            <option value="notes">Notes</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Document Title:</label>
                        <input type="text" id="docTitle" class="form-control"
                            placeholder="e.g., EXAM 2024/2025, Final Notes, Assignment 1">
                    </div>

                    <div class="form-group">
                        <label>Google Drive Link:</label>
                        <input type="url" id="driveLink" class="form-control"
                            placeholder="https://drive.google.com/file/d/...">
                    </div>

                    <button class="btn" onclick="addStudyDocument()">
                        <i class="fas fa-plus"></i> Add Document
                    </button>

                    <hr style="margin: 20px 0;">

                    <h4>Existing Documents</h4>
                    <div id="existingDocsList" class="table-container">
                        <!-- Existing documents will be listed here -->
                    </div>
                </div>

                <!-- Add other tab contents here -->
                <div id="announcementsTab" class="tab-content" style="display: none;">
                    <h3>Announcements Management</h3>
                    <p>Announcements content goes here...</p>
                </div>

                <div id="timetableTab" class="tab-content" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-calendar-alt"></i> Timetable Management</h2>
                        <div>
                            <button class="btn btn-secondary" onclick="loadTimetableData()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                            <button class="btn" onclick="saveTimetableData()">
                                <i class="fas fa-save"></i> Save All Changes
                            </button>
                        </div>
                    </div>

                    <div class="tabs">
                        <div class="tab active" onclick="showTimetableTab('regular')">Regular Timetable</div>
                        <div class="tab" onclick="showTimetableTab('exam')">Exam Timetable</div>
                    </div>

                    <!-- Regular Timetable -->
                    <div id="regularTimetableTab" class="tab-content active">
                        <h3>Regular Class Timetable</h3>

                        <div class="form-group">
                            <label>Academic Period:</label>
                            <input type="text" id="regularPeriod" class="form-control"
                                placeholder="e.g., SEMESTER 2 2024/2025 ACADEMIC YEAR">
                        </div>

                        <div class="table-container">
                            <table class="timetable-table">
                                <thead>
                                    <tr>
                                        <th>Time/Day</th>
                                        <th>Monday</th>
                                        <th>Tuesday</th>
                                        <th>Wednesday</th>
                                        <th>Thursday</th>
                                        <th>Friday</th>
                                    </tr>
                                </thead>
                                <tbody id="regularTimetableBody">
                                    <!-- Times will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Exam Timetable -->
                    <div id="examTimetableTab" class="tab-content" style="display: none;">
                        <h3>Examination Timetable</h3>

                        <div class="form-group">
                            <label>Examination Period:</label>
                            <input type="text" id="examPeriod" class="form-control"
                                placeholder="e.g., END OF SEMESTER 2 EXAMINATIONS 2024/2025">
                        </div>

                        <div class="table-container">
                            <table class="timetable-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Time</th>
                                        <th>Unit Code</th>
                                        <th>Unit Name</th>
                                        <th>Venue</th>
                                    </tr>
                                </thead>
                                <tbody id="examTimetableBody">
                                    <!-- Exam schedule will be populated by JavaScript -->
                                </tbody>
                            </table>
                            <button type="button" class="btn" onclick="addExamRow()" style="margin-top: 10px;">
                                <i class="fas fa-plus"></i> Add Exam Row
                            </button>
                        </div>
                    </div>
                </div>

                <div id="quizTab" class="tab-content" style="display: none;">
                    <h3>Weekly Quiz Management</h3>
                    <p>Quiz content goes here...</p>
                </div>
                <!-- Personnel Management Tab -->
                <div id="personnelTab" class="tab-content" style="display: none;">
                    <h3>Personnel Management</h3>

                    <div class="tabs">
                        <div class="tab active" onclick="showPersonnelSubTab('classLeadership')">Class Leadership</div>
                        <div class="tab" onclick="showPersonnelSubTab('facultyLeadership')">Faculty Leadership</div>
                        <div class="tab" onclick="showPersonnelSubTab('lecturers')">Lecturers</div>
                    </div>

                    <!-- Class Leadership Sub-tab -->
                    <div id="classLeadershipTab" class="tab-content active">
                        <h4>Class Leadership Management</h4>
                        <button class="btn" onclick="addPersonnelRow('classLeadership')" style="margin-bottom: 15px;">
                            <i class="fas fa-plus"></i> Add Class Leader
                        </button>

                        <div class="table-container">
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Position</th>
                                        <th>Name</th>
                                        <th>Phone</th>
                                        <th>Role Description</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="classLeadershipBody">
                                    <!-- Dynamic content will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Faculty Leadership Sub-tab -->
                    <div id="facultyLeadershipTab" class="tab-content" style="display: none;">
                        <h4>Faculty Leadership Management</h4>
                        <button class="btn" onclick="addPersonnelRow('facultyLeadership')" style="margin-bottom: 15px;">
                            <i class="fas fa-plus"></i> Add Faculty Leader
                        </button>

                        <div class="table-container">
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Position</th>
                                        <th>Name</th>
                                        <th>Phone</th>
                                        <th>Role Description</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="facultyLeadershipBody">
                                    <!-- Dynamic content will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>





                <!-- Lecturers Sub-tab -->
                <div id="lecturersTab" class="tab-content" style="display: none;">
                    <h4>Lecturers Management</h4>

                    <div class="form-group">
                        <label>Select Semester:</label>
                        <select id="lecturerSemester" class="form-control" onchange="loadLecturers()">
                            <option value="year1sem1">Year 1 Semester 1</option>
                            <option value="year1sem2">Year 1 Semester 2</option>
                            <option value="year2sem1">Year 2 Semester 1</option>
                            <option value="year2sem2">Year 2 Semester 2</option>
                            <option value="year3sem1">Year 3 Semester 1</option>
                            <option value="year3sem2">Year 3 Semester 2</option>
                            <option value="year4sem1">Year 4 Semester 1</option>
                            <option value="year4sem2">Year 4 Semester 2</option>
                            <option value="year5sem1">Year 5 Semester 1</option>
                            <option value="year5sem2">Year 5 Semester 2</option>
                        </select>
                    </div>

                    <button class="btn" onclick="addLecturerRow()" style="margin-bottom: 15px;">
                        <i class="fas fa-plus"></i> Add Lecturer
                    </button>

                    <div class="table-container">
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Course Code</th>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="lecturersBody">
                                <!-- Dynamic content will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>



                <!-- Section Creator Tab -->
                <div id="sectionCreatorTab" class="tab-content" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-plus-circle"></i> Section Creator</h2>
                        <p>Add new sections to the homepage dynamically</p>
                    </div>

                    <!-- REMOVED the nested .content-section div and placed content directly -->
                    <div
                        style="background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); margin-bottom: 20px;">
                        <h3>Create New Section</h3>

                        <div class="form-group">
                            <label>Section Type:</label>
                            <select id="sectionType" class="form-control">
                                <option value="text">Text Content</option>
                                <option value="documents">Documents List</option>
                                <option value="links">Links List</option>
                                <option value="custom">Custom HTML</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Section Title:</label>
                            <input type="text" id="sectionTitle" class="form-control"
                                placeholder="e.g., Important Announcements, Resources, etc.">
                        </div>

                        <div class="form-group">
                            <label>Section ID (no spaces):</label>
                            <input type="text" id="sectionId" class="form-control"
                                placeholder="e.g., announcements, resources, links">
                            <small>This will be used as the HTML ID and Firebase reference</small>
                        </div>

                        <!-- Text Content Fields -->
                        <div id="textFields" class="section-fields">
                            <div class="form-group">
                                <label>Content:</label>
                                <textarea id="sectionContent" class="form-control" rows="6"
                                    placeholder="Enter the content for this section..."></textarea>
                            </div>
                        </div>

                        <!-- Documents Fields -->
                        <div id="documentsFields" class="section-fields" style="display: none;">
                            <div class="form-group">
                                <label>Document Title:</label>
                                <input type="text" id="docItemTitle" class="form-control" placeholder="Document title">
                            </div>
                            <div class="form-group">
                                <label>Document Link:</label>
                                <input type="url" id="docItemLink" class="form-control"
                                    placeholder="https://drive.google.com/...">
                            </div>
                            <div class="form-group">
                                <label>Description:</label>
                                <textarea id="docItemDesc" class="form-control" rows="3"
                                    placeholder="Document description"></textarea>
                            </div>
                            <button type="button" class="btn btn-secondary" id="addDocumentBtn">
                                <i class="fas fa-plus"></i> Add Document
                            </button>
                            <div id="documentsList" style="margin-top: 15px;">
                                <h4>Documents to Add:</h4>
                                <div id="docItemsPreview"></div>
                            </div>
                        </div>

                        <!-- Links Fields -->
                        <div id="linksFields" class="section-fields" style="display: none;">
                            <div class="form-group">
                                <label>Link Text:</label>
                                <input type="text" id="linkText" class="form-control" placeholder="Link display text">
                            </div>
                            <div class="form-group">
                                <label>Link URL:</label>
                                <input type="url" id="linkUrl" class="form-control" placeholder="https://example.com">
                            </div>
                            <div class="form-group">
                                <label>Description (optional):</label>
                                <input type="text" id="linkDesc" class="form-control" placeholder="Brief description">
                            </div>
                            <button type="button" class="btn btn-secondary" id="addLinkBtn">
                                <i class="fas fa-plus"></i> Add Link
                            </button>
                            <div id="linksList" style="margin-top: 15px;">
                                <h4>Links to Add:</h4>
                                <div id="linkItemsPreview"></div>
                            </div>
                        </div>

                        <!-- Custom HTML Fields -->
                        <div id="customFields" class="section-fields" style="display: none;">
                            <div class="form-group">
                                <label>Custom HTML:</label>
                                <textarea id="customHTML" class="form-control" rows="8"
                                    placeholder="Enter your custom HTML here..."></textarea>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Section Order:</label>
                            <input type="number" id="sectionOrder" class="form-control" value="0" min="0">
                            <small>Lower numbers appear first. Existing sections: Hero(0), About(1), Features(2),
                                News(3), Fun Facts(4), Spotlight(5), Quiz(6)</small>
                        </div>

                        <div class="form-group">
                            <label>Background Color:</label>
                            <select id="sectionBgColor" class="form-control">
                                <option value="white">White</option>
                                <option value="#f8f9fa">Light Gray</option>
                                <option value="#004080">Dark Blue</option>
                                <option value="#e3f2fd">Light Blue</option>
                                <option value="#f3e5f5">Light Purple</option>
                                <option value="#e8f5e8">Light Green</option>
                            </select>
                        </div>

                        <button class="btn" id="createSectionBtn"
                            style="background: #28a745; border: 2px solid #1e7e34;">
                            <i class="fas fa-plus-circle"></i> Create New Section
                        </button>

                        <!-- Test Button -->
                        <button class="btn" id="testButton" style="background: #17a2b8; margin-left: 10px;">
                            <i class="fas fa-check"></i> Test Button
                        </button>
                    </div>

                    <div
                        style="background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); margin-top: 30px;">
                        <h3>Existing Custom Sections</h3>
                        <div id="existingSectionsList">
                            <p><i class="fas fa-spinner fa-spin"></i> Loading sections...</p>
                        </div>
                    </div>
                </div>
            </div>





            <!-- Practical Electronics Hub Section -->
            <div id="practicalHubSection" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-microchip"></i> Practical Electronics Hub Management</h2>
                    <button class="btn" onclick="addNewProduct()">
                        <i class="fas fa-plus"></i> Add New Product
                    </button>
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="showHubTab('products')">Products</div>
                    <div class="tab" onclick="showHubTab('orders')">Orders</div>
                    <div class="tab" onclick="showHubTab('inventory')">Inventory</div>
                    <div class="tab" onclick="showHubTab('analytics')">Analytics</div>
                </div>

                <!-- Products Tab -->
                <div id="productsHubTab" class="tab-content active">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                        <input type="text" id="productSearch" placeholder="Search products..."
                            style="flex: 1; margin-right: 10px;">
                        <select id="categoryFilterAdmin">
                            <option value="all">All Categories</option>
                            <option value="arduino">Arduino Kits</option>
                            <option value="555">mini projects Kits</option>
                            <option value="components">Components</option>
                            <option value="tools">Tools</option>
                        </select>
                    </div>

                    <div class="table-container">
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 30px;">
                                        <i class="fas fa-spinner fa-spin"></i> Loading products...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Orders Tab -->
                <div id="ordersHubTab" class="tab-content" style="display: none;">
                    <h3>Recent Orders</h3>
                    <div class="table-container">
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Products</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 30px;">
                                        No orders yet
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Order Details Modal - PLACE THIS OUTSIDE THE TABLE -->
                    <div id="orderDetailsModal" class="modal" style="display: none;">
                        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                            <span class="closeBtn" onclick="closeOrderDetailsModal()">&times;</span>
                            <h3 id="orderDetailsTitle">Order Details</h3>
                            <div id="orderDetailsContent">
                                <!-- Order details will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Editor Modal -->
                <div id="productEditorModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                        <span class="closeBtn" onclick="closeProductEditor()">&times;</span>
                        <h3 id="productModalTitle">Add New Product</h3>
                        <div id="productEditorForm">
                            <!-- Form will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Content Editor Modal - NUCLEAR OPTION -->
    <div id="editorModal"
        style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); overflow: auto;">
        <div
            style="background: white; padding: 30px; border-radius: 10px; max-width: 800px; margin: 50px auto; position: relative; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <span
                style="position: absolute; top: 15px; right: 25px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;"
                onclick="closeEditor()">&times;</span>
            <h3 id="editorTitle">Edit Content</h3>
            <textarea id="contentEditor"
                style="width: 100%; height: 400px; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 16px; resize: vertical;"></textarea>
            <div style="margin-top: 20px; text-align: right;">
                <button onclick="closeEditor()"
                    style="padding: 10px 20px; margin-right: 10px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                <button onclick="saveContent()"
                    style="padding: 10px 20px; background: #004080; color: white; border: none; border-radius: 5px; cursor: pointer;">Save
                    Changes</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <!-- Add this with your other Firebase imports -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD3oMlsv9C3Qepvkw_Y1JVfhVJiMwZLox4",
            authDomain: "bsceee-webpage.firebaseapp.com",
            databaseURL: "https://bsceee-webpage-default-rtdb.firebaseio.com",
            projectId: "bsceee-webpage",
            storageBucket: "bsceee-webpage.appspot.com",
            messagingSenderId: "281106710079",
            appId: "1:281106710079:web:2c6ab931bc3cab8e4e428a",
            measurementId: "G-B1M7SSEZYP"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const storage = firebase.storage(); // ADD THIS LINE

        // Make storage available globally (optional but helpful)
        window.firebaseStorage = storage;

        let currentEditingSection = '';
        let currentContentTab = 'homepage';

        // Check authentication
        auth.onAuthStateChanged((user) => {
            if (user) {
                // Check if user is admin
                db.ref('admins/' + user.uid).once('value').then((snapshot) => {
                    if (snapshot.exists()) {
                        const adminData = snapshot.val();
                        document.getElementById('adminName').textContent = `Welcome, ${adminData.name || 'Admin'}`;
                        loadDashboardData();
                    } else {
                        // Not admin, redirect to login
                        window.location.href = 'admin-login.html';
                    }
                });
            } else {
                // Not logged in, redirect to login
                window.location.href = 'admin-login.html';
            }
        });
        // Navigation functions
        function showSection(sectionName) {
            console.log('Showing section:', sectionName);

            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });

            // Show selected section
            const targetSection = document.getElementById(sectionName + 'Section');
            if (targetSection) {
                targetSection.style.display = 'block';
            }

            // Update current section title
            const titles = {
                'dashboard': 'Dashboard Overview',
                'content': 'Content Management',
                'registrations': 'Student Registrations',
                'complaints': 'Academic Complaints Management',
                'groups': 'Group Management',
                'pending': 'Pending Students',
                'announcements': 'Announcements Management',
                'users': 'User Management',
                'settings': 'System Settings'
            };
            document.getElementById('currentSection').textContent = titles[sectionName] || sectionName;

            // Update active nav
            document.querySelectorAll('.nav-links li').forEach(li => {
                li.classList.remove('active');
            });
            event.target.closest('li').classList.add('active');
        }

        function showContentTab(tabName) {
            console.log('Showing tab:', tabName);

            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });

            event.target.classList.add('active');
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.style.display = 'block';
            }
            currentContentTab = tabName;
        }

        // Content editing functions
        function editContent(section) {
            console.log('Editing section:', section);
            currentEditingSection = section;
            const modal = document.getElementById('editorModal');
            const editor = document.getElementById('contentEditor');
            const title = document.getElementById('editorTitle');

            if (!modal || !editor || !title) {
                console.error('Modal elements not found!');
                return;
            }

            // Set title
            const sectionTitles = {
                'hero': 'Edit Hero Section',
                'about': 'Edit About Section',
                'features': 'Edit Features Section',
                'news': 'Edit News Section',
                'funFacts': 'Edit Fun Facts',
                'spotlight': 'Edit Student Spotlight',
                'quiz': 'Edit Weekly Quiz'
            };
            title.textContent = sectionTitles[section] || 'Edit Content';

            // Load current content
            db.ref('websiteContent/' + section).once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    if (section === 'hero') {
                        editor.value = (data.title || '') + '\n---\n' + (data.subtitle || '');
                    } else if (section === 'funFacts' && data.items) {
                        editor.value = data.items.join('\n');
                    } else {
                        editor.value = data.content || '';
                    }
                } else {
                    editor.value = ''; // Empty if no data
                }

                // Show modal after content is loaded
                modal.style.display = 'block';
            }).catch(error => {
                console.error('Error loading content:', error);
                editor.value = '';
                modal.style.display = 'block';
            });
        }

        function closeEditor() {
            const modal = document.getElementById('editorModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function saveContent() {
            const editor = document.getElementById('contentEditor');
            if (!editor) {
                console.error('Editor not found!');
                return;
            }

            const newContent = editor.value;
            console.log('Saving content for:', currentEditingSection);

            let updatePromise;

            if (currentEditingSection === 'hero') {
                const lines = newContent.split('\n---\n');
                updatePromise = db.ref('websiteContent/hero').set({
                    title: lines[0] || '',
                    subtitle: lines[1] || ''
                });
            } else if (currentEditingSection === 'funFacts') {
                const facts = newContent.split('\n').filter(fact => fact.trim() !== '');
                updatePromise = db.ref('websiteContent/funFacts').set({
                    items: facts
                });
            } else {
                updatePromise = db.ref('websiteContent/' + currentEditingSection).set({
                    content: newContent
                });
            }

            updatePromise.then(() => {
                closeEditor();
                alert('‚úÖ Content updated successfully! Changes will appear on the website immediately.');
            }).catch(error => {
                console.error('Error saving content:', error);
                alert('‚ùå Error saving content: ' + error.message);
            });
        }

        // Load dashboard data
        function loadDashboardData() {
            // In loadDashboardData() function - update registration stats:
            // Load registration stats
            db.ref('registrations').once('value').then(snapshot => {
                const data = snapshot.val();
                let count = 0;

                if (data) {
                    // Count all students in nested structure
                    for (let part1 in data) {
                        const level1 = data[part1];
                        if (level1 && typeof level1 === 'object') {
                            for (let part2 in level1) {
                                const level2 = level1[part2];
                                if (level2 && typeof level2 === 'object') {
                                    for (let part3 in level2) {
                                        count++;
                                    }
                                }
                            }
                        }
                    }
                }

                document.getElementById('individualRegs').textContent = count;
                document.getElementById('totalStudents').textContent = count;
            });

            // Load group stats
            db.ref('groups').once('value').then(snapshot => {
                const data = snapshot.val();
                const count = data ? Object.keys(data).length : 0;
                document.getElementById('groupRegs').textContent = count;
                document.getElementById('totalGroups').textContent = count;
            });

            // Load pending stats
            db.ref('pending').once('value').then(snapshot => {
                const data = snapshot.val();
                let count = 0;
                if (data) {
                    // Count all pending students (handle nested structure)
                    for (let key in data) {
                        if (typeof data[key] === 'object') {
                            count += Object.keys(data[key]).length;
                        }
                    }
                }
                document.getElementById('pendingApproval').textContent = count;
                document.getElementById('pendingStudents').textContent = count;
            });
        }

        // Logout function
        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'admin-login.html';
            });
        }

        // Download functions
        function downloadRegistrations() {
            alert('üìä Export feature will be implemented soon!');
        }

        // Initialize modal close functionality
        document.addEventListener('DOMContentLoaded', function () {
            const modal = document.getElementById('editorModal');
            if (modal) {
                window.onclick = function (event) {
                    if (event.target === modal) {
                        closeEditor();
                    }
                }
            }

            // Add click listeners to action buttons for debugging
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    console.log('Action button clicked:', this.querySelector('h3').textContent);
                });
            });
        });



        // Temporary debug function - add this to your script
        function debugModal() {
            const modal = document.getElementById('editorModal');
            if (modal) {
                // Force proper styling
                modal.style.display = 'block';
                modal.style.position = 'fixed';
                modal.style.zIndex = '10000';
                modal.style.left = '0';
                modal.style.top = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
                modal.style.overflow = 'auto';

                console.log('Modal forced to show with proper styles');
            } else {
                console.log('Modal element not found');
            }
        }

        // Test it by calling debugModal() in console







        // Replace your existing editContent function with this:
        function editContent(section) {
            console.log('Editing section:', section);
            currentEditingSection = section;

            // Get modal elements
            const modal = document.getElementById('editorModal');
            const editor = document.getElementById('contentEditor');
            const title = document.getElementById('editorTitle');

            if (!modal || !editor || !title) {
                console.error('Modal elements not found!');
                return;
            }

            // Force modal styles
            modal.style.display = 'block';
            modal.style.position = 'fixed';
            modal.style.zIndex = '10000';
            modal.style.left = '0';
            modal.style.top = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
            modal.style.overflow = 'auto';

            // Set title
            const sectionTitles = {
                'hero': 'Edit Hero Section',
                'about': 'Edit About Section',
                'features': 'Edit Features Section',
                'news': 'Edit News Section',
                'funFacts': 'Edit Fun Facts',
                'spotlight': 'Edit Student Spotlight',
                'quiz': 'Edit Weekly Quiz'
            };
            title.textContent = sectionTitles[section] || 'Edit Content';

            // Load current content
            db.ref('websiteContent/' + section).once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    if (section === 'hero') {
                        editor.value = (data.title || '') + '\n---\n' + (data.subtitle || '');
                    } else if (section === 'funFacts' && data.items) {
                        editor.value = data.items.join('\n');
                    } else {
                        editor.value = data.content || '';
                    }
                } else {
                    editor.value = '';
                }
            }).catch(error => {
                console.error('Error loading content:', error);
                editor.value = '';
            });
        }


        // Debug function to check Firebase content
        function debugContent() {
            console.log('=== DEBUG: Checking Firebase Content ===');
            db.ref('websiteContent').once('value').then((snapshot) => {
                const allContent = snapshot.val();
                console.log('All website content:', allContent);

                if (allContent) {
                    for (let section in allContent) {
                        console.log(`Section "${section}":`, allContent[section]);
                    }
                } else {
                    console.log('No website content found in Firebase!');
                }
            }).catch(error => {
                console.error('Debug error:', error);
            });
        }

        // Run debug on page load
        setTimeout(debugContent, 2000);




        // Fixed function for nested registration structure
        function loadRegistrationsTable() {
            const tableBody = document.querySelector('#registrationsTable tbody');
            tableBody.innerHTML = `
        <tr>
            <td colspan="5" style="text-align: center; padding: 20px;">
                <i class="fas fa-spinner fa-spin"></i> Loading registrations...
            </td>
        </tr>
    `;

            db.ref('registrations').once('value').then(snapshot => {
                const data = snapshot.val();
                console.log('Raw registrations data:', data);

                if (!data) {
                    tableBody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 20px;">
                        No student registrations found in the database.
                    </td>
                </tr>
            `;
                    return;
                }

                const allRecords = [];

                // Process the nested structure: EB24 ‚Üí 74481 ‚Üí 24 ‚Üí data
                for (let part1 in data) { // EB24
                    const level1 = data[part1];
                    if (level1 && typeof level1 === 'object') {
                        for (let part2 in level1) { // 74481
                            const level2 = level1[part2];
                            if (level2 && typeof level2 === 'object') {
                                for (let part3 in level2) { // 24
                                    const studentData = level2[part3];
                                    if (studentData && typeof studentData === 'object') {
                                        // Build the full registration number
                                        const fullRegNo = `${part1}/${part2}/${part3}`;

                                        allRecords.push({
                                            name: studentData.name || "N/A",
                                            regNo: fullRegNo, // This will be "EB24/74481/24"
                                            phone: studentData.phone || "N/A",
                                            timestamp: studentData.timestamp || "N/A"
                                        });

                                        console.log(`Found student: ${fullRegNo}`, studentData);
                                    }
                                }
                            }
                        }
                    }
                }

                console.log('All processed records:', allRecords);

                // Sort: oldest to newest
                allRecords.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                // Clear and populate table
                tableBody.innerHTML = '';

                if (allRecords.length === 0) {
                    tableBody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 20px;">
                        No valid registration data found.
                    </td>
                </tr>
            `;
                } else {
                    allRecords.forEach((record, index) => {
                        const formattedDate = formatDate(record.timestamp);
                        const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${record.name}</td>
                        <td><strong>${record.regNo}</strong></td>
                        <td>${record.phone}</td>
                        <td>${formattedDate}</td>
                    </tr>
                `;
                        tableBody.insertAdjacentHTML("beforeend", row);
                    });
                }

            }).catch(error => {
                console.error("Error loading registrations:", error);
                tableBody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; color: red;">
                    Error loading registrations: ${error.message}
                </td>
            </tr>
        `;
            });
        }

        // Update the download function in admin dashboard
        function downloadRegistrations() {
            const tableBody = document.querySelector('#registrationsTable tbody');
            const rows = tableBody.querySelectorAll('tr');

            if (rows.length === 0 || rows[0].querySelector('td[colspan]')) {
                alert("Please load registrations first by clicking 'Load Registrations'");
                return;
            }

            alert("Export feature will be implemented soon! For now, use the separate registration viewer page.");
        }

        // ... all your existing JavaScript code ...

        // Add this at the very end, before the closing tag
        function formatDate(timestamp) {
            if (!timestamp || timestamp === 'N/A') return 'N/A';
            try {
                const date = new Date(timestamp);
                return date.toLocaleString();
            } catch (e) {
                return timestamp;
            }
        }










        // ===== STUDY DOCUMENTS FUNCTIONS =====
        function addStudyDocument() {
            const semester = document.getElementById('semesterSelect').value;
            const course = document.getElementById('courseSelect').value;
            const docType = document.getElementById('docTypeSelect').value;
            const title = document.getElementById('docTitle').value;
            const driveLink = document.getElementById('driveLink').value;

            // Get custom inputs if "other" is selected
            const customSemester = document.getElementById('customSemester').value;
            const customCourse = document.getElementById('customCourse').value;

            if (!title || !driveLink) {
                alert('Please fill in both document title and Google Drive link');
                return;
            }

            // Use custom values if provided, otherwise use dropdown values
            const finalSemester = semester === 'other' ? customSemester.toLowerCase().replace(/\s+/g, '') : semester;
            const finalCourse = course === 'other' ? customCourse.toUpperCase().replace(/\s+/g, '') : course;

            if (!finalSemester) {
                alert('Please enter a semester name');
                return;
            }

            if (!finalCourse) {
                alert('Please enter a course code');
                return;
            }

            const docData = {
                title: title,
                type: docType,
                driveLink: driveLink,
                timestamp: new Date().toISOString(),
                addedBy: auth.currentUser.uid
            };

            const docId = Date.now().toString();
            const docPath = `studyDocuments/${finalSemester}/${finalCourse}/${docId}`;

            db.ref(docPath).set(docData)
                .then(() => {
                    alert('‚úÖ Document added successfully!');
                    clearStudyDocForm();
                    loadExistingStudyDocs();
                })
                .catch(error => {
                    console.error('Error adding document:', error);
                    alert('‚ùå Error adding document: ' + error.message);
                });
        }

        function toggleCustomInputs() {
            const semesterSelect = document.getElementById('semesterSelect').value;
            const courseSelect = document.getElementById('courseSelect').value;

            // Show/hide custom semester input
            if (semesterSelect === 'other') {
                document.getElementById('customSemesterGroup').style.display = 'block';
            } else {
                document.getElementById('customSemesterGroup').style.display = 'none';
                document.getElementById('customSemester').value = '';
            }

            // Show/hide custom course input
            if (courseSelect === 'other') {
                document.getElementById('customCourseGroup').style.display = 'block';
            } else {
                document.getElementById('customCourseGroup').style.display = 'none';
                document.getElementById('customCourse').value = '';
            }
        }

        function clearStudyDocForm() {
            // Safe clearing with null checks
            const elements = {
                'docTitle': '',
                'driveLink': '',
                'customSemester': '',
                'customCourse': ''
            };

            for (const [id, value] of Object.entries(elements)) {
                const element = document.getElementById(id);
                if (element) {
                    element.value = value;
                }
            }

            // Hide custom input groups
            const customSemesterGroup = document.getElementById('customSemesterGroup');
            const customCourseGroup = document.getElementById('customCourseGroup');
            if (customSemesterGroup) customSemesterGroup.style.display = 'none';
            if (customCourseGroup) customCourseGroup.style.display = 'none';

            // Reset dropdowns to default
            const semesterSelect = document.getElementById('semesterSelect');
            const courseSelect = document.getElementById('courseSelect');
            const docTypeSelect = document.getElementById('docTypeSelect');
            if (semesterSelect) semesterSelect.value = 'year1sem1';
            if (courseSelect) courseSelect.value = 'EENG111';
            if (docTypeSelect) docTypeSelect.value = 'exam';
        }
        // The loadExistingStudyDocs and deleteStudyDoc functions remain the same
        function loadExistingStudyDocs() {
            const container = document.getElementById('existingDocsList');
            container.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Loading documents...</p>';

            console.log('Loading existing study docs...');

            db.ref('studyDocuments').once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    console.log('Raw Firebase data:', data);

                    if (!data) {
                        container.innerHTML = '<p>No documents found in the database.</p>';
                        return;
                    }

                    let html = '<table style="width: 100%; border: 1px solid #ddd;"><thead><tr style="background: #f8f9fa;"><th>Semester</th><th>Course</th><th>Title</th><th>Type</th><th>Actions</th></tr></thead><tbody>';

                    let docCount = 0;

                    for (const semester in data) {
                        if (data.hasOwnProperty(semester)) {
                            for (const course in data[semester]) {
                                if (data[semester].hasOwnProperty(course)) {
                                    for (const docId in data[semester][course]) {
                                        if (data[semester][course].hasOwnProperty(docId)) {
                                            const doc = data[semester][course][docId];
                                            const semesterDisplay = getSemesterDisplayName(semester);
                                            html += `
                                        <tr>
                                            <td><strong>${semesterDisplay}</strong></td>
                                            <td><code>${course}</code></td>
                                            <td>${doc.title}</td>
                                            <td><span style="background: #e9ecef; padding: 2px 6px; border-radius: 4px; font-size: 0.8em;">${doc.type}</span></td>
                                            <td>
                                                <button onclick="deleteStudyDoc('${semester}', '${course}', '${docId}')" class="btn btn-secondary" style="padding: 5px 10px; margin: 2px; background: #dc3545;">Delete</button>
                                            </td>
                                        </tr>
                                    `;
                                            docCount++;
                                        }
                                    }
                                }
                            }
                        }
                    }

                    if (docCount === 0) {
                        html = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No documents found in the database structure.</td></tr>';
                    }

                    html += '</tbody></table>';
                    html += `<p style="margin-top: 10px; color: #666;">Total documents: ${docCount}</p>`;

                    container.innerHTML = html;
                    console.log(`Displayed ${docCount} documents`);
                })
                .catch(error => {
                    console.error('Error loading documents:', error);
                    container.innerHTML = `<p style="color: red;">Error loading documents: ${error.message}</p>`;
                });
        }

        function deleteStudyDoc(semester, course, docId) {
            if (confirm('Are you sure you want to delete this document?')) {
                const docPath = `studyDocuments/${semester}/${course}/${docId}`;
                db.ref(docPath).remove()
                    .then(() => {
                        alert('‚úÖ Document deleted successfully!');
                        loadExistingStudyDocs();
                    })
                    .catch(error => {
                        console.error('Error deleting document:', error);
                        alert('‚ùå Error deleting document: ' + error.message);
                    });
            }
        }

        function getSemesterDisplayName(semesterKey) {
            const names = {
                'year1sem1': 'Year 1 Semester 1',
                'year1sem2': 'Year 1 Semester 2',
                'year2sem1': 'Year 2 Semester 1',
                'year2sem2': 'Year 2 Semester 2'
            };
            return names[semesterKey] || semesterKey; // Return custom name if not in predefined list
        }



















        // ===== MIGRATION SCRIPT - Run this once to import existing documents =====
        function migrateExistingDocuments() {
            if (!confirm('This will import all your existing study documents to Firebase. Continue?')) {
                return;
            }

            const documentsToImport = [
                // Year 1 Semester 1
                { semester: 'year1sem1', course: 'EENG111', type: 'exam', title: 'EXAM 2024/2025', link: 'https://drive.google.com/file/d/1QJrQWIMP0tYOBlEj5mR-ZG5GF8VYI90J/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'EENG112', type: 'exam', title: 'EXAM 2024/2025', link: 'https://drive.google.com/file/d/1REVn1DN97hDvPnzcKDN22uQJ5PYfN6tt/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'CHEM110', type: 'exam', title: 'EXAM 2024/2025', link: 'https://drive.google.com/file/d/1fp06-1XxW6lnmNCqa3Y6a_FuHKBZCvz6/view?usp=sharing' },
                { semester: 'year1sem1', course: 'CHEM110', type: 'cat', title: 'CAT', link: 'https://drive.google.com/file/d/1JUJqYgeMvOI1ReZ6JPkkHY4WDQwWHFN0/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'PHYS112', type: 'exam', title: 'EXAM 2024/2025', link: 'https://drive.google.com/file/d/1qsEaTDzqfQ5TvBlTPlxUEAhzUt7lWEwM/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'PHYS112', type: 'cat', title: 'CAT', link: 'https://drive.google.com/file/d/1URzodwdwE4CjeSYMOwHjiyo0Vv8mr72l/view?usp=sharing' },
                { semester: 'year1sem1', course: 'PHYS121', type: 'exam', title: 'EXAM 2024/2025', link: 'https://drive.google.com/file/d/1fyTMWRu75SQ216SeDkwB_jDOHTmXQORv/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'COSC121', type: 'exam', title: 'EXAM 2024/2025', link: 'https://drive.google.com/file/d/1LwUcdnsYAOPGwHyqDu1O6A0Et060vR0p/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'COSC121', type: 'cat', title: 'CAT', link: 'https://drive.google.com/file/d/1EodLFtCVemhQEJuSYsAS_PobhXL83Z63/view?usp=sharing' },
                { semester: 'year1sem1', course: 'COMS101', type: 'exam', title: 'EXAM 2024/2025', link: 'https://drive.google.com/file/d/1d6JODYtjigXzJyWHY-B9U_4yLHAtBzTW/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'MATH121', type: 'exam', title: 'EXAM 2024/2025', link: 'https://drive.google.com/file/d/17YZyEANfHkp1uPip2WvO1nxav5p2RGhe/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'MATH122', type: 'exam', title: 'EXAM 2024/2025', link: 'https://drive.google.com/file/d/1bSlw1vuTFhaUnA2yIbjziRXuHM6bIAZW/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'MATH122', type: 'notes', title: 'CHAP 1 NOTES', link: 'https://drive.google.com/file/d/1BhJoyTRkHPeUGFrUBCRxyx0rgRzrRVMB/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'MATH122', type: 'notes', title: 'CHAP 2 NOTES', link: 'https://drive.google.com/file/d/1QkCuGOFlmfAFelN-1ckMBzZDLgzjf3eO/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'MATH122', type: 'notes', title: 'CHAP 3 NOTES', link: 'https://drive.google.com/file/d/1uWeEfdP9Ev3jESKbxt4_O0dvakAoQeGa/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'MATH122', type: 'notes', title: 'CHAP 4 NOTES', link: 'https://drive.google.com/file/d/1H7DEENUgyZyskHQ6If-HFIp_DnDR-tCY/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'MATH122', type: 'notes', title: 'CHAP 5 NOTES', link: 'https://drive.google.com/file/d/1zFcfJUePpwZZ_voLvixtPtNq_9lt0CWl/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'MATH122', type: 'notes', title: 'CHAP 6 NOTES', link: 'https://drive.google.com/file/d/14UhDKvI4nO_rlmuU5RbjnjsCBoZtpKCQ/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'MATH122', type: 'notes', title: 'CHAP 7 NOTES', link: 'https://drive.google.com/file/d/1RL47la967qSHTI5_-CvVxC5g9VkoV_jf/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'MATH122', type: 'cat', title: 'CAT 2024/2025', link: 'https://drive.google.com/file/d/1VGJo6lRoj0otq4lzqnjMmld14U8FG8kl/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'MATH124', type: 'exam', title: 'EXAM 2024/2025', link: 'https://drive.google.com/file/d/1Ibov9ufvy5KrigiOldchXJs-Lzw3CPLJ/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'ZOOL143', type: 'cat', title: 'CAT', link: 'https://drive.google.com/file/d/17nv0oDRoVP8N6efXYRgKe0bNj5QHyujk/view?usp=sharing' },

                // Year 1 Semester 2
                { semester: 'year1sem2', course: 'EENG113', type: 'exam', title: 'EXAM 2024-2025', link: 'https://drive.google.com/file/d/1kgGwJgY2eNEVE5IMZ4EwPkdxNj2CzssT/view?usp=drive_link' },
                { semester: 'year1sem2', course: 'EENG113', type: 'cat', title: 'CAT', link: 'https://drive.google.com/file/d/1HFQhF9Exn5npidFUZgtdayvXDWUX0GU3/view?usp=sharing' },
                { semester: 'year1sem2', course: 'EENG114', type: 'exam', title: 'EXAM 2024-2025', link: 'https://drive.google.com/file/d/1a6nKh_J9l6J1bJVhjEM8Rdxu_dbyA5J2/view?usp=sharing' },
                { semester: 'year1sem2', course: 'EENG114', type: 'cat', title: 'CAT', link: 'https://drive.google.com/file/d/1IErq7xdcjIZfdoVgPh1covpJjqVY4g04/view?usp=drive_link' },
                { semester: 'year1sem2', course: 'PHYS113', type: 'exam', title: 'EXAM 2024-2025', link: 'https://drive.google.com/file/d/1LgO9Fhl_BuixQiNKKfFKVL5rT2VJA4AL/view?usp=drive_link' },
                { semester: 'year1sem2', course: 'PHYS113', type: 'cat', title: 'CAT', link: 'https://drive.google.com/file/d/16CWddnqdNfkhLNYi5OZI_IBf3AHNeuh3/view?usp=sharing' },
                { semester: 'year1sem2', course: 'PHYS122', type: 'exam', title: 'EXAM 2024-2025', link: 'https://drive.google.com/file/d/1Ya1L2CghH4Jf1w3ehxSafjMM3lzku9Iy/view?usp=drive_link' },
                { semester: 'year1sem2', course: 'COSC113', type: 'exam', title: 'EXAM 2024-2025', link: 'https://drive.google.com/file/d/1_h59cXbB-K-afahzdI5VDhpyy2XlChQe/view?usp=drive_link' },
                { semester: 'year1sem2', course: 'PHIL100', type: 'exam', title: 'EXAM 2024-2025', link: 'https://drive.google.com/file/d/1iZ69dZ0wnhtUdP90VTUBxvi0PsLml7ll/view?usp=drive_link' },
                { semester: 'year1sem2', course: 'MATH141', type: 'exam', title: 'EXAM 2024-2025', link: 'https://drive.google.com/file/d/10KyKkv0UaOvHvZvN8BhVVqmf8KQ18-rn/view?usp=drive_link' },
                { semester: 'year1sem2', course: 'CHEM120', type: 'cat', title: 'CAT', link: 'https://drive.google.com/file/d/15T3mxCIR3mExDqdQxQa4v2OCfqwFFzQ0/view?usp=drive_link' },

                // Year 2 Semester 1
                { semester: 'year2sem1', course: 'EENG291', type: 'notes', title: 'EENG 291 COURSE CONTENT', link: 'https://docs.google.com/document/d/1TTsZoSWrREe2Y7zFcAu2xFpCpRP9XGLP/edit?usp=drive_link&ouid=113351626153168999137&rtpof=true&sd=true' },
                { semester: 'year2sem1', course: 'EENG291', type: 'notes', title: 'WEEK 2 NOTES', link: 'https://drive.google.com/file/d/1Tfy591E54GbKw9RQ0J32ctvHOVkem968/view?usp=drive_link' },
                { semester: 'year2sem1', course: 'EENG291', type: 'notes', title: 'WEEK 3 NOTES', link: 'https://docs.google.com/document/d/11a9GuxEp87PKa78rxm1CIbShivSzIm_z/edit?usp=sharing&ouid=113351626153168999137&rtpof=true&sd=true' },
                { semester: 'year2sem1', course: 'EENG291', type: 'notes', title: 'WEEK 4 NOTES', link: 'https://drive.google.com/file/d/1MZj-kISNohgTgMZDtQBnOZBet-cLbvGp/view?usp=sharing' },
                { semester: 'year2sem1', course: 'EENG291', type: 'notes', title: 'WEEK 4B NOTES', link: 'https://docs.google.com/document/d/13etf-COBHqmz95Z-0ZhXMbjpfnTl56UW/edit?usp=sharing&ouid=113351626153168999137&rtpof=true&sd=true' },
                { semester: 'year2sem1', course: 'EENG271', type: 'notes', title: 'EENG 271 COURSE CONTENT', link: 'https://drive.google.com/file/d/1-t-xpkjPISKrqhpFJRhNtzKKlKptoFUt/view?usp=drive_link' },
                { semester: 'year2sem1', course: 'EENG271', type: 'notes', title: 'WEEK 2 NOTES', link: 'https://drive.google.com/file/d/1HkpEjb4K-KyDs5KMQq6P5SJ0LBqwNxj_/view?usp=sharing' },
                { semester: 'year2sem1', course: 'EENG271', type: 'notes', title: 'WEEK 3 NOTES', link: 'https://docs.google.com/document/d/110nFOfuHm2mUQ3kcQpi_Ollm46lNBFGt/edit?usp=sharing&ouid=113351626153168999137&rtpof=true&sd=true' },
                { semester: 'year2sem1', course: 'EENG271', type: 'notes', title: 'WEEK 4 NOTES', link: 'https://docs.google.com/document/d/1Gss-R3n_7yfQf_zq3bbKI0vwymRtdK-Y/edit?usp=sharing&ouid=113351626153168999137&rtpof=true&sd=true' }
            ];

            let importedCount = 0;
            const totalCount = documentsToImport.length;

            documentsToImport.forEach((doc, index) => {
                const docData = {
                    title: doc.title,
                    type: doc.type,
                    driveLink: doc.link,
                    timestamp: new Date().toISOString(),
                    addedBy: auth.currentUser.uid
                };

                const docId = Date.now().toString() + index; // Unique ID for each doc
                const docPath = `studyDocuments/${doc.semester}/${doc.course}/${docId}`;

                db.ref(docPath).set(docData)
                    .then(() => {
                        importedCount++;
                        console.log(`Imported: ${doc.course} - ${doc.title}`);

                        if (importedCount === totalCount) {
                            alert(`‚úÖ Successfully imported ${importedCount} documents to Firebase!`);
                            loadExistingStudyDocs();
                        }
                    })
                    .catch(error => {
                        console.error(`Error importing ${doc.course} - ${doc.title}:`, error);
                        importedCount++;
                    });
            });
        }



        function showContentTab(tabName) {
            console.log('Showing tab:', tabName);

            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });

            event.target.classList.add('active');
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.style.display = 'block';
            }
            currentContentTab = tabName;

            // ADD THIS LINE - Load study docs when tab is opened
            if (tabName === 'studydocs') {
                loadExistingStudyDocs();
            }
        }





        // Timetable Management Functions
        let currentTimetableTab = 'regular';

        function showTimetableTab(tabName) {
            currentTimetableTab = tabName;

            // Update tabs
            document.querySelectorAll('#timetableTab .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#timetableTab .tab-content').forEach(content => {
                content.style.display = 'none';
            });

            event.target.classList.add('active');
            document.getElementById(tabName + 'TimetableTab').style.display = 'block';
        }

        function loadTimetableData() {
            console.log('Loading timetable data...');

            // Load regular timetable
            db.ref('timetable/regular').once('value').then(snapshot => {
                const data = snapshot.val();
                if (data) {
                    document.getElementById('regularPeriod').value = data.period || '';
                    populateRegularTimetable(data.schedule);
                } else {
                    initializeRegularTimetable();
                }
            });

            // Load exam timetable
            db.ref('timetable/exam').once('value').then(snapshot => {
                const data = snapshot.val();
                if (data) {
                    document.getElementById('examPeriod').value = data.period || '';
                    populateExamTimetable(data.schedule);
                } else {
                    initializeExamTimetable();
                }
            });
        }

        function initializeRegularTimetable() {
            const timeSlots = [
                '7:00 AM - 10:00 AM',
                '10:00 AM - 1:00 PM',
                '1:00 PM - 4:00 PM',
                '4:00 PM - 7:00 PM'
            ];

            const timetableBody = document.getElementById('regularTimetableBody');
            timetableBody.innerHTML = '';

            timeSlots.forEach(time => {
                const row = document.createElement('tr');
                row.innerHTML = `
            <td class="time-slot">${time}</td>
            <td><textarea placeholder="Unit code, venue..."></textarea></td>
            <td><textarea placeholder="Unit code, venue..."></textarea></td>
            <td><textarea placeholder="Unit code, venue..."></textarea></td>
            <td><textarea placeholder="Unit code, venue..."></textarea></td>
            <td><textarea placeholder="Unit code, venue..."></textarea></td>
        `;
                timetableBody.appendChild(row);
            });
        }
        function populateRegularTimetable(schedule) {
            if (!schedule || !Array.isArray(schedule)) {
                initializeRegularTimetable();
                return;
            }

            const timetableBody = document.getElementById('regularTimetableBody');
            timetableBody.innerHTML = '';

            // Sort the schedule array to ensure correct order (in case it gets messed up)
            const sortedSchedule = [...schedule].sort((a, b) => {
                const timeOrder = {
                    '7:00 AM - 10:00 AM': 1,
                    '10:00 AM - 1:00 PM': 2,
                    '1:00 PM - 4:00 PM': 3,
                    '4:00 PM - 7:00 PM': 4
                };
                return (timeOrder[a.timeSlot] || 0) - (timeOrder[b.timeSlot] || 0);
            });

            sortedSchedule.forEach((dayData, index) => {
                const row = document.createElement('tr');

                row.innerHTML = `
            <td class="time-slot">${dayData.timeSlot || getDefaultTimeSlot(index)}</td>
            <td><textarea>${dayData.Monday || ''}</textarea></td>
            <td><textarea>${dayData.Tuesday || ''}</textarea></td>
            <td><textarea>${dayData.Wednesday || ''}</textarea></td>
            <td><textarea>${dayData.Thursday || ''}</textarea></td>
            <td><textarea>${dayData.Friday || ''}</textarea></td>
        `;

                timetableBody.appendChild(row);
            });
        }

        function getDefaultTimeSlot(index) {
            const defaultSlots = [
                '7:00 AM - 10:00 AM',
                '10:00 AM - 1:00 PM',
                '1:00 PM - 4:00 PM',
                '4:00 PM - 7:00 PM'
            ];
            return defaultSlots[index] || '';
        }
        function initializeExamTimetable() {
            const examBody = document.getElementById('examTimetableBody');
            examBody.innerHTML = `
        <tr>
            <td><input type="date" placeholder="Date"></td>
            <td><input type="text" placeholder="e.g., 8:00 AM - 11:00 AM"></td>
            <td><input type="text" placeholder="Unit code"></td>
            <td><input type="text" placeholder="Unit name"></td>
            <td><input type="text" placeholder="Venue"></td>
            <td><button type="button" class="delete-row" onclick="deleteExamRow(this)">√ó</button></td>
        </tr>
    `;
        }

        function populateExamTimetable(schedule) {
            const examBody = document.getElementById('examTimetableBody');
            examBody.innerHTML = '';

            if (!schedule || Object.keys(schedule).length === 0) {
                initializeExamTimetable();
                return;
            }

            Object.keys(schedule).forEach(examId => {
                const exam = schedule[examId];
                const row = document.createElement('tr');

                row.innerHTML = `
            <td><input type="date" value="${exam.date || ''}"></td>
            <td><input type="text" value="${exam.time || ''}" placeholder="e.g., 8:00 AM - 11:00 AM"></td>
            <td><input type="text" value="${exam.unitCode || ''}" placeholder="Unit code"></td>
            <td><input type="text" value="${exam.unitName || ''}" placeholder="Unit name"></td>
            <td><input type="text" value="${exam.venue || ''}" placeholder="Venue"></td>
            <td><button type="button" class="delete-row" onclick="deleteExamRow(this)">√ó</button></td>
        `;

                examBody.appendChild(row);
            });
        }

        function addExamRow() {
            const examBody = document.getElementById('examTimetableBody');
            const newRow = document.createElement('tr');

            newRow.innerHTML = `
        <td><input type="date"></td>
        <td><input type="text" placeholder="e.g., 8:00 AM - 11:00 AM"></td>
        <td><input type="text" placeholder="Unit code"></td>
        <td><input type="text" placeholder="Unit name"></td>
        <td><input type="text" placeholder="Venue"></td>
        <td><button type="button" class="delete-row" onclick="deleteExamRow(this)">√ó</button></td>
    `;

            examBody.appendChild(newRow);
        }

        function deleteExamRow(button) {
            if (document.querySelectorAll('#examTimetableBody tr').length > 1) {
                button.closest('tr').remove();
            } else {
                alert('Cannot delete the last row. At least one exam entry is required.');
            }
        }

        function saveTimetableData() {
            // Save regular timetable
            const regularPeriod = document.getElementById('regularPeriod').value;
            const regularRows = document.querySelectorAll('#regularTimetableBody tr');

            // Use array to maintain order
            const regularSchedule = [
                '7:00 AM - 10:00 AM',
                '10:00 AM - 1:00 PM',
                '1:00 PM - 4:00 PM',
                '4:00 PM - 7:00 PM'
            ].map((timeSlot, index) => {
                const cells = regularRows[index].querySelectorAll('textarea');
                return {
                    timeSlot: timeSlot,
                    Monday: cells[0].value,
                    Tuesday: cells[1].value,
                    Wednesday: cells[2].value,
                    Thursday: cells[3].value,
                    Friday: cells[4].value
                };
            });

            // Save exam timetable (this can remain as object since order doesn't matter as much)
            const examPeriod = document.getElementById('examPeriod').value;
            const examRows = document.querySelectorAll('#examTimetableBody tr');
            const examSchedule = {};

            examRows.forEach((row, index) => {
                const inputs = row.querySelectorAll('input');
                examSchedule[`exam_${index}`] = {
                    date: inputs[0].value,
                    time: inputs[1].value,
                    unitCode: inputs[2].value,
                    unitName: inputs[3].value,
                    venue: inputs[4].value
                };
            });

            // Save to Firebase
            const updates = {
                'timetable/regular': {
                    period: regularPeriod,
                    schedule: regularSchedule  // Now this is an array, not an object
                },
                'timetable/exam': {
                    period: examPeriod,
                    schedule: examSchedule
                }
            };

            db.ref().update(updates)
                .then(() => {
                    alert('‚úÖ Timetable saved successfully!');
                })
                .catch(error => {
                    console.error('Error saving timetable:', error);
                    alert('‚ùå Error saving timetable: ' + error.message);
                });
        }

        // Load timetable data when the tab is opened
        function showContentTab(tabName) {
            console.log('Showing tab:', tabName);

            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });

            event.target.classList.add('active');
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.style.display = 'block';
            }
            currentContentTab = tabName;

            // Load data when specific tabs are opened
            if (tabName === 'studydocs') {
                loadExistingStudyDocs();
            }
            if (tabName === 'timetable') {
                loadTimetableData();
            }
        }





        // Personnel Management Functions
        let currentPersonnelSubTab = 'classLeadership';

        function showPersonnelSubTab(tabName) {
            currentPersonnelSubTab = tabName;

            // Update tabs
            document.querySelectorAll('#personnelTab .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#personnelTab .tab-content').forEach(content => {
                content.style.display = 'none';
            });

            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').style.display = 'block';

            // Load data for the selected tab
            if (tabName === 'lecturers') {
                loadLecturers();
            } else {
                loadPersonnelData(tabName);
            }
        }

        function loadPersonnelData(section) {
            const bodyId = section + 'Body';
            const tableBody = document.getElementById(bodyId);

            tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';

            db.ref('personnel/' + section).once('value').then(snapshot => {
                const data = snapshot.val();
                tableBody.innerHTML = '';

                if (!data) {
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No data found. Add new entries using the button above.</td></tr>';
                    return;
                }

                Object.keys(data).forEach(key => {
                    const person = data[key];
                    const row = document.createElement('tr');

                    if (section === 'lecturers') {
                        row.innerHTML = `
                    <td><input type="text" value="${person.course || ''}" class="personnel-input" data-field="course"></td>
                    <td><input type="text" value="${person.name || ''}" class="personnel-input" data-field="name"></td>
                    <td><input type="text" value="${person.phone || ''}" class="personnel-input" data-field="phone"></td>
                    <td>
                        <button class="btn" onclick="savePersonnelRow('${section}', '${key}', this)">Save</button>
                        <button class="btn btn-secondary" onclick="deletePersonnelRow('${section}', '${key}')">Delete</button>
                    </td>
                `;
                    } else {
                        row.innerHTML = `
                    <td><input type="text" value="${person.position || ''}" class="personnel-input" data-field="position"></td>
                    <td><input type="text" value="${person.name || ''}" class="personnel-input" data-field="name"></td>
                    <td><input type="text" value="${person.phone || ''}" class="personnel-input" data-field="phone"></td>
                    <td><textarea class="personnel-input" data-field="role" style="width: 100%; height: 60px; resize: vertical;">${person.role || ''}</textarea></td>
                    <td>
                        <button class="btn" onclick="savePersonnelRow('${section}', '${key}', this)">Save</button>
                        <button class="btn btn-secondary" onclick="deletePersonnelRow('${section}', '${key}')">Delete</button>
                    </td>
                `;
                    }

                    tableBody.appendChild(row);
                });
            }).catch(error => {
                console.error('Error loading personnel data:', error);
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">Error loading data</td></tr>';
            });
        }

        function loadLecturers() {
            const semester = document.getElementById('lecturerSemester').value;
            const tableBody = document.getElementById('lecturersBody');

            tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Loading lecturers...</td></tr>';

            db.ref('personnel/lecturers/' + semester).once('value').then(snapshot => {
                const data = snapshot.val();
                tableBody.innerHTML = '';

                if (!data) {
                    tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">No lecturers found for this semester.</td></tr>';
                    return;
                }

                Object.keys(data).forEach(key => {
                    const lecturer = data[key];
                    const row = document.createElement('tr');

                    row.innerHTML = `
                <td><input type="text" value="${lecturer.course || ''}" class="personnel-input" data-field="course"></td>
                <td><input type="text" value="${lecturer.name || ''}" class="personnel-input" data-field="name"></td>
                <td><input type="text" value="${lecturer.phone || ''}" class="personnel-input" data-field="phone"></td>
                <td>
                    <button class="btn" onclick="saveLecturerRow('${semester}', '${key}', this)">Save</button>
                    <button class="btn btn-secondary" onclick="deleteLecturerRow('${semester}', '${key}')">Delete</button>
                </td>
            `;

                    tableBody.appendChild(row);
                });
            }).catch(error => {
                console.error('Error loading lecturers:', error);
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: red;">Error loading lecturers</td></tr>';
            });
        }

        function addPersonnelRow(section) {
            const tableBody = document.getElementById(section + 'Body');
            const newId = 'new_' + Date.now();

            let row;
            if (section === 'lecturers') {
                row = document.createElement('tr');
                row.innerHTML = `
            <td><input type="text" placeholder="Course code" class="personnel-input" data-field="course"></td>
            <td><input type="text" placeholder="Lecturer name" class="personnel-input" data-field="name"></td>
            <td><input type="text" placeholder="Phone number" class="personnel-input" data-field="phone"></td>
            <td>
                <button class="btn" onclick="savePersonnelRow('${section}', '${newId}', this)">Save</button>
                <button class="btn btn-secondary" onclick="this.closest('tr').remove()">Cancel</button>
            </td>
        `;
            } else {
                row = document.createElement('tr');
                row.innerHTML = `
            <td><input type="text" placeholder="Position" class="personnel-input" data-field="position"></td>
            <td><input type="text" placeholder="Name" class="personnel-input" data-field="name"></td>
            <td><input type="text" placeholder="Phone" class="personnel-input" data-field="phone"></td>
            <td><textarea placeholder="Role description" class="personnel-input" data-field="role" style="width: 100%; height: 60px; resize: vertical;"></textarea></td>
            <td>
                <button class="btn" onclick="savePersonnelRow('${section}', '${newId}', this)">Save</button>
                <button class="btn btn-secondary" onclick="this.closest('tr').remove()">Cancel</button>
            </td>
        `;
            }

            tableBody.appendChild(row);
        }

        function addLecturerRow() {
            const semester = document.getElementById('lecturerSemester').value;
            const tableBody = document.getElementById('lecturersBody');
            const newId = 'new_' + Date.now();

            const row = document.createElement('tr');
            row.innerHTML = `
        <td><input type="text" placeholder="Course code" class="personnel-input" data-field="course"></td>
        <td><input type="text" placeholder="Lecturer name" class="personnel-input" data-field="name"></td>
        <td><input type="text" placeholder="Phone number" class="personnel-input" data-field="phone"></td>
        <td>
            <button class="btn" onclick="saveLecturerRow('${semester}', '${newId}', this)">Save</button>
            <button class="btn btn-secondary" onclick="this.closest('tr').remove()">Cancel</button>
        </td>
    `;

            tableBody.appendChild(row);
        }

        function savePersonnelRow(section, key, button) {
            const row = button.closest('tr');
            const inputs = row.querySelectorAll('.personnel-input');

            const data = {};
            inputs.forEach(input => {
                data[input.getAttribute('data-field')] = input.value;
            });

            db.ref('personnel/' + section + '/' + key).set(data)
                .then(() => {
                    alert('‚úÖ Saved successfully!');
                    loadPersonnelData(section);
                })
                .catch(error => {
                    console.error('Error saving personnel data:', error);
                    alert('‚ùå Error saving data: ' + error.message);
                });
        }

        function saveLecturerRow(semester, key, button) {
            const row = button.closest('tr');
            const inputs = row.querySelectorAll('.personnel-input');

            const data = {};
            inputs.forEach(input => {
                data[input.getAttribute('data-field')] = input.value;
            });

            db.ref('personnel/lecturers/' + semester + '/' + key).set(data)
                .then(() => {
                    alert('‚úÖ Lecturer saved successfully!');
                    loadLecturers();
                })
                .catch(error => {
                    console.error('Error saving lecturer:', error);
                    alert('‚ùå Error saving lecturer: ' + error.message);
                });
        }

        function deletePersonnelRow(section, key) {
            if (confirm('Are you sure you want to delete this entry?')) {
                db.ref('personnel/' + section + '/' + key).remove()
                    .then(() => {
                        alert('‚úÖ Entry deleted successfully!');
                        loadPersonnelData(section);
                    })
                    .catch(error => {
                        console.error('Error deleting entry:', error);
                        alert('‚ùå Error deleting entry: ' + error.message);
                    });
            }
        }

        function deleteLecturerRow(semester, key) {
            if (confirm('Are you sure you want to delete this lecturer?')) {
                db.ref('personnel/lecturers/' + semester + '/' + key).remove()
                    .then(() => {
                        alert('‚úÖ Lecturer deleted successfully!');
                        loadLecturers();
                    })
                    .catch(error => {
                        console.error('Error deleting lecturer:', error);
                        alert('‚ùå Error deleting lecturer: ' + error.message);
                    });
            }
        }

        // Update the showContentTab function to load personnel data
        function showContentTab(tabName) {
            console.log('Showing tab:', tabName);

            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });

            event.target.classList.add('active');
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.style.display = 'block';
            }
            currentContentTab = tabName;

            // Load data when specific tabs are opened
            if (tabName === 'studydocs') {
                loadExistingStudyDocs();
            }
            if (tabName === 'timetable') {
                loadTimetableData();
            }
            if (tabName === 'personnel') {
                loadPersonnelData('classLeadership');
            }
        }








        // ===== SECTION CREATOR - COMPLETE NEW VERSION =====

        // Section Creator Variables
        let documentItems = [];
        let linkItems = [];

        // Initialize section creator
        function initSectionCreator() {
            console.log('üöÄ Initializing section creator...');

            // Set up event listeners
            setupEventListeners();

            // Initialize form fields
            toggleSectionFields();
            updatePreviews();

            // Load existing sections
            loadExistingSections();

            console.log('‚úÖ Section creator initialized successfully');
        }

        // Set up all event listeners
        function setupEventListeners() {
            console.log('üîß Setting up event listeners...');

            // Section type change
            const sectionTypeSelect = document.getElementById('sectionType');
            if (sectionTypeSelect) {
                sectionTypeSelect.addEventListener('change', toggleSectionFields);
                console.log('‚úÖ Section type listener added');
            }

            // Create section button
            const createBtn = document.getElementById('createSectionBtn');
            if (createBtn) {
                createBtn.addEventListener('click', handleCreateSection);
                console.log('‚úÖ Create section button listener added');
            }

            // Test button
            const testBtn = document.getElementById('testButton');
            if (testBtn) {
                testBtn.addEventListener('click', handleTestButton);
                console.log('‚úÖ Test button listener added');
            }

            // Add document button
            const addDocBtn = document.getElementById('addDocumentBtn');
            if (addDocBtn) {
                addDocBtn.addEventListener('click', addDocumentItem);
                console.log('‚úÖ Add document button listener added');
            }

            // Add link button
            const addLinkBtn = document.getElementById('addLinkBtn');
            if (addLinkBtn) {
                addLinkBtn.addEventListener('click', addLinkItem);
                console.log('‚úÖ Add link button listener added');
            }

            console.log('üéØ All event listeners setup complete');
        }

        // Handle create section button click
        function handleCreateSection(event) {
            event.preventDefault();
            console.log('üéØ Create section button clicked!');
            createNewSection();
        }

        // Handle test button click
        function handleTestButton(event) {
            event.preventDefault();
            console.log('üß™ Test button clicked!');
            alert('‚úÖ Test button is working! Section creator is ready.');
        }

        // Toggle form fields based on section type
        function toggleSectionFields() {
            const sectionType = document.getElementById('sectionType').value;
            console.log('üîÑ Toggling fields for:', sectionType);

            // Hide all fields
            const allFields = ['text', 'documents', 'links', 'custom'];
            allFields.forEach(type => {
                const field = document.getElementById(type + 'Fields');
                if (field) {
                    field.style.display = 'none';
                    console.log('‚ùå Hiding:', type + 'Fields');
                }
            });

            // Show relevant fields
            const targetField = document.getElementById(sectionType + 'Fields');
            if (targetField) {
                targetField.style.display = 'block';
                console.log('‚úÖ Showing:', sectionType + 'Fields');
            }

            // Reset arrays when switching types
            if (sectionType !== 'documents') documentItems = [];
            if (sectionType !== 'links') linkItems = [];
            updatePreviews();
        }

        // Add document item
        function addDocumentItem() {
            const title = document.getElementById('docItemTitle').value;
            const link = document.getElementById('docItemLink').value;
            const desc = document.getElementById('docItemDesc').value;

            if (!title || !link) {
                alert('Please fill in title and link');
                return;
            }

            documentItems.push({
                title: title,
                link: link,
                description: desc,
                id: 'doc_' + Date.now()
            });

            // Clear form
            document.getElementById('docItemTitle').value = '';
            document.getElementById('docItemLink').value = '';
            document.getElementById('docItemDesc').value = '';

            updatePreviews();
            console.log('üìÑ Document added:', title);
        }

        // Add link item
        function addLinkItem() {
            const text = document.getElementById('linkText').value;
            const url = document.getElementById('linkUrl').value;
            const desc = document.getElementById('linkDesc').value;

            if (!text || !url) {
                alert('Please fill in link text and URL');
                return;
            }

            linkItems.push({
                text: text,
                url: url,
                description: desc,
                id: 'link_' + Date.now()
            });

            // Clear form
            document.getElementById('linkText').value = '';
            document.getElementById('linkUrl').value = '';
            document.getElementById('linkDesc').value = '';

            updatePreviews();
            console.log('üîó Link added:', text);
        }

        // Update previews
        function updatePreviews() {
            // Update documents preview
            const docPreview = document.getElementById('docItemsPreview');
            if (docPreview) {
                docPreview.innerHTML = documentItems.length === 0 ?
                    '<p style="color: #666; font-style: italic;">No documents added yet</p>' :
                    documentItems.map(doc => `
                <div class="item-preview">
                    <div class="item-info">
                        <strong>${doc.title}</strong><br>
                        <small>${doc.description || 'No description'}</small>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-secondary" onclick="removeDocumentItem('${doc.id}')" style="padding: 2px 8px; font-size: 12px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            }

            // Update links preview
            const linkPreview = document.getElementById('linkItemsPreview');
            if (linkPreview) {
                linkPreview.innerHTML = linkItems.length === 0 ?
                    '<p style="color: #666; font-style: italic;">No links added yet</p>' :
                    linkItems.map(link => `
                <div class="item-preview">
                    <div class="item-info">
                        <strong>${link.text}</strong><br>
                        <small>${link.url}</small>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-secondary" onclick="removeLinkItem('${link.id}')" style="padding: 2px 8px; font-size: 12px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            }
        }

        // Remove document item
        function removeDocumentItem(id) {
            documentItems = documentItems.filter(doc => doc.id !== id);
            updatePreviews();
            console.log('üóëÔ∏è Document removed:', id);
        }

        // Remove link item
        function removeLinkItem(id) {
            linkItems = linkItems.filter(link => link.id !== id);
            updatePreviews();
            console.log('üóëÔ∏è Link removed:', id);
        }

        // Create new section - MAIN FUNCTION
        function createNewSection() {
            console.log('üéØ Starting section creation...');

            const sectionType = document.getElementById('sectionType').value;
            const title = document.getElementById('sectionTitle').value;
            const sectionId = document.getElementById('sectionId').value;
            const order = parseInt(document.getElementById('sectionOrder').value);
            const bgColor = document.getElementById('sectionBgColor').value;

            console.log('üìã Form values:', { sectionType, title, sectionId, order, bgColor });

            // Validation
            if (!title || !sectionId) {
                alert('‚ùå Please fill in section title and ID');
                return;
            }

            // Validate section ID
            const validId = sectionId.toLowerCase().replace(/\s+/g, '');
            if (validId !== sectionId) {
                alert('Section ID should be lowercase with no spaces. Suggested: ' + validId);
                document.getElementById('sectionId').value = validId;
                return;
            }

            console.log('üîç Checking if section exists...');

            // Check if section already exists
            db.ref('customSections/' + validId).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    alert('‚ùå A section with this ID already exists. Please choose a different ID.');
                    return;
                }

                console.log('‚úÖ Section ID is available');

                // Create section data
                const sectionData = {
                    id: validId,
                    title: title,
                    type: sectionType,
                    order: order,
                    backgroundColor: bgColor,
                    createdAt: new Date().toISOString(),
                    createdBy: auth.currentUser.uid
                };

                // Add content based on type
                switch (sectionType) {
                    case 'text':
                        sectionData.content = document.getElementById('sectionContent').value;
                        break;
                    case 'documents':
                        sectionData.documents = documentItems;
                        break;
                    case 'links':
                        sectionData.links = linkItems;
                        break;
                    case 'custom':
                        sectionData.customHTML = document.getElementById('customHTML').value;
                        break;
                }

                console.log('üíæ Saving section data to Firebase...', sectionData);

                // Save to Firebase
                db.ref('customSections/' + validId).set(sectionData)
                    .then(() => {
                        console.log('‚úÖ Section saved successfully!');
                        alert('‚úÖ Section created successfully! It will appear on the homepage.');
                        clearSectionForm();
                        loadExistingSections();
                    })
                    .catch(error => {
                        console.error('‚ùå Error creating section:', error);
                        alert('‚ùå Error creating section: ' + error.message);
                    });
            }).catch(error => {
                console.error('‚ùå Error checking section existence:', error);
                alert('‚ùå Error checking section: ' + error.message);
            });
        }

        // Clear section form
        function clearSectionForm() {
            document.getElementById('sectionTitle').value = '';
            document.getElementById('sectionId').value = '';
            document.getElementById('sectionContent').value = '';
            document.getElementById('customHTML').value = '';
            document.getElementById('sectionOrder').value = '0';
            document.getElementById('sectionBgColor').value = 'white';

            documentItems = [];
            linkItems = [];
            updatePreviews();

            console.log('üßπ Section form cleared');
        }

        // Load existing sections
        function loadExistingSections() {
            const container = document.getElementById('existingSectionsList');
            if (!container) {
                console.log('‚ùå Existing sections container not found');
                return;
            }

            console.log('üìÇ Loading existing sections...');
            container.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Loading sections...</p>';

            db.ref('customSections').once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    console.log('üì¶ Sections data:', data);

                    if (!data) {
                        container.innerHTML = '<p>No custom sections created yet.</p>';
                        console.log('‚ÑπÔ∏è No sections found');
                        return;
                    }

                    let html = '';
                    Object.keys(data).forEach(sectionId => {
                        const section = data[sectionId];
                        html += `
                    <div class="section-preview-card">
                        <div class="section-preview-header">
                            <div>
                                <h4>${section.title}</h4>
                                <small>ID: ${section.id} | Order: ${section.order} | Type: <span class="section-type-badge">${section.type}</span></small>
                            </div>
                            <div>
                                <button class="btn" onclick="editSection('${sectionId}')" style="padding: 5px 10px;">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-secondary" onclick="deleteSection('${sectionId}')" style="padding: 5px 10px; background: #dc3545;">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                        <div class="section-content-preview">
                            ${getSectionPreview(section)}
                        </div>
                    </div>
                `;
                    });

                    container.innerHTML = html;
                    console.log(`‚úÖ Loaded ${Object.keys(data).length} sections`);
                })
                .catch(error => {
                    console.error('‚ùå Error loading sections:', error);
                    container.innerHTML = '<p style="color: red;">Error loading sections</p>';
                });
        }

        // Get section preview
        function getSectionPreview(section) {
            switch (section.type) {
                case 'text':
                    return `<p>${section.content?.substring(0, 200)}...</p>`;
                case 'documents':
                    return `<p>${section.documents?.length || 0} document(s)</p>`;
                case 'links':
                    return `<p>${section.links?.length || 0} link(s)</p>`;
                case 'custom':
                    return `<div style="color: #666;">Custom HTML content</div>`;
                default:
                    return '<p>No content preview</p>';
            }
        }

        // Edit section
        function editSection(sectionId) {
            console.log('‚úèÔ∏è Editing section:', sectionId);

            // Load section data into editor
            db.ref('customSections/' + sectionId).once('value')
                .then(snapshot => {
                    const section = snapshot.val();
                    if (section) {
                        // Populate form fields
                        document.getElementById('sectionTitle').value = section.title;
                        document.getElementById('sectionId').value = section.id;
                        document.getElementById('sectionType').value = section.type;
                        document.getElementById('sectionOrder').value = section.order;
                        document.getElementById('sectionBgColor').value = section.backgroundColor;

                        // Populate content based on type
                        switch (section.type) {
                            case 'text':
                                document.getElementById('sectionContent').value = section.content || '';
                                break;
                            case 'documents':
                                documentItems = section.documents || [];
                                break;
                            case 'links':
                                linkItems = section.links || [];
                                break;
                            case 'custom':
                                document.getElementById('customHTML').value = section.customHTML || '';
                                break;
                        }

                        toggleSectionFields();
                        updatePreviews();

                        alert('Section loaded for editing. Make changes and click "Create Section" to update.');
                    }
                });
        }

        // Delete section
        function deleteSection(sectionId) {
            if (confirm('Are you sure you want to delete this section? This cannot be undone.')) {
                console.log('üóëÔ∏è Deleting section:', sectionId);

                db.ref('customSections/' + sectionId).remove()
                    .then(() => {
                        console.log('‚úÖ Section deleted successfully');
                        alert('‚úÖ Section deleted successfully!');
                        loadExistingSections();
                    })
                    .catch(error => {
                        console.error('‚ùå Error deleting section:', error);
                        alert('‚ùå Error deleting section: ' + error.message);
                    });
            }
        }

        // Update the showContentTab function to initialize section creator
        const originalShowContentTab = showContentTab;
        showContentTab = function (tabName) {
            originalShowContentTab(tabName);

            if (tabName === 'sectionCreator') {
                console.log('üéØ Section Creator tab opened - initializing...');
                setTimeout(initSectionCreator, 100);
            }
        };

        console.log('‚úÖ Section Creator JavaScript loaded successfully');





        // Complaints Management Functions - CORRECTED VERSION
        let currentComplaintsYear = 'year1';
        let currentComplaintsSubTab = 'missingMarks';

        function showComplaintsSubTab(tabName) {
            currentComplaintsSubTab = tabName;

            document.querySelectorAll('#complaintsSection .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#complaintsSection .tab-content').forEach(content => {
                content.style.display = 'none';
            });

            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').style.display = 'block';

            if (tabName === 'missingMarks') {
                loadComplaintsForYear(currentComplaintsYear);
            } else if (tabName === 'anonymousIssues') {
                loadAnonymousIssues(); // This line ensures issues load when tab is clicked
            }
        }
        function showComplaintsYear(year) {
            currentComplaintsYear = year;

            // Update year tabs
            document.querySelectorAll('#missingMarksTab .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update title
            const yearTitles = {
                'year1': '1st Year',
                'year2': '2nd Year',
                'year3': '3rd Year',
                'year4': '4th Year',
                'year5': '5th Year'
            };
            document.getElementById('complaintsYearTitle').textContent = yearTitles[year] + ' Complaints';

            // Load complaints for selected year
            loadComplaintsForYear(year);
        }

        function loadComplaintsForYear(year) {
            const tableBody = document.getElementById('complaintsTableBody');
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Loading complaints...</td></tr>';

            // Determine the Firebase path based on year
            const complaintsPath = year === 'year2' ? 'complaints' : `complaints_${year}`;

            console.log(`Loading complaints from: ${complaintsPath}`);

            if (year === 'year2') {
                // For 2nd year: Load both complaints and registrations to match names
                Promise.all([
                    db.ref(complaintsPath).once('value'),
                    db.ref('registrations').once('value')
                ]).then(([complaintsSnap, registrationsSnap]) => {
                    const complaintsData = complaintsSnap.val() || {};
                    const registrationsData = registrationsSnap.val() || {};

                    console.log('Year2 Complaints data:', complaintsData);
                    console.log('Year2 Registrations data:', registrationsData);

                    const allComplaints = [];

                    // Handle year2 complaints structure: EB24 >> 74506 >> 24 >> timestamp >> data
                    for (const part1 in complaintsData) { // EB24
                        const level1 = complaintsData[part1];
                        if (level1 && typeof level1 === 'object') {
                            for (const part2 in level1) { // 74506
                                const level2 = level1[part2];
                                if (level2 && typeof level2 === 'object') {
                                    for (const part3 in level2) { // 24
                                        const level3 = level2[part3];
                                        if (level3 && typeof level3 === 'object') {
                                            for (const timestamp in level3) {
                                                const complaint = level3[timestamp];
                                                if (complaint && typeof complaint === 'object') {
                                                    // Build the full registration number from the path
                                                    const fullRegNo = `${part1}/${part2}/${part3}`;

                                                    // Extract name from registrations database
                                                    let name = "Unknown";
                                                    if (fullRegNo && typeof fullRegNo === 'string') {
                                                        const regParts = fullRegNo.split('/');
                                                        if (regParts.length === 3) {
                                                            const [group, middle, last] = regParts;
                                                            // Navigate the nested registration structure
                                                            const student = registrationsData[group] &&
                                                                registrationsData[group][middle] &&
                                                                registrationsData[group][middle][last];
                                                            name = student ? student.name : "Unknown";
                                                        }
                                                    }

                                                    allComplaints.push({
                                                        name: name,
                                                        regNo: fullRegNo,
                                                        unit: complaint.unit || 'N/A',
                                                        lecturer: complaint.lecturer || 'N/A',
                                                        timestamp: complaint.submittedAt || timestamp,
                                                        rawTimestamp: timestamp,
                                                        year: year
                                                    });

                                                    console.log(`Found year2 complaint: ${fullRegNo}`, {
                                                        name: name,
                                                        complaintData: complaint
                                                    });
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }

                    displayComplaints(allComplaints, year);
                }).catch(error => {
                    console.error('Error loading year2 complaints:', error);
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">Error loading complaints: ' + error.message + '</td></tr>';
                });
            } else {
                // For other years: Only load complaints (names are stored in complaint data)
                db.ref(complaintsPath).once('value').then(complaintsSnap => {
                    const complaintsData = complaintsSnap.val() || {};
                    console.log(`${year} Complaints data:`, complaintsData);

                    const allComplaints = [];

                    // Process other years structure: EB24 ‚Üí 74506 ‚Üí 24 ‚Üí timestamp ‚Üí complaint data
                    for (const part1 in complaintsData) { // EB24
                        const level1 = complaintsData[part1];
                        if (level1 && typeof level1 === 'object') {
                            for (const part2 in level1) { // 74506
                                const level2 = level1[part2];
                                if (level2 && typeof level2 === 'object') {
                                    for (const part3 in level2) { // 24
                                        const level3 = level2[part3];
                                        if (level3 && typeof level3 === 'object') {
                                            for (const timestamp in level3) {
                                                const complaint = level3[timestamp];
                                                if (complaint && typeof complaint === 'object') {
                                                    // Build the full registration number from the path
                                                    const fullRegNo = `${part1}/${part2}/${part3}`;

                                                    // For other years, name is stored directly in complaint data
                                                    const name = complaint.name || "Unknown";

                                                    allComplaints.push({
                                                        name: name,
                                                        regNo: fullRegNo,
                                                        unit: complaint.unit || 'N/A',
                                                        lecturer: complaint.lecturer || 'N/A',
                                                        timestamp: complaint.submittedAt || timestamp,
                                                        rawTimestamp: timestamp,
                                                        year: year
                                                    });
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }

                    displayComplaints(allComplaints, year);
                }).catch(error => {
                    console.error(`Error loading ${year} complaints:`, error);
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">Error loading complaints: ' + error.message + '</td></tr>';
                });
            }
        }

        function displayComplaints(allComplaints, year) {
            const tableBody = document.getElementById('complaintsTableBody');

            console.log(`Displaying ${allComplaints.length} complaints for ${year}`);

            // Sort by timestamp (newest first)
            allComplaints.sort((a, b) => {
                const timeA = a.timestamp ? new Date(a.timestamp).getTime() : parseInt(a.rawTimestamp);
                const timeB = b.timestamp ? new Date(b.timestamp).getTime() : parseInt(b.rawTimestamp);
                return timeB - timeA;
            });

            // Populate table
            tableBody.innerHTML = '';

            if (allComplaints.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No complaints found for this year.</td></tr>';
                return;
            }

            allComplaints.forEach(complaint => {
                const row = document.createElement('tr');

                // Format timestamp properly
                let formattedDate = 'N/A';
                try {
                    if (complaint.timestamp && complaint.timestamp !== 'N/A') {
                        formattedDate = new Date(complaint.timestamp).toLocaleString();
                    } else if (complaint.rawTimestamp) {
                        formattedDate = new Date(parseInt(complaint.rawTimestamp)).toLocaleString();
                    }
                } catch (e) {
                    console.error('Error formatting date:', e);
                    formattedDate = 'Invalid Date';
                }

                row.innerHTML = `
            <td>${complaint.name}</td>
            <td><strong>${complaint.regNo}</strong></td>
            <td>${complaint.unit}</td>
            <td>${complaint.lecturer}</td>
            <td>${formattedDate}</td>
            <td>
                <button class="btn btn-secondary" onclick="resolveComplaint('${complaint.year}', '${complaint.regNo}', '${complaint.rawTimestamp}')" style="padding: 5px 10px; font-size: 0.9em;">
                    Mark Resolved
                </button>
            </td>
        `;
                tableBody.appendChild(row);
            });
        }
        // Helper function to find student name in registration data
        function findStudentName(registrationsData, regNo) {
            // Try to find student by matching registration number in nested structure
            for (const level1 in registrationsData) {
                const groupData = registrationsData[level1];
                if (groupData && typeof groupData === 'object') {
                    for (const level2 in groupData) {
                        const middleData = groupData[level2];
                        if (middleData && typeof middleData === 'object') {
                            for (const level3 in middleData) {
                                const student = middleData[level3];
                                const currentRegNo = `${level1}/${level2}/${level3}`;
                                if (currentRegNo === regNo && student && student.name) {
                                    return student.name;
                                }
                            }
                        }
                    }
                }
            }
            return "Unknown";
        }

        function resolveComplaint(year, regNo, timestamp) {
            if (confirm('Mark this complaint as resolved?')) {
                let fullPath;

                if (year === 'year2') {
                    // Year2 structure: complaints/EB24/74506/24/timestamp
                    const regParts = regNo.split('/');
                    if (regParts.length !== 3) {
                        alert('Invalid registration number format');
                        return;
                    }
                    const [part1, part2, part3] = regParts;
                    fullPath = `complaints/${part1}/${part2}/${part3}/${timestamp}`;
                } else {
                    // Other years structure: complaints_yearX/EB24/74506/24/timestamp
                    const regParts = regNo.split('/');
                    if (regParts.length !== 3) {
                        alert('Invalid registration number format');
                        return;
                    }
                    const [part1, part2, part3] = regParts;
                    fullPath = `complaints_${year}/${part1}/${part2}/${part3}/${timestamp}`;
                }

                console.log(`Deleting complaint at path: ${fullPath}`);

                db.ref(fullPath).remove()
                    .then(() => {
                        alert('‚úÖ Complaint marked as resolved!');
                        loadComplaintsForYear(year);
                    })
                    .catch(error => {
                        console.error('Error resolving complaint:', error);
                        alert('‚ùå Error resolving complaint: ' + error.message);
                    });
            }
        }
        function loadAnonymousIssues() {
            const tableBody = document.getElementById('anonymousIssuesTableBody');
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Loading anonymous issues...</td></tr>';

            db.ref('anonymous_issues').once('value').then(snapshot => {
                const data = snapshot.val();
                tableBody.innerHTML = '';

                if (!data) {
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No anonymous issues found.</td></tr>';
                    return;
                }

                const allIssues = [];
                for (const year in data) {
                    const yearIssues = data[year];
                    for (const issueId in yearIssues) {
                        allIssues.push({
                            ...yearIssues[issueId],
                            year: year,
                            id: issueId
                        });
                    }
                }

                // Sort by timestamp (newest first)
                allIssues.sort((a, b) => b.timestamp - a.timestamp);

                allIssues.forEach(issue => {
                    const row = document.createElement('tr');
                    const date = new Date(parseInt(issue.timestamp)).toLocaleString();

                    row.innerHTML = `
                <td>${getIssueTypeDisplay(issue.issueType)}</td>
                <td style="max-width: 300px; word-wrap: break-word;">${issue.description}</td>
                <td>${issue.year}</td>
                <td>${date}</td>
                <td>
                    <button class="btn btn-secondary" onclick="resolveAnonymousIssue('${issue.year}', '${issue.id}')" style="padding: 5px 10px; font-size: 0.9em;">
                        Mark Resolved
                    </button>
                </td>
            `;
                    tableBody.appendChild(row);
                });
            }).catch(error => {
                console.error('Error loading anonymous issues:', error);
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">Error loading issues</td></tr>';
            });
        }

        function getIssueTypeDisplay(type) {
            const types = {
                'teaching': 'Teaching Quality',
                'resources': 'Learning Resources',
                'facilities': 'Classroom Facilities',
                'schedule': 'Class Schedule',
                'communication': 'Communication',
                'other': 'Other'
            };
            return types[type] || type;
        }

        function resolveComplaint(year, regNo, timestamp) {
            if (confirm('Mark this complaint as resolved?')) {
                const path = year === 'year2' ? 'complaints' : `complaints_${year}`;
                db.ref(`${path}/${regNo}/${timestamp}`).remove()
                    .then(() => {
                        alert('‚úÖ Complaint marked as resolved!');
                        loadComplaints();
                    })
                    .catch(error => {
                        console.error('Error resolving complaint:', error);
                        alert('‚ùå Error resolving complaint: ' + error.message);
                    });
            }
        }

        function resolveAnonymousIssue(year, issueId) {
            if (confirm('Mark this anonymous issue as resolved?')) {
                db.ref(`anonymous_issues/${year}/${issueId}`).remove()
                    .then(() => {
                        alert('‚úÖ Issue marked as resolved!');
                        loadAnonymousIssues();
                    })
                    .catch(error => {
                        console.error('Error resolving issue:', error);
                        alert('‚ùå Error resolving issue: ' + error.message);
                    });
            }
        }

        function exportComplaintsToExcel() {
            alert('üìä Export feature will be implemented soon!');
        }










        // Add this debug function
        function debugAnonymousIssues() {
            console.log('=== DEBUG: Checking Anonymous Issues Structure ===');
            db.ref('anonymousIssues').once('value').then(snapshot => {
                const data = snapshot.val();
                console.log('Full anonymous issues data:', data);

                if (!data) {
                    console.log('No data found at "anonymousIssues" path');
                    // Check other possible paths
                    db.ref().once('value').then(fullSnapshot => {
                        const allData = fullSnapshot.val();
                        console.log('All Firebase data:', allData);

                        // Look for any paths that might contain anonymous issues
                        for (const key in allData) {
                            if (key.toLowerCase().includes('anonymous') || key.toLowerCase().includes('issue')) {
                                console.log(`Found potential issues path: ${key}`, allData[key]);
                            }
                        }
                    });
                } else {
                    // Show the structure of existing data
                    for (const year in data) {
                        console.log(`Year: ${year}`, data[year]);
                    }
                }
            }).catch(error => {
                console.error('Debug error:', error);
            });
        }

        // Call this to debug
        setTimeout(debugAnonymousIssues, 3000);







        // Trip Shift Management Functions
        let currentTripShiftTab = 'shift1';

        function showTripShiftTab(tabName) {
            currentTripShiftTab = tabName;

            document.querySelectorAll('#tripShiftsSection .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#tripShiftsSection .tab-content').forEach(content => {
                content.style.display = 'none';
            });

            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').style.display = 'block';

            // Load data when tab is switched
            if (tabName === 'stats') {
                loadTripShiftStats();
            } else {
                loadTripShift(tabName);
            }
        }

        function loadTripShift(shift) {
            const tableId = shift + 'Table';
            const countId = shift + 'Count';
            const tableBody = document.querySelector(`#${tableId} tbody`);

            tableBody.innerHTML = `
        <tr>
            <td colspan="5" style="text-align: center; padding: 20px;">
                <i class="fas fa-spinner fa-spin"></i> Loading ${shift} registrations...
            </td>
        </tr>
    `;

            db.ref(`trip/${shift}`).once('value').then(snapshot => {
                const data = snapshot.val();

                if (!data) {
                    tableBody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 20px;">
                        No registrations found for ${shift}.
                    </td>
                </tr>
            `;
                    document.getElementById(countId).textContent = `0/${shift === 'shift1' ? '51' : '52'}`;
                    return;
                }

                const registrations = [];
                let count = 0;

                // Process the data (it's stored with push() keys)
                for (const key in data) {
                    const registration = data[key];
                    if (registration && typeof registration === 'object') {
                        registrations.push({
                            id: key,
                            name: registration.name || 'N/A',
                            regNo: registration.regNo || 'N/A',
                            timestamp: registration.timestamp || 'N/A'
                        });
                        count++;
                    }
                }

                // Sort by timestamp (newest first)
                registrations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                // Update count display
                document.getElementById(countId).textContent = `${count}/${shift === 'shift1' ? '51' : '52'}`;

                // Populate table
                tableBody.innerHTML = '';

                if (registrations.length === 0) {
                    tableBody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 20px;">
                        No registrations found.
                    </td>
                </tr>
            `;
                } else {
                    registrations.forEach((reg, index) => {
                        const formattedDate = formatDate(reg.timestamp);
                        const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${reg.name}</td>
                        <td><strong>${reg.regNo}</strong></td>
                        <td>${formattedDate}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="removeTripRegistration('${shift}', '${reg.id}')" style="padding: 5px 10px; font-size: 0.9em;">
                                Remove
                            </button>
                        </td>
                    </tr>
                `;
                        tableBody.insertAdjacentHTML("beforeend", row);
                    });
                }

            }).catch(error => {
                console.error(`Error loading ${shift}:`, error);
                tableBody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; color: red;">
                    Error loading data: ${error.message}
                </td>
            </tr>
        `;
            });
        }

        function loadTripShiftStats() {
            // Load both shifts to calculate statistics
            Promise.all([
                db.ref('trip/shift1').once('value'),
                db.ref('trip/shift2').once('value')
            ]).then(([shift1Snap, shift2Snap]) => {
                const shift1Data = shift1Snap.val() || {};
                const shift2Data = shift2Snap.val() || {};

                const shift1Count = Object.keys(shift1Data).length;
                const shift2Count = Object.keys(shift2Data).length;
                const totalCount = shift1Count + shift2Count;

                // Update statistics
                document.getElementById('totalTripRegs').textContent = totalCount;
                document.getElementById('shift1Percentage').textContent =
                    Math.round((shift1Count / 51) * 100) + '%';
                document.getElementById('shift2Percentage').textContent =
                    Math.round((shift2Count / 52) * 100) + '%';

                const availableSpots = (51 - shift1Count) + (52 - shift2Count);
                document.getElementById('availableSpots').textContent = availableSpots;

                // Update count badges
                document.getElementById('shift1Count').textContent = `${shift1Count}/51`;
                document.getElementById('shift2Count').textContent = `${shift2Count}/52`;

            }).catch(error => {
                console.error('Error loading trip stats:', error);
                alert('Error loading statistics: ' + error.message);
            });
        }

        function removeTripRegistration(shift, registrationId) {
            if (confirm('Are you sure you want to remove this registration?')) {
                db.ref(`trip/${shift}/${registrationId}`).remove()
                    .then(() => {
                        alert('‚úÖ Registration removed successfully!');
                        loadTripShift(shift);
                        loadTripShiftStats();
                    })
                    .catch(error => {
                        console.error('Error removing registration:', error);
                        alert('‚ùå Error removing registration: ' + error.message);
                    });
            }
        }

        function exportTripShifts() {
            // First load all data
            Promise.all([
                db.ref('trip/shift1').once('value'),
                db.ref('trip/shift2').once('value')
            ]).then(([shift1Snap, shift2Snap]) => {
                const shift1Data = shift1Snap.val() || {};
                const shift2Data = shift2Snap.val() || {};

                // Prepare data for export
                const exportData = [];

                // Process Shift 1
                Object.keys(shift1Data).forEach((key, index) => {
                    const student = shift1Data[key];
                    exportData.push({
                        'Shift': 'Shift 1',
                        'No.': index + 1,
                        'Full Name': student.name || 'N/A',
                        'Registration Number': student.regNo || 'N/A',
                        'Phone': student.phone || 'N/A',
                        'Email': student.email || 'N/A',
                        'Timestamp': formatDateForExcel(student.timestamp),
                        'Registered At': formatDate(student.timestamp)
                    });
                });

                // Process Shift 2
                Object.keys(shift2Data).forEach((key, index) => {
                    const student = shift2Data[key];
                    exportData.push({
                        'Shift': 'Shift 2',
                        'No.': exportData.filter(item => item['Shift'] === 'Shift 1').length + index + 1,
                        'Full Name': student.name || 'N/A',
                        'Registration Number': student.regNo || 'N/A',
                        'Phone': student.phone || 'N/A',
                        'Email': student.email || 'N/A',
                        'Timestamp': formatDateForExcel(student.timestamp),
                        'Registered At': formatDate(student.timestamp)
                    });
                });

                if (exportData.length === 0) {
                    alert('No trip shift registrations found to export.');
                    return;
                }

                // Create Excel workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);

                // Set column widths
                const wscols = [
                    { wch: 10 }, // Shift
                    { wch: 5 },  // No.
                    { wch: 25 }, // Full Name
                    { wch: 20 }, // Registration Number
                    { wch: 15 }, // Phone
                    { wch: 30 }, // Email
                    { wch: 25 }, // Timestamp (Excel)
                    { wch: 25 }  // Registered At (Formatted)
                ];
                ws['!cols'] = wscols;

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Trip Registrations');

                // Add summary sheet
                const summaryData = [
                    { 'Statistic': 'Shift 1 Registrations', 'Count': Object.keys(shift1Data).length, 'Capacity': '51' },
                    { 'Statistic': 'Shift 2 Registrations', 'Count': Object.keys(shift2Data).length, 'Capacity': '52' },
                    { 'Statistic': 'Total Registrations', 'Count': Object.keys(shift1Data).length + Object.keys(shift2Data).length, 'Capacity': '103' },
                    { 'Statistic': 'Shift 1 Available', 'Count': 51 - Object.keys(shift1Data).length, 'Capacity': '-' },
                    { 'Statistic': 'Shift 2 Available', 'Count': 52 - Object.keys(shift2Data).length, 'Capacity': '-' },
                    { 'Statistic': 'Export Date', 'Count': new Date().toLocaleDateString(), 'Capacity': '-' }
                ];

                const ws2 = XLSX.utils.json_to_sheet(summaryData);
                ws2['!cols'] = [{ wch: 25 }, { wch: 15 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, ws2, 'Summary');

                // Generate filename with timestamp
                const date = new Date();
                const timestamp = `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}_${date.getHours().toString().padStart(2, '0')}${date.getMinutes().toString().padStart(2, '0')}`;
                const filename = `Trip_Shifts_${timestamp}.xlsx`;

                // Export to Excel
                XLSX.writeFile(wb, filename);

                // Show success message
                alert(`‚úÖ Exported ${exportData.length} registrations to ${filename}`);

            }).catch(error => {
                console.error('Error exporting trip shifts:', error);
                alert('‚ùå Error exporting trip shifts: ' + error.message);
            });
        }

        // Helper function for Excel date format
        function formatDateForExcel(timestamp) {
            if (!timestamp || timestamp === 'N/A') return 'N/A';
            try {
                const date = new Date(timestamp);
                // Excel uses a different date format (YYYY-MM-DD HH:MM:SS)
                return date.toISOString().split('T')[0] + ' ' +
                    date.toTimeString().split(' ')[0];
            } catch (e) {
                return timestamp;
            }
        }

        // Update the showSection function to include trip shifts
        function showSection(sectionName) {
            console.log('Showing section:', sectionName);

            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });

            // Show selected section
            const targetSection = document.getElementById(sectionName + 'Section');
            if (targetSection) {
                targetSection.style.display = 'block';
            }

            // Update current section title
            const titles = {
                'dashboard': 'Dashboard Overview',
                'content': 'Content Management',
                'registrations': 'Student Registrations',
                'complaints': 'Academic Complaints Management',
                'groups': 'Group Management',
                'pending': 'Pending Students',
                'announcements': 'Announcements Management',
                'users': 'User Management',
                'settings': 'System Settings',
                'tripShifts': 'Trip Shift Registrations'  // Add this line
            };
            document.getElementById('currentSection').textContent = titles[sectionName] || sectionName;

            // Update active nav
            document.querySelectorAll('.nav-links li').forEach(li => {
                li.classList.remove('active');
            });
            event.target.closest('li').classList.add('active');

            // Load data when trip shifts section is opened
            if (sectionName === 'tripShifts') {
                loadTripShift('shift1');
                loadTripShiftStats();
            }
        }



        // Global variables
        let currentAnnouncementsTab = 'create';
        let allAnnouncements = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        // Show announcements tab
        function showAnnouncementsTab(tabName) {
            currentAnnouncementsTab = tabName;

            // Update tabs
            const tabs = document.querySelectorAll('#announcementsSection .tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });

            document.querySelectorAll('#announcementsSection .tab-content').forEach(content => {
                content.style.display = 'none';
            });

            // Find and activate the correct tab
            tabs.forEach(tab => {
                const onclickAttr = tab.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes(`'${tabName}'`)) {
                    tab.classList.add('active');
                }
            });

            // FIX: Handle different tab ID formats
            let tabId;
            switch (tabName) {
                case 'create':
                    tabId = 'createAnnouncementTab';
                    break;
                case 'manage':
                    tabId = 'manageAnnouncementsTab'; // Notice the 's' in Announcements
                    break;
                case 'history':
                    tabId = 'historyAnnouncementTab';
                    break;
                case 'settings':
                    tabId = 'settingsAnnouncementTab';
                    break;
                default:
                    tabId = tabName + 'AnnouncementTab';
            }

            const tabElement = document.getElementById(tabId);
            if (tabElement) {
                tabElement.style.display = 'block';
            } else {
                console.error('Tab element not found:', tabId);
            }

            // Load data based on tab
            switch (tabName) {
                case 'manage':
                    loadAnnouncements();
                    break;
                case 'history':
                    loadAnnouncementHistory();
                    break;
                case 'settings':
                    loadAnnouncementSettings();
                    break;
            }
        }
        // Create new announcement
        function createAnnouncement() {
            const title = document.getElementById('announcementTitle').value.trim();
            const message = document.getElementById('announcementMessage').value.trim();
            const type = document.getElementById('announcementType').value;
            const audience = document.getElementById('announcementAudience').value;
            const sendPush = document.getElementById('sendPushNotification').checked;
            const showOnWebsite = document.getElementById('showOnWebsite').checked;
            const markImportant = document.getElementById('markAsImportant').checked;
            const schedule = document.getElementById('announcementSchedule').value;
            const expiry = document.getElementById('announcementExpiry').value;
            const link = document.getElementById('announcementLink').value.trim();

            // Validation
            if (!title) {
                alert('‚ùå Please enter an announcement title');
                document.getElementById('announcementTitle').focus();
                return;
            }

            if (!message) {
                alert('‚ùå Please enter the announcement message');
                document.getElementById('announcementMessage').focus();
                return;
            }

            // Prepare announcement data
            const announcementData = {
                title: title,
                message: message,
                type: type,
                audience: audience,
                sendPush: sendPush,
                showOnWebsite: showOnWebsite,
                important: markImportant,
                link: link || null,
                schedule: schedule || null,
                expiry: expiry || null,
                createdBy: auth.currentUser.uid,
                createdAt: new Date().toISOString(),
                status: schedule ? 'scheduled' : 'active',
                views: 0,
                acknowledgedBy: [],
                updatedAt: null
            };

            // Generate ID
            const announcementId = 'ann_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            // Save to Firebase
            db.ref('announcements/' + announcementId).set(announcementData)
                .then(() => {
                    alert('‚úÖ Announcement published successfully!');

                    // Log activity
                    logActivity('announcement_created', {
                        title: title,
                        type: type,
                        audience: audience
                    });

                    // Send push notification if enabled
                    // Send push notification if enabled
                    // Send push notification if enabled
                    if (sendPush) {
                        sendPushNotification(announcementData, announcementId);
                    }

                    // Clear form
                    clearAnnouncementForm();

                    // Switch to manage tab
                    showAnnouncementsTab('manage');

                    // Refresh list
                    loadAnnouncements();
                })
                .catch(error => {
                    console.error('Error creating announcement:', error);
                    alert('‚ùå Error creating announcement: ' + error.message);
                });
        }
        // Function to send push notification
        function sendPushNotification(announcementData, announcementId) {
            console.log('Sending push notification for announcement:', announcementId);

            // Get all FCM tokens from Firebase
            db.ref('fcmTokens').once('value')
                .then(snapshot => {
                    const tokens = snapshot.val();
                    if (!tokens) {
                        console.log('No FCM tokens found');
                        return;
                    }

                    // Prepare notification data
                    const notificationData = {
                        title: announcementData.title,
                        body: announcementData.message.length > 100 ?
                            announcementData.message.substring(0, 100) + '...' :
                            announcementData.message,
                        icon: 'https://bsceee-webpage.firebaseapp.com/pngegg.png',
                        click_action: announcementData.link || 'https://bsceee-webpage.firebaseapp.com/announcements.html',
                        announcementId: announcementId,
                        type: announcementData.type,
                        audience: announcementData.audience,
                        url: announcementData.link || '/announcements.html'
                    };

                    // Collect all tokens
                    const tokenList = [];
                    Object.keys(tokens).forEach(userId => {
                        if (tokens[userId].token) {
                            tokenList.push(tokens[userId].token);
                        }
                    });

                    if (tokenList.length === 0) {
                        console.log('No valid FCM tokens found');
                        return;
                    }

                    console.log(`Sending notification to ${tokenList.length} devices`);

                    // Save notification data to send from a backend
                    // For now, we'll save it to Firebase and you can use Cloud Functions later
                    const pushData = {
                        tokens: tokenList,
                        notification: {
                            title: notificationData.title,
                            body: notificationData.body
                        },
                        data: {
                            announcementId: announcementId,
                            type: announcementData.type,
                            url: notificationData.url,
                            click_action: notificationData.click_action
                        },
                        timestamp: new Date().toISOString()
                    };

                    // Save to Firebase for processing
                    return db.ref('pushQueue/' + announcementId).set(pushData);
                })
                .then(() => {
                    console.log('Push notification queued successfully');

                    // Show local notification for admin
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('Notification Sent', {
                            body: `Push notification sent to students`,
                            icon: 'https://bsceee-webpage.firebaseapp.com/pngegg.png'
                        });
                    }
                })
                .catch(error => {
                    console.error('Error sending push notification:', error);
                });
        }
        // Temporary function to simulate sending notifications
        function simulatePushNotification(announcementData) {
            console.log('Simulating push notification...');

            // This is a temporary solution until you set up Cloud Functions
            // For now, it just logs what would be sent

            const notificationPayload = {
                notification: {
                    title: announcementData.title,
                    body: announcementData.message.substring(0, 100) + '...',
                    icon: 'https://bsceee-webpage.firebaseapp.com/pngegg.png',
                    click_action: announcementData.link || 'https://bsceee-webpage.firebaseapp.com/announcements.html'
                },
                data: {
                    announcementId: 'temp_id',
                    type: announcementData.type,
                    timestamp: new Date().toISOString()
                }
            };

            console.log('Notification payload:', notificationPayload);

            // Save to log
            db.ref('notificationLogs/' + Date.now()).set({
                ...notificationPayload,
                sentAt: new Date().toISOString(),
                sentBy: auth.currentUser.uid
            });

            return Promise.resolve();
        }
        // Preview announcement
        function previewAnnouncement() {
            const title = document.getElementById('announcementTitle').value;
            const message = document.getElementById('announcementMessage').value;
            const type = document.getElementById('announcementType').value;
            const important = document.getElementById('markAsImportant').checked;

            if (!title || !message) {
                alert('Please enter title and message to preview');
                return;
            }

            // Type colors and icons
            const typeConfig = {
                'info': { color: '#17a2b8', icon: '‚ÑπÔ∏è', label: 'Information' },
                'warning': { color: '#ffc107', icon: '‚ö†Ô∏è', label: 'Warning' },
                'important': { color: '#dc3545', icon: '‚ùó', label: 'Important' },
                'urgent': { color: '#dc3545', icon: 'üö®', label: 'Urgent' },
                'event': { color: '#28a745', icon: 'üìÖ', label: 'Event' },
                'success': { color: '#28a745', icon: '‚úÖ', label: 'Success' }
            };

            const config = typeConfig[type] || typeConfig.info;
            const currentDate = new Date().toLocaleString();

            const previewHTML = `
        <div class="preview-announcement preview-${type}">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div>
                    <span style="background: ${config.color}; color: ${type === 'urgent' ? 'white' : 'inherit'}; 
                          padding: 3px 10px; border-radius: 12px; font-weight: 600; font-size: 0.9em;">
                        ${config.icon} ${config.label}
                    </span>
                    ${important ? '<span style="color: #ffc107; margin-left: 10px;"><i class="fas fa-star"></i> Important</span>' : ''}
                </div>
                <div style="font-size: 0.85em; color: #666;">
                    ${currentDate}
                </div>
            </div>
            
            <h4 style="margin: 10px 0; color: ${type === 'urgent' ? 'white' : '#004080'};">${title}</h4>
            
            <div style="margin: 15px 0; line-height: 1.6; color: ${type === 'urgent' ? 'white' : '#333'};">
                ${message.replace(/\n/g, '<br>')}
            </div>
            
            <div style="font-size: 0.85em; color: ${type === 'urgent' ? 'rgba(255,255,255,0.8)' : '#666'};">
                <i class="fas fa-users"></i> Audience: ${document.getElementById('announcementAudience').selectedOptions[0].text}
            </div>
        </div>
        
        <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 0.9em;">
            <strong>Preview Note:</strong> This is how the announcement will appear on the website.
            ${type === 'urgent' ? '<br><span style="color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> Urgent announcements have red background and pulse animation.</span>' : ''}
        </div>
    `;

            document.getElementById('previewContent').innerHTML = previewHTML;
            document.getElementById('announcementPreview').style.display = 'block';
        }

        // Clear announcement form
        function clearAnnouncementForm() {
            document.getElementById('announcementTitle').value = '';
            document.getElementById('announcementMessage').value = '';
            document.getElementById('announcementType').value = 'info';
            document.getElementById('announcementAudience').value = 'all';
            document.getElementById('sendPushNotification').checked = true;
            document.getElementById('showOnWebsite').checked = true;
            document.getElementById('markAsImportant').checked = false;
            document.getElementById('announcementSchedule').value = '';
            document.getElementById('announcementExpiry').value = '';
            document.getElementById('announcementLink').value = '';
            document.getElementById('announcementPreview').style.display = 'none';
        }

        // Load announcements for management
        function loadAnnouncements() {
            const tableBody = document.getElementById('announcementsTableBody');
            tableBody.innerHTML = `
        <tr>
            <td colspan="7" style="text-align: center; padding: 30px;">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin fa-2x" style="color: #004080; margin-bottom: 15px;"></i><br>
                    <span>Loading announcements...</span>
                </div>
            </td>
        </tr>
    `;

            db.ref('announcements').orderByChild('createdAt').once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    allAnnouncements = [];

                    if (!data) {
                        tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px;">
                            <div style="color: #6c757d;">
                                <i class="fas fa-bullhorn fa-2x" style="margin-bottom: 10px;"></i><br>
                                No announcements yet. Create your first one!
                            </div>
                        </td>
                    </tr>
                `;
                        updateActiveCount(0);
                        return;
                    }

                    // Convert to array
                    Object.keys(data).forEach(key => {
                        allAnnouncements.push({
                            id: key,
                            ...data[key]
                        });
                    });

                    // Sort by creation date (newest first)
                    allAnnouncements.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                    // Update active count
                    const activeCount = allAnnouncements.filter(a => a.status === 'active').length;
                    updateActiveCount(activeCount);

                    // Filter based on checkboxes
                    filterAnnouncements();
                })
                .catch(error => {
                    console.error('Error loading announcements:', error);
                    tableBody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; color: #dc3545; padding: 30px;">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        Error loading announcements: ${error.message}
                    </td>
                </tr>
            `;
                });
        }

        // Filter announcements based on checkboxes
        function filterAnnouncements() {
            const showActive = document.getElementById('filterActive')?.checked || true;
            const showScheduled = document.getElementById('filterScheduled')?.checked || false;
            const showExpired = document.getElementById('filterExpired')?.checked || false;

            const filtered = allAnnouncements.filter(ann => {
                if (showActive && ann.status === 'active') return true;
                if (showScheduled && ann.status === 'scheduled') return true;
                if (showExpired && (ann.status === 'expired' || ann.status === 'archived')) return true;
                return false;
            });

            displayAnnouncementsTable(filtered);
        }

        // Display announcements in table
        function displayAnnouncementsTable(announcements) {
            const tableBody = document.getElementById('announcementsTableBody');

            if (announcements.length === 0) {
                tableBody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 30px;">
                    <div style="color: #6c757d;">
                        <i class="fas fa-filter fa-2x" style="margin-bottom: 10px;"></i><br>
                        No announcements match your filter criteria.
                    </div>
                </td>
            </tr>
        `;
                document.getElementById('announcementsPagination').style.display = 'none';
                return;
            }

            // Pagination
            const totalPages = Math.ceil(announcements.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageAnnouncements = announcements.slice(startIndex, endIndex);

            // Clear table
            tableBody.innerHTML = '';

            // Add rows
            pageAnnouncements.forEach(ann => {
                const date = new Date(ann.createdAt);
                const formattedDate = date.toLocaleDateString() + ' ' +
                    date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                // Status badge
                let statusClass, statusText;
                switch (ann.status) {
                    case 'active': statusClass = 'status-active'; statusText = 'Active'; break;
                    case 'scheduled': statusClass = 'status-scheduled'; statusText = 'Scheduled'; break;
                    case 'expired': statusClass = 'status-expired'; statusText = 'Expired'; break;
                    case 'archived': statusClass = 'status-archived'; statusText = 'Archived'; break;
                    default: statusClass = ''; statusText = ann.status;
                }

                // Type badge
                const typeClass = 'type-' + ann.type;
                const typeText = ann.type.charAt(0).toUpperCase() + ann.type.slice(1);

                const row = `
            <tr>
                <td>
                    <strong>${ann.title}</strong>
                    ${ann.important ? ' <i class="fas fa-star" style="color: #ffc107;"></i>' : ''}
                </td>
                <td><span class="type-badge ${typeClass}">${typeText}</span></td>
                <td>${ann.audience}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>${formattedDate}</td>
                <td>${ann.views || 0}</td>
                <td>
                    <div class="table-actions">
                        <button class="table-btn btn-view" onclick="viewAnnouncementDetails('${ann.id}')" 
                                title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="table-btn btn-edit" onclick="editAnnouncement('${ann.id}')" 
                                title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="table-btn btn-copy" onclick="duplicateAnnouncement('${ann.id}')" 
                                title="Duplicate">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="table-btn btn-delete" onclick="deleteAnnouncement('${ann.id}')" 
                                title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });

            // Add pagination
            if (totalPages > 1) {
                let paginationHTML = '<div class="pagination">';

                // Previous button
                if (currentPage > 1) {
                    paginationHTML += `<button class="page-btn" onclick="changeAnnouncementPage(${currentPage - 1})">‚Üê</button>`;
                }

                // Page numbers
                for (let i = 1; i <= totalPages; i++) {
                    if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                        paginationHTML += `<button class="page-btn ${i === currentPage ? 'active' : ''}" 
                                        onclick="changeAnnouncementPage(${i})">${i}</button>`;
                    } else if (i === currentPage - 3 || i === currentPage + 3) {
                        paginationHTML += `<span style="padding: 5px 10px;">...</span>`;
                    }
                }

                // Next button
                if (currentPage < totalPages) {
                    paginationHTML += `<button class="page-btn" onclick="changeAnnouncementPage(${currentPage + 1})">‚Üí</button>`;
                }

                paginationHTML += '</div>';

                const paginationDiv = document.getElementById('announcementsPagination');
                paginationDiv.innerHTML = paginationHTML;
                paginationDiv.style.display = 'block';
            } else {
                document.getElementById('announcementsPagination').style.display = 'none';
            }
        }

        // Change page
        function changeAnnouncementPage(page) {
            currentPage = page;
            filterAnnouncements();
        }

        // View announcement details
        function viewAnnouncementDetails(announcementId) {
            db.ref('announcements/' + announcementId).once('value')
                .then(snapshot => {
                    const ann = snapshot.val();
                    if (ann) {
                        const date = new Date(ann.createdAt);
                        const expiryDate = ann.expiry ? new Date(ann.expiry) : null;

                        const details = `
                    <div style="padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <h4 style="color: #004080; margin-bottom: 15px;">${ann.title}</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <strong>Type:</strong><br>
                                <span class="type-badge type-${ann.type}">${ann.type.toUpperCase()}</span>
                            </div>
                            <div>
                                <strong>Audience:</strong><br>
                                ${ann.audience}
                            </div>
                            <div>
                                <strong>Status:</strong><br>
                                <span class="status-badge status-${ann.status}">${ann.status.toUpperCase()}</span>
                            </div>
                            <div>
                                <strong>Views:</strong><br>
                                ${ann.views || 0}
                            </div>
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <strong>Message:</strong><br>
                            <div style="background: white; padding: 15px; border-radius: 6px; margin-top: 5px;">
                                ${ann.message.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <strong>Additional Info:</strong><br>
                            <div style="font-size: 0.9em; color: #666;">
                                Created: ${date.toLocaleString()}<br>
                                ${expiryDate ? `Expires: ${expiryDate.toLocaleString()}<br>` : ''}
                                ${ann.link ? `Link: <a href="${ann.link}" target="_blank">${ann.link}</a><br>` : ''}
                                ${ann.important ? '<span style="color: #ffc107;"><i class="fas fa-star"></i> Marked as Important</span><br>' : ''}
                            </div>
                        </div>
                    </div>
                `;

                        alertModal('Announcement Details', details);
                    }
                });
        }

        // Edit announcement
        function editAnnouncement(announcementId) {
            db.ref('announcements/' + announcementId).once('value')
                .then(snapshot => {
                    const ann = snapshot.val();
                    if (ann) {
                        const expiryDate = ann.expiry ? new Date(ann.expiry).toISOString().slice(0, 16) : '';
                        const scheduleDate = ann.schedule ? new Date(ann.schedule).toISOString().slice(0, 16) : '';

                        const editForm = `
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="editTitle" class="form-control" value="${ann.title}">
                    </div>
                    
                    <div class="form-group">
                        <label>Message</label>
                        <textarea id="editMessage" class="form-control" rows="4">${ann.message}</textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label>Type</label>
                            <select id="editType" class="form-control">
                                <option value="info" ${ann.type === 'info' ? 'selected' : ''}>Information</option>
                                <option value="warning" ${ann.type === 'warning' ? 'selected' : ''}>Warning</option>
                                <option value="important" ${ann.type === 'important' ? 'selected' : ''}>Important</option>
                                <option value="urgent" ${ann.type === 'urgent' ? 'selected' : ''}>Urgent</option>
                                <option value="event" ${ann.type === 'event' ? 'selected' : ''}>Event</option>
                                <option value="success" ${ann.type === 'success' ? 'selected' : ''}>Success</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Audience</label>
                            <select id="editAudience" class="form-control">
                                <option value="all" ${ann.audience === 'all' ? 'selected' : ''}>All Students</option>
                                <option value="year2" ${ann.audience === 'year2' ? 'selected' : ''}>Year 2 Only</option>
                                <option value="bsc-eee" ${ann.audience === 'bsc-eee' ? 'selected' : ''}>BSC EEE Only</option>
                                <option value="faculty" ${ann.audience === 'faculty' ? 'selected' : ''}>Faculty</option>
                                <option value="admins" ${ann.audience === 'admins' ? 'selected' : ''}>Admins Only</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label>Expiry Date (Optional)</label>
                            <input type="datetime-local" id="editExpiry" class="form-control" value="${expiryDate}">
                        </div>
                        
                        <div class="form-group">
                            <label>Link (Optional)</label>
                            <input type="url" id="editLink" class="form-control" value="${ann.link || ''}">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Options</label>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editImportant" ${ann.important ? 'checked' : ''}>
                                <label class="form-check-label" for="editImportant">
                                    Mark as Important
                                </label>
                            </div>
                            
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editShowOnWebsite" ${ann.showOnWebsite !== false ? 'checked' : ''}>
                                <label class="form-check-label" for="editShowOnWebsite">
                                    Show on Website
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn btn-secondary" onclick="closeEditModal()" style="margin-right: 10px;">
                            Cancel
                        </button>
                        <button class="btn" onclick="saveAnnouncementChanges('${announcementId}')" 
                                style="background: #28a745;">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                `;

                        document.getElementById('editModalTitle').textContent = 'Edit Announcement';
                        document.getElementById('editAnnouncementForm').innerHTML = editForm;
                        document.getElementById('editAnnouncementModal').style.display = 'block';
                    }
                });
        }

        // Save announcement changes
        function saveAnnouncementChanges(announcementId) {
            const title = document.getElementById('editTitle').value.trim();
            const message = document.getElementById('editMessage').value.trim();
            const type = document.getElementById('editType').value;
            const audience = document.getElementById('editAudience').value;
            const expiry = document.getElementById('editExpiry').value;
            const link = document.getElementById('editLink').value.trim();
            const important = document.getElementById('editImportant').checked;
            const showOnWebsite = document.getElementById('editShowOnWebsite').checked;

            if (!title || !message) {
                alert('Please fill in both title and message');
                return;
            }

            const updateData = {
                title: title,
                message: message,
                type: type,
                audience: audience,
                important: important,
                showOnWebsite: showOnWebsite,
                link: link || null,
                expiry: expiry || null,
                updatedAt: new Date().toISOString()
            };

            db.ref('announcements/' + announcementId).update(updateData)
                .then(() => {
                    alert('‚úÖ Announcement updated successfully!');
                    closeEditModal();
                    loadAnnouncements();
                })
                .catch(error => {
                    console.error('Error updating announcement:', error);
                    alert('‚ùå Error updating announcement: ' + error.message);
                });
        }

        // Duplicate announcement
        function duplicateAnnouncement(announcementId) {
            if (confirm('Duplicate this announcement?')) {
                db.ref('announcements/' + announcementId).once('value')
                    .then(snapshot => {
                        const ann = snapshot.val();
                        if (ann) {
                            const newId = 'ann_' + Date.now() + '_copy';
                            const newAnnouncement = {
                                ...ann,
                                title: ann.title + ' (Copy)',
                                createdAt: new Date().toISOString(),
                                status: 'active',
                                views: 0,
                                acknowledgedBy: []
                            };

                            db.ref('announcements/' + newId).set(newAnnouncement)
                                .then(() => {
                                    alert('‚úÖ Announcement duplicated successfully!');
                                    loadAnnouncements();
                                });
                        }
                    });
            }
        }

        // Delete announcement
        function deleteAnnouncement(announcementId) {
            if (confirm('Are you sure you want to delete this announcement? This action cannot be undone.')) {
                db.ref('announcements/' + announcementId).remove()
                    .then(() => {
                        alert('‚úÖ Announcement deleted successfully!');
                        loadAnnouncements();
                    })
                    .catch(error => {
                        console.error('Error deleting announcement:', error);
                        alert('‚ùå Error deleting announcement: ' + error.message);
                    });
            }
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editAnnouncementModal').style.display = 'none';
        }

        // Update active count badge
        function updateActiveCount(count) {
            const badge = document.getElementById('activeCountBadge');
            if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? 'inline-block' : 'none';
            }
        }

        // Load announcement history
        function loadAnnouncementHistory() {
            const tableBody = document.getElementById('historyTableBody');
            // Implementation similar to loadAnnouncements but filtered for archived/expired
        }

        // Load announcement settings
        function loadAnnouncementSettings() {
            db.ref('announcementSettings').once('value')
                .then(snapshot => {
                    const settings = snapshot.val();
                    if (settings) {
                        // Populate settings form
                    }
                });
        }

        // Save announcement settings
        function saveAnnouncementSettings() {
            const settings = {
                defaultDuration: document.getElementById('defaultDuration').value,
                maxActive: document.getElementById('maxActiveAnnouncements').value,
                autoArchive: document.getElementById('autoArchiveDays').value,
                enablePush: document.getElementById('enablePushNotifications').checked,
                enableEmail: document.getElementById('enableEmailNotifications').checked,
                enableSound: document.getElementById('enableSound').checked,
                defaultAudience: document.getElementById('defaultAudience').value,
                updatedAt: new Date().toISOString()
            };

            db.ref('announcementSettings').set(settings)
                .then(() => {
                    alert('‚úÖ Settings saved successfully!');
                });
        }

        // Reset settings to defaults
        function resetAnnouncementSettings() {
            if (confirm('Reset all announcement settings to defaults?')) {
                const defaults = {
                    defaultDuration: '14',
                    maxActive: '5',
                    autoArchive: '30',
                    enablePush: true,
                    enableEmail: false,
                    enableSound: true,
                    defaultAudience: 'all'
                };

                db.ref('announcementSettings').set(defaults)
                    .then(() => {
                        loadAnnouncementSettings();
                        alert('‚úÖ Settings reset to defaults!');
                    });
            }
        }

        // Export announcements to CSV
        function exportAnnouncements() {
            db.ref('announcements').once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    if (!data) {
                        alert('No announcements to export');
                        return;
                    }

                    // Convert to CSV
                    const announcements = Object.keys(data).map(key => ({
                        id: key,
                        ...data[key]
                    }));

                    const csvContent = convertAnnouncementsToCSV(announcements);
                    downloadCSV(csvContent, 'announcements_export.csv');
                    alert('‚úÖ Announcements exported successfully!');
                });
        }

        function convertAnnouncementsToCSV(announcements) {
            const headers = ['Title', 'Type', 'Audience', 'Status', 'Created', 'Expiry', 'Views', 'Message'];
            const rows = announcements.map(ann => [
                `"${ann.title}"`,
                ann.type,
                ann.audience,
                ann.status,
                new Date(ann.createdAt).toLocaleString(),
                ann.expiry ? new Date(ann.expiry).toLocaleString() : '',
                ann.views || 0,
                `"${ann.message.replace(/"/g, '""').replace(/\n/g, ' ')}"`
            ]);

            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Alert modal helper
        function alertModal(title, content) {
            const modalHTML = `
        <div id="alertModal" class="modal" style="display: flex;">
            <div class="modal-content" style="max-width: 600px;">
                <span class="closeBtn" onclick="document.getElementById('alertModal').style.display='none'">&times;</span>
                <h3>${title}</h3>
                ${content}
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn" onclick="document.getElementById('alertModal').style.display='none'">
                        Close
                    </button>
                </div>
            </div>
        </div>
    `;

            // Remove existing modal
            const existingModal = document.getElementById('alertModal');
            if (existingModal) existingModal.remove();

            // Add new modal
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Log activity
        function logActivity(action, data) {
            const logData = {
                action: action,
                data: data,
                userId: auth.currentUser.uid,
                timestamp: new Date().toISOString(),
                ip: 'admin-dashboard' // In real app, you'd get actual IP
            };

            const logId = 'log_' + Date.now();
            db.ref('activityLogs/' + logId).set(logData);
        }









        // ===== COURSE REGISTRATION ISSUES - COMPLETE WORKING SOLUTION =====

        // Global variables
        let allCourseIssues = [];
        let currentCourseIssuesTab = 'pending';

        // Tab handler for course issues
        function handleCourseIssuesTab(tabName) {
            console.log('Switching to course issues tab:', tabName);
            currentCourseIssuesTab = tabName;

            // Update tab buttons
            const tabs = document.querySelectorAll('#courseRegistrationIssuesTab .tabs .tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });

            // Find and activate the clicked tab
            const clickedTab = event.target.closest('.tab');
            if (clickedTab) {
                clickedTab.classList.add('active');
            }

            // Hide all tab contents
            ['pending', 'resolved', 'all'].forEach(tab => {
                const tabContent = document.getElementById(tab + 'CourseIssuesTab');
                if (tabContent) {
                    tabContent.style.display = 'none';
                }
            });

            // Show selected tab
            const selectedTab = document.getElementById(tabName + 'CourseIssuesTab');
            if (selectedTab) {
                selectedTab.style.display = 'block';
            }

            // If no data loaded yet, load it
            if (allCourseIssues.length === 0) {
                loadCourseRegistrationIssues();
            }
        }

        // Load all course registration issues
        function loadCourseRegistrationIssues() {
            console.log('Loading course registration issues...');

            const pendingBody = document.getElementById('coursePendingIssuesBody');
            const resolvedBody = document.getElementById('courseResolvedIssuesBody');
            const allBody = document.getElementById('courseAllIssuesBody');

            // Show loading state
            if (pendingBody) pendingBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px;"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
            if (resolvedBody) resolvedBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px;"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
            if (allBody) allBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px;"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';

            db.ref('course_registration_issues').once('value').then(snapshot => {
                const data = snapshot.val();
                allCourseIssues = [];

                if (!data) {
                    const noDataMsg = '<tr><td colspan="7" style="text-align: center; padding: 30px;">No course registration issues found.</td></tr>';
                    if (pendingBody) pendingBody.innerHTML = noDataMsg;
                    if (resolvedBody) resolvedBody.innerHTML = noDataMsg;
                    if (allBody) allBody.innerHTML = noDataMsg;
                    updatePendingCount(0);
                    return;
                }

                // Collect all issues
                for (const year in data) {
                    const yearIssues = data[year];
                    for (const issueId in yearIssues) {
                        const issue = yearIssues[issueId];
                        allCourseIssues.push({
                            ...issue,
                            id: issueId,
                            year: year,
                            timestamp: parseInt(issueId)
                        });
                    }
                }

                // Sort by date (newest first)
                allCourseIssues.sort((a, b) => b.timestamp - a.timestamp);

                // Update pending count
                const pendingCount = allCourseIssues.filter(issue => !issue.resolved).length;
                updatePendingCount(pendingCount);

                // Display issues
                displayCourseIssues();

                // Show correct tab
                setTimeout(() => {
                    const currentTab = document.querySelector('#courseRegistrationIssuesTab .tabs .tab.active');
                    if (!currentTab) {
                        handleCourseIssuesTab('pending');
                    }
                }, 100);

            }).catch(error => {
                console.error('Error loading course issues:', error);
                const errorMsg = '<tr><td colspan="7" style="text-align: center; color: red; padding: 30px;">Error loading issues: ' + error.message + '</td></tr>';
                if (pendingBody) pendingBody.innerHTML = errorMsg;
                if (resolvedBody) resolvedBody.innerHTML = errorMsg;
                if (allBody) allBody.innerHTML = errorMsg;
            });
        }

        // Display issues in tables
        function displayCourseIssues() {
            const pendingIssues = allCourseIssues.filter(issue => !issue.resolved);
            const resolvedIssues = allCourseIssues.filter(issue => issue.resolved);

            // Display pending issues
            const pendingBody = document.getElementById('coursePendingIssuesBody');
            if (pendingBody) {
                if (pendingIssues.length === 0) {
                    pendingBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px;">No pending issues found.</td></tr>';
                } else {
                    let html = '';
                    pendingIssues.forEach(issue => {
                        const date = new Date(issue.submittedAt);
                        const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                        const hasScreenshot = issue.screenshot ?
                            ' <i class="fas fa-camera" style="color: #17a2b8;" title="Has screenshot"></i>' : '';

                        html += `
                <tr>
                    <td>${formattedDate}</td>
                    <td><strong>${issue.name}</strong></td>
                    <td><code>${issue.regNumber}</code>${hasScreenshot}</td>
                    <td>${issue.issueType.replace(/_/g, ' ')}</td>
                    <td>${issue.year}</td>
                    <td><span style="background: #f8d7da; color: #721c24; padding: 3px 8px; border-radius: 4px; font-size: 0.9em;">Pending</span></td>
                    <td>
                        <div class="table-actions">
                            <button class="table-btn btn-view" onclick="showIssueDetails('${issue.year}', '${issue.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="table-btn btn-edit" onclick="markIssueResolved('${issue.year}', '${issue.id}')" title="Mark Resolved">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="table-btn btn-delete" onclick="deleteCourseIssue('${issue.year}', '${issue.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                `;
                    });
                    pendingBody.innerHTML = html;
                }
            }

            // Display resolved issues
            const resolvedBody = document.getElementById('courseResolvedIssuesBody');
            if (resolvedBody) {
                if (resolvedIssues.length === 0) {
                    resolvedBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px;">No resolved issues found.</td></tr>';
                } else {
                    let html = '';
                    resolvedIssues.forEach(issue => {
                        const date = new Date(issue.submittedAt);
                        const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        const resolvedDate = issue.resolvedAt ? new Date(issue.resolvedAt).toLocaleString() : 'Unknown';

                        html += `
                <tr>
                    <td>${formattedDate}</td>
                    <td><strong>${issue.name}</strong></td>
                    <td><code>${issue.regNumber}</code></td>
                    <td>${issue.issueType.replace(/_/g, ' ')}</td>
                    <td>${issue.resolvedBy || 'Admin'}</td>
                    <td>${resolvedDate}</td>
                    <td>
                        <div class="table-actions">
                            <button class="table-btn btn-view" onclick="showIssueDetails('${issue.year}', '${issue.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="table-btn btn-delete" onclick="deleteCourseIssue('${issue.year}', '${issue.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                `;
                    });
                    resolvedBody.innerHTML = html;
                }
            }

            // Display all issues
            const allBody = document.getElementById('courseAllIssuesBody');
            if (allBody) {
                if (allCourseIssues.length === 0) {
                    allBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px;">No issues found.</td></tr>';
                } else {
                    let html = '';
                    allCourseIssues.forEach(issue => {
                        const date = new Date(issue.submittedAt);
                        const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                        const statusClass = issue.resolved ? 'status-active' : 'status-expired';
                        const statusText = issue.resolved ? 'Resolved' : 'Pending';

                        html += `
                <tr>
                    <td>${formattedDate}</td>
                    <td><strong>${issue.name}</strong></td>
                    <td><code>${issue.regNumber}</code></td>
                    <td>${issue.issueType.replace(/_/g, ' ')}</td>
                    <td>${issue.year}</td>
                    <td><span style="background: ${issue.resolved ? '#d4edda' : '#f8d7da'}; color: ${issue.resolved ? '#155724' : '#721c24'}; padding: 3px 8px; border-radius: 4px; font-size: 0.9em;">${statusText}</span></td>
                    <td>
                        <div class="table-actions">
                            <button class="table-btn btn-view" onclick="showIssueDetails('${issue.year}', '${issue.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="table-btn btn-delete" onclick="deleteCourseIssue('${issue.year}', '${issue.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                `;
                    });
                    allBody.innerHTML = html;
                }
            }
        }

        // Show issue details in modal
        function showIssueDetails(year, issueId) {
            console.log('Showing details:', year, issueId);

            const issue = allCourseIssues.find(i => i.year === year && i.id === issueId);
            if (!issue) {
                alert('Issue not found');
                return;
            }

            const date = new Date(issue.submittedAt);
            const formattedDate = date.toLocaleString();
            const resolvedDate = issue.resolvedAt ? new Date(issue.resolvedAt).toLocaleString() : 'Not resolved';

            // Screenshot HTML
            let screenshotHTML = '';
            if (issue.screenshot) {
                screenshotHTML = `
            <div style="margin: 15px 0;">
                <strong>Screenshot:</strong><br>
                <div style="position: relative; display: inline-block;">
                    <img src="${issue.screenshot}" alt="Screenshot" 
                         style="max-width: 300px; max-height: 200px; border: 1px solid #ddd; border-radius: 5px; margin-top: 10px; cursor: pointer;"
                         onclick="window.open('${issue.screenshot}', '_blank')">
                    <div style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 3px; font-size: 12px;">
                        <i class="fas fa-expand"></i> Click to view
                    </div>
                </div>
            </div>
        `;
            }

            // Create modal HTML
            const modalHTML = `
        <div id="courseIssueModal" style="display: block; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7);">
            <div style="background: white; padding: 30px; border-radius: 10px; max-width: 700px; margin: 50px auto; position: relative; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-height: 80vh; overflow-y: auto;">
                <span onclick="closeIssueModal()" style="position: absolute; top: 15px; right: 25px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                <h3 style="color: #004080; margin-bottom: 20px;">Course Issue Details</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div>
                        <strong>Student Name:</strong><br>
                        ${issue.name}
                    </div>
                    <div>
                        <strong>Registration No:</strong><br>
                        <code>${issue.regNumber}</code>
                    </div>
                    <div>
                        <strong>Year:</strong><br>
                        ${issue.year}
                    </div>
                    <div>
                        <strong>Issue Type:</strong><br>
                        ${issue.issueType.replace(/_/g, ' ')}
                    </div>
                    <div>
                        <strong>Submitted:</strong><br>
                        ${formattedDate}
                    </div>
                    <div>
                        <strong>Status:</strong><br>
                        <span style="background: ${issue.resolved ? '#d4edda' : '#f8d7da'}; color: ${issue.resolved ? '#155724' : '#721c24'}; padding: 3px 8px; border-radius: 4px; font-weight: 600;">
                            ${issue.resolved ? 'Resolved' : 'Pending'}
                        </span>
                    </div>
                </div>
                
                <div style="margin: 15px 0;">
                    <strong>Issue Description:</strong><br>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 5px; white-space: pre-wrap; max-height: 200px; overflow-y: auto;">
                        ${issue.explanation || 'No description provided'}
                    </div>
                </div>
                
                ${screenshotHTML}
                
                <div style="margin: 15px 0;">
                    <strong>Contact Information:</strong><br>
                    <div style="color: #666; font-size: 0.9em;">
                        ${issue.contactEmail ? `Email: ${issue.contactEmail}<br>` : ''}
                        ${issue.contactPhone ? `Phone: ${issue.contactPhone}` : ''}
                    </div>
                </div>
                
                ${issue.resolved ? `
                    <div style="margin: 20px 0; padding: 15px; background: #d4edda; border-radius: 6px; border-left: 4px solid #28a745;">
                        <strong>Resolution Details:</strong><br>
                        <div>Resolved by: ${issue.resolvedBy || 'Admin'}</div>
                        <div>Resolved on: ${resolvedDate}</div>
                        ${issue.resolutionNotes ? `<div>Notes: ${issue.resolutionNotes}</div>` : ''}
                    </div>
                ` : ''}
                
                <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee; text-align: center;">
                    ${!issue.resolved ? `
                        <button onclick="markIssueResolved('${year}', '${issue.id}')" 
                                style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            <i class="fas fa-check"></i> Mark as Resolved
                        </button>
                    ` : ''}
                    <button onclick="deleteCourseIssue('${year}', '${issue.id}')" 
                            style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                        <i class="fas fa-trash"></i> Delete Issue
                    </button>
                    <button onclick="closeIssueModal()" 
                            style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
        </div>
    `;

            // Remove existing modal if any
            const existingModal = document.getElementById('courseIssueModal');
            if (existingModal) existingModal.remove();

            // Add new modal
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Close modal
        function closeIssueModal() {
            const modal = document.getElementById('courseIssueModal');
            if (modal) modal.remove();
        }

        // Mark issue as resolved
        function markIssueResolved(year, issueId) {
            const resolutionNotes = prompt('Enter resolution notes (optional):');
            if (resolutionNotes === null) return; // User cancelled

            const adminName = document.getElementById('adminName')?.textContent?.replace('Welcome, ', '') || 'Admin';

            const updates = {
                resolved: true,
                resolvedBy: adminName,
                resolvedAt: new Date().toISOString(),
                resolutionNotes: resolutionNotes || null
            };

            db.ref(`course_registration_issues/${year}/${issueId}`).update(updates)
                .then(() => {
                    alert('‚úÖ Issue marked as resolved!');
                    closeIssueModal();
                    loadCourseRegistrationIssues();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('‚ùå Error: ' + error.message);
                });
        }

        // Delete issue
        function deleteCourseIssue(year, issueId) {
            if (confirm('Are you sure you want to delete this course registration issue?\nThis action cannot be undone.')) {
                db.ref(`course_registration_issues/${year}/${issueId}`).remove()
                    .then(() => {
                        alert('‚úÖ Issue deleted successfully!');
                        closeIssueModal();
                        loadCourseRegistrationIssues();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('‚ùå Error deleting issue: ' + error.message);
                    });
            }
        }

        // Update pending count
        function updatePendingCount(count) {
            const badge = document.getElementById('pendingIssuesCount');
            if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? 'inline-block' : 'none';
            }
        }

        // Export issues
        function exportCourseIssues() {
            if (allCourseIssues.length === 0) {
                alert('No course issues to export.');
                return;
            }

            // Prepare data
            const exportData = allCourseIssues.map(issue => ({
                'Date': new Date(issue.submittedAt).toLocaleString(),
                'Name': issue.name,
                'Registration Number': issue.regNumber,
                'Year': issue.year,
                'Issue Type': issue.issueType.replace(/_/g, ' '),
                'Description': issue.explanation,
                'Contact Email': issue.contactEmail || '',
                'Contact Phone': issue.contactPhone || '',
                'Status': issue.resolved ? 'Resolved' : 'Pending',
                'Resolved By': issue.resolvedBy || '',
                'Resolved Date': issue.resolvedAt ? new Date(issue.resolvedAt).toLocaleString() : '',
                'Resolution Notes': issue.resolutionNotes || ''
            }));

            // Create Excel workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);

            // Set column widths
            const wscols = [
                { wch: 20 }, { wch: 25 }, { wch: 20 }, { wch: 10 },
                { wch: 20 }, { wch: 50 }, { wch: 30 }, { wch: 15 },
                { wch: 15 }, { wch: 20 }, { wch: 20 }, { wch: 50 }
            ];
            ws['!cols'] = wscols;

            // Add worksheet
            XLSX.utils.book_append_sheet(wb, ws, 'Course Issues');

            // Generate filename
            const timestamp = new Date().toISOString().split('T')[0];
            const filename = `Course_Issues_${timestamp}.xlsx`;

            // Export
            XLSX.writeFile(wb, filename);

            alert(`‚úÖ Exported ${exportData.length} issues to ${filename}`);
        }

        // Refresh issues
        function refreshCourseIssues() {
            loadCourseRegistrationIssues();
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Course registration module loaded');

            // Make sure functions are available globally
            window.handleCourseIssuesTab = handleCourseIssuesTab;
            window.showIssueDetails = showIssueDetails;
            window.closeIssueModal = closeIssueModal;
            window.markIssueResolved = markIssueResolved;
            window.deleteCourseIssue = deleteCourseIssue;
            window.exportCourseIssues = exportCourseIssues;
            window.refreshCourseIssues = refreshCourseIssues;

            // Auto-load when complaints section is shown
            document.addEventListener('click', function (e) {
                if (e.target.closest('[onclick*="courseRegistrationIssues"]')) {
                    setTimeout(loadCourseRegistrationIssues, 500);
                }
            });
        });








        // ===== PRACTICAL HUB SECTION - COMPLETE WORKING VERSION =====

        // Global variables for Practical Hub
        let currentImageFile = null;
        let currentImageUrl = '';
        let currentProductId = null;

        // Show hub tab
        function showHubTab(tabName) {
            console.log('Showing tab:', tabName);

            // Update tabs
            document.querySelectorAll('#practicalHubSection .tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.querySelectorAll('#practicalHubSection .tab-content').forEach(content => {
                content.style.display = 'none';
            });

            // Activate clicked tab
            event.target.classList.add('active');

            // Show corresponding content
            const targetTab = document.getElementById(tabName + 'HubTab');
            if (targetTab) {
                targetTab.style.display = 'block';
            }

            // Load data based on tab
            if (tabName === 'products') {
                loadPracticalHubProducts();
            } else if (tabName === 'orders') {
                loadPracticalHubOrders();
            }
        }

        // Load products
        function loadPracticalHubProducts() {
            const tableBody = document.getElementById('productsTableBody');
            if (!tableBody) return;

            tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px;"><i class="fas fa-spinner fa-spin"></i> Loading products...</td></tr>';

            db.ref('practicalHub/products').once('value').then((snapshot) => {
                const data = snapshot.val();

                if (!data) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px;">No products found. Add your first product!</td></tr>';
                    return;
                }

                // Convert to array
                const productsArray = Object.keys(data).map(key => ({
                    id: key,
                    ...data[key]
                }));

                displayPracticalHubProductsTable(productsArray);
            }).catch((error) => {
                console.error('Error loading products:', error);
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: red;">Error loading products: ' + error.message + '</td></tr>';
            });
        }

        // Display products table
        function displayPracticalHubProductsTable(products) {
            const tableBody = document.getElementById('productsTableBody');
            if (!tableBody) return;

            tableBody.innerHTML = '';

            if (products.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px;">No products found.</td></tr>';
                return;
            }

            products.forEach(product => {
                const statusClass = product.stock > 10 ? 'status-active' :
                    product.stock > 0 ? 'status-scheduled' : 'status-expired';
                const statusText = product.stock > 10 ? 'In Stock' :
                    product.stock > 0 ? 'Low Stock' : 'Out of Stock';

                // Use product image or placeholder
                const imageUrl = product.image || 'https://via.placeholder.com/50x50?text=No+Image';

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>
                <img src="${imageUrl}" 
                     style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;" 
                     onerror="this.onerror=null; this.src='https://via.placeholder.com/50x50?text=Error'"
                     alt="${product.name}">
            </td>
            <td><strong>${product.name}</strong></td>
            <td><span style="background: #e3f2fd; padding: 3px 8px; border-radius: 4px;">${getCategoryName(product.category)}</span></td>
            <td>Ksh ${(product.price || 0).toLocaleString()}</td>
            <td>${product.stock || 0}</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>
                <div class="table-actions">
                    <button class="table-btn btn-edit" onclick="editPracticalHubProduct('${product.id}')" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="table-btn btn-delete" onclick="deletePracticalHubProduct('${product.id}')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
                tableBody.appendChild(row);
            });
        }

        // Helper function to get category display name
        function getCategoryName(categoryKey) {
            const categories = {
                'arduino': 'Arduino Kits',
                '555': 'mini projects kit',
                'components': 'Individual Components',
                'tools': 'Tools & Accessories',
                'other': 'Other'
            };
            return categories[categoryKey] || categoryKey;
        }

        // Add new product with image upload
        function addNewProduct() {
            // Reset variables
            currentImageFile = null;
            currentImageUrl = '';
            currentProductId = null;

            const formHTML = `
        <div class="form-group">
            <label>Product Name *</label>
            <input type="text" id="phProductName" class="form-control" placeholder="e.g., Arduino Starter Kit">
        </div>
        
        <div class="form-group">
            <label>Category *</label>
            <select id="phProductCategory" class="form-control">
                <option value="arduino">Arduino Kits</option>
                <option value="555">mini projects kit</option>
                <option value="components">Individual Components</option>
                <option value="tools">Tools & Accessories</option>
                <option value="other">Other</option>
            </select>
        </div>
        
        <div class="form-row" style="display: flex; gap: 15px; margin-bottom: 15px;">
            <div class="form-group" style="flex: 1;">
                <label>Price (Ksh) *</label>
                <input type="number" id="phProductPrice" class="form-control" placeholder="0" min="0" step="10">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>Initial Stock *</label>
                <input type="number" id="phProductStock" class="form-control" placeholder="0" min="0">
            </div>
        </div>
        
        <div class="form-group">
            <label>Description *</label>
            <textarea id="phProductDescription" class="form-control" rows="3" placeholder="Brief product description"></textarea>
        </div>
        
        <div class="form-group">
            <label>Full Details (Optional)</label>
            <textarea id="phProductDetails" class="form-control" rows="5" placeholder="Detailed description, includes, specifications..."></textarea>
        </div>
        
        <!-- IMAGE UPLOAD SECTION -->
        <div class="form-group">
            <label>Product Image *</label>
            <div style="border: 2px dashed #004080; padding: 20px; text-align: center; border-radius: 8px; margin-bottom: 10px; cursor: pointer;" 
                 onclick="document.getElementById('phImageUpload').click()"
                 id="imageUploadArea">
                <i class="fas fa-cloud-upload-alt fa-2x" style="color: #004080; margin-bottom: 10px;"></i><br>
                <span style="color: #004080; font-weight: 500;">Click to upload image</span>
                <p style="margin-top: 10px; font-size: 0.9em; color: #666;">JPG, PNG, or GIF ‚Ä¢ Max 5MB</p>
            </div>
            <input type="file" id="phImageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
            
            <div id="imagePreviewContainer" style="display: none; margin-top: 15px;">
                <div style="position: relative; display: inline-block;">
                    <img id="imagePreview" style="max-width: 200px; max-height: 200px; border-radius: 5px; border: 1px solid #ddd;">
                    <button type="button" class="btn btn-secondary" onclick="removeUploadedImage()" 
                            style="position: absolute; top: 5px; right: 5px; padding: 2px 8px; font-size: 12px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="uploadProgress" style="margin-top: 10px; display: none;">
                    <div style="background: #f0f0f0; border-radius: 10px; height: 10px; overflow: hidden;">
                        <div id="progressBar" style="background: #004080; height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div id="progressText" style="text-align: center; margin-top: 5px; font-size: 0.9em;"></div>
                </div>
            </div>
        </div>
        
        <div style="margin-top: 20px; text-align: right;">
            <button class="btn btn-secondary" onclick="closeProductEditor()">Cancel</button>
            <button class="btn" onclick="savePracticalHubProductWithImage()" style="background: #28a745;">
                <i class="fas fa-save"></i> Save Product
            </button>
        </div>
    `;

            document.getElementById('productModalTitle').textContent = 'Add New Product';
            document.getElementById('productEditorForm').innerHTML = formHTML;
            document.getElementById('productEditorModal').style.display = 'block';
        }

        // Handle image upload - SIMPLE VERSION
        function handleImageUpload(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];

            // Validate file type
            if (!file.type.match('image.*')) {
                alert('Please select an image file (JPG, PNG, or GIF)');
                return;
            }

            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image size should be less than 5MB');
                return;
            }

            currentImageFile = file;

            // Show preview
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('imagePreviewContainer').style.display = 'block';
                document.getElementById('uploadProgress').style.display = 'block';

                // Update upload area text
                document.getElementById('imageUploadArea').innerHTML = `
            <i class="fas fa-check-circle fa-2x" style="color: #28a745; margin-bottom: 10px;"></i><br>
            <span style="color: #28a745; font-weight: 500;">Image selected</span>
            <p style="margin-top: 10px; font-size: 0.9em; color: #666;">${file.name} (${(file.size / 1024).toFixed(1)}KB)</p>
        `;

                // Start SIMPLE upload - no Firebase Storage, just Base64
                uploadImageToStorage(file);
            };
            reader.readAsDataURL(file);
        }

        // Upload image using Base64
        function uploadImageToStorage(file) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            console.log('Starting Base64 conversion for file:', file.name);

            // Simple progress simulation
            let progress = 0;
            const interval = setInterval(() => {
                progress += 20;
                if (progress > 80) progress = 80; // Cap at 80% for conversion

                progressBar.style.width = progress + '%';
                progressText.textContent = `Processing: ${progress}%`;

                if (progress >= 80) {
                    clearInterval(interval);

                    // Convert to Base64
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        // Store as Base64
                        currentImageUrl = e.target.result;

                        // Complete progress
                        progressBar.style.width = '100%';
                        progressBar.style.background = '#28a745';
                        progressText.innerHTML = '<span style="color: #28a745;"><i class="fas fa-check"></i> Image ready!</span>';

                        console.log('Base64 image stored, length:', currentImageUrl.length);
                    };
                    reader.readAsDataURL(file);
                }
            }, 100);
        }

        // Remove uploaded image
        function removeUploadedImage() {
            currentImageFile = null;
            currentImageUrl = '';

            // Reset preview
            document.getElementById('imagePreviewContainer').style.display = 'none';
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('phImageUpload').value = '';

            // Reset upload area
            document.getElementById('imageUploadArea').innerHTML = `
        <i class="fas fa-cloud-upload-alt fa-2x" style="color: #004080; margin-bottom: 10px;"></i><br>
        <span style="color: #004080; font-weight: 500;">Click to upload image</span>
        <p style="margin-top: 10px; font-size: 0.9em; color: #666;">JPG, PNG, or GIF ‚Ä¢ Max 5MB</p>
    `;
        }

        // Save product with image
        function savePracticalHubProductWithImage() {
            const name = document.getElementById('phProductName').value;
            const description = document.getElementById('phProductDescription').value;

            // Validate required fields
            if (!name || !description) {
                alert('Please fill in required fields (Product Name and Description)');
                return;
            }

            // Check if image was uploaded
            if (!currentImageUrl) {
                const proceed = confirm('No image uploaded. Save product without image?');
                if (!proceed) return;
            }

            // Prepare product data
            const productData = {
                name: name,
                category: document.getElementById('phProductCategory').value,
                price: parseInt(document.getElementById('phProductPrice').value) || 0,
                stock: parseInt(document.getElementById('phProductStock').value) || 0,
                description: description,
                details: document.getElementById('phProductDetails').value || '',
                image: currentImageUrl || '', // Base64 string
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            console.log('Saving product with image size:', productData.image ? productData.image.length : 0, 'chars');

            // Generate product ID
            const productId = 'prod_' + Date.now();

            // Save to Firebase Database
            db.ref('practicalHub/products/' + productId).set(productData)
                .then(function () {
                    alert('‚úÖ Product added successfully!');
                    closeProductEditor();
                    loadPracticalHubProducts();
                })
                .catch(function (error) {
                    console.error('Error saving product:', error);
                    alert('‚ùå Error saving product: ' + error.message);
                });
        }

        // Edit product
        function editPracticalHubProduct(productId) {
            currentProductId = productId;

            db.ref('practicalHub/products/' + productId).once('value').then((snapshot) => {
                const product = snapshot.val();
                if (!product) return;

                // Reset variables
                currentImageFile = null;
                currentImageUrl = product.image || '';

                const formHTML = `
            <div class="form-group">
                <label>Product Name *</label>
                <input type="text" id="phProductName" class="form-control" value="${product.name || ''}">
            </div>
            
            <div class="form-group">
                <label>Category *</label>
                <select id="phProductCategory" class="form-control">
                    <option value="arduino" ${product.category === 'arduino' ? 'selected' : ''}>Arduino Kits</option>
                    <option value="555" ${product.category === '555' ? 'selected' : ''}>mini projects kit</option>
                    <option value="components" ${product.category === 'components' ? 'selected' : ''}>Individual Components</option>
                    <option value="tools" ${product.category === 'tools' ? 'selected' : ''}>Tools & Accessories</option>
                    <option value="other" ${product.category === 'other' ? 'selected' : ''}>Other</option>
                </select>
            </div>
            
            <div class="form-row" style="display: flex; gap: 15px; margin-bottom: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label>Price (Ksh) *</label>
                    <input type="number" id="phProductPrice" class="form-control" value="${product.price || 0}">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Current Stock *</label>
                    <input type="number" id="phProductStock" class="form-control" value="${product.stock || 0}">
                </div>
            </div>
            
            <div class="form-group">
                <label>Description *</label>
                <textarea id="phProductDescription" class="form-control" rows="3">${product.description || ''}</textarea>
            </div>
            
            <div class="form-group">
                <label>Full Details (Optional)</label>
                <textarea id="phProductDetails" class="form-control" rows="5">${product.details || ''}</textarea>
            </div>
            
            <!-- IMAGE SECTION FOR EDIT -->
            <div class="form-group">
                <label>Product Image</label>
                
                ${product.image ? `
                    <div style="margin-bottom: 15px;">
                        <strong>Current Image:</strong><br>
                        <img src="${product.image}" style="max-width: 150px; max-height: 150px; border-radius: 5px; border: 1px solid #ddd; margin-top: 5px;"
                             onerror="this.onerror=null; this.src='https://via.placeholder.com/150x150?text=Image+Error'">
                    </div>
                ` : ''}
                
                <div style="border: 2px dashed #004080; padding: 20px; text-align: center; border-radius: 8px; margin-bottom: 10px; cursor: pointer;" 
                     onclick="document.getElementById('phImageUploadEdit').click()"
                     id="imageUploadAreaEdit">
                    <i class="fas fa-cloud-upload-alt fa-2x" style="color: #004080; margin-bottom: 10px;"></i><br>
                    <span style="color: #004080; font-weight: 500;">${product.image ? 'Change Image' : 'Upload Image'}</span>
                    <p style="margin-top: 10px; font-size: 0.9em; color: #666;">JPG, PNG, or GIF ‚Ä¢ Max 5MB</p>
                </div>
                <input type="file" id="phImageUploadEdit" accept="image/*" style="display: none;" onchange="handleImageUploadEdit(this)">
                
                <div id="imagePreviewContainerEdit" style="display: none; margin-top: 15px;">
                    <div style="position: relative; display: inline-block;">
                        <img id="imagePreviewEdit" style="max-width: 200px; max-height: 200px; border-radius: 5px; border: 1px solid #ddd;">
                        <button type="button" class="btn btn-secondary" onclick="removeUploadedImageEdit()" 
                                style="position: absolute; top: 5px; right: 5px; padding: 2px 8px; font-size: 12px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="uploadProgressEdit" style="margin-top: 10px; display: none;">
                        <div style="background: #f0f0f0; border-radius: 10px; height: 10px; overflow: hidden;">
                            <div id="progressBarEdit" style="background: #004080; height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <div id="progressTextEdit" style="text-align: center; margin-top: 5px; font-size: 0.9em;"></div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-secondary" onclick="closeProductEditor()">Cancel</button>
                <button class="btn" onclick="updatePracticalHubProductWithImage('${productId}')" style="background: #004080;">
                    <i class="fas fa-save"></i> Update Product
                </button>
            </div>
        `;

                document.getElementById('productModalTitle').textContent = 'Edit Product';
                document.getElementById('productEditorForm').innerHTML = formHTML;
                document.getElementById('productEditorModal').style.display = 'block';
            }).catch((error) => {
                console.error('Error loading product:', error);
                alert('Error loading product: ' + error.message);
            });
        }

        // Handle image upload for edit
        function handleImageUploadEdit(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];

            // Validate file type
            if (!file.type.match('image.*')) {
                alert('Please select an image file (JPG, PNG, or GIF)');
                return;
            }

            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image size should be less than 5MB');
                return;
            }

            currentImageFile = file;

            // Show preview
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('imagePreviewEdit').src = e.target.result;
                document.getElementById('imagePreviewContainerEdit').style.display = 'block';
                document.getElementById('uploadProgressEdit').style.display = 'block';

                // Update upload area text
                document.getElementById('imageUploadAreaEdit').innerHTML = `
            <i class="fas fa-check-circle fa-2x" style="color: #28a745; margin-bottom: 10px;"></i><br>
            <span style="color: #28a745; font-weight: 500;">New image selected</span>
            <p style="margin-top: 10px; font-size: 0.9em; color: #666;">${file.name} (${(file.size / 1024).toFixed(1)}KB)</p>
        `;

                // Start upload
                uploadImageToStorageEdit(file);
            };
            reader.readAsDataURL(file);
        }

        // Upload image for edit
        function uploadImageToStorageEdit(file) {
            const progressBar = document.getElementById('progressBarEdit');
            const progressText = document.getElementById('progressTextEdit');

            console.log('Starting Base64 conversion for edit file:', file.name);

            // Simple progress simulation
            let progress = 0;
            const interval = setInterval(() => {
                progress += 20;
                if (progress > 80) progress = 80;

                progressBar.style.width = progress + '%';
                progressText.textContent = `Processing: ${progress}%`;

                if (progress >= 80) {
                    clearInterval(interval);

                    // Convert to Base64
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        // Store as Base64
                        currentImageUrl = e.target.result;

                        // Complete progress
                        progressBar.style.width = '100%';
                        progressBar.style.background = '#28a745';
                        progressText.innerHTML = '<span style="color: #28a745;"><i class="fas fa-check"></i> Image ready!</span>';

                        console.log('New Base64 image stored, length:', currentImageUrl.length);
                    };
                    reader.readAsDataURL(file);
                }
            }, 100);
        }

        // Remove uploaded image for edit
        function removeUploadedImageEdit() {
            currentImageFile = null;
            // Don't clear currentImageUrl - keep the original image

            // Reset preview
            document.getElementById('imagePreviewContainerEdit').style.display = 'none';
            document.getElementById('uploadProgressEdit').style.display = 'none';
            document.getElementById('phImageUploadEdit').value = '';

            // Reset upload area
            document.getElementById('imageUploadAreaEdit').innerHTML = `
        <i class="fas fa-cloud-upload-alt fa-2x" style="color: #004080; margin-bottom: 10px;"></i><br>
        <span style="color: #004080; font-weight: 500;">Change Image</span>
        <p style="margin-top: 10px; font-size: 0.9em; color: #666;">JPG, PNG, or GIF ‚Ä¢ Max 5MB</p>
    `;
        }

        // Update product with image
        function updatePracticalHubProductWithImage(productId) {
            const name = document.getElementById('phProductName').value;
            const description = document.getElementById('phProductDescription').value;

            // Validate required fields
            if (!name || !description) {
                alert('Please fill in required fields (Product Name and Description)');
                return;
            }

            // Prepare update data
            const updates = {
                name: name,
                category: document.getElementById('phProductCategory').value,
                price: parseInt(document.getElementById('phProductPrice').value) || 0,
                stock: parseInt(document.getElementById('phProductStock').value) || 0,
                description: description,
                details: document.getElementById('phProductDetails').value || '',
                updatedAt: new Date().toISOString()
            };

            // Only update image if a new one was uploaded
            if (currentImageFile) {
                updates.image = currentImageUrl;
            }

            // Update in Firebase Database
            db.ref('practicalHub/products/' + productId).update(updates)
                .then(function () {
                    alert('‚úÖ Product updated successfully!');
                    closeProductEditor();
                    loadPracticalHubProducts();
                })
                .catch(function (error) {
                    console.error('Error updating product:', error);
                    alert('‚ùå Error updating product: ' + error.message);
                });
        }

        // Delete product
        function deletePracticalHubProduct(productId) {
            if (confirm('Are you sure you want to delete this product?\nThis will remove it from the store.')) {
                db.ref('practicalHub/products/' + productId).remove()
                    .then(function () {
                        alert('‚úÖ Product deleted successfully!');
                        loadPracticalHubProducts();
                    })
                    .catch(function (error) {
                        console.error('Error deleting product:', error);
                        alert('‚ùå Error deleting product: ' + error.message);
                    });
            }
        }

        // Close editor
        function closeProductEditor() {
            document.getElementById('productEditorModal').style.display = 'none';
            currentImageFile = null;
            currentImageUrl = '';
            currentProductId = null;
        }
        // Load orders for admin dashboard
        function loadPracticalHubOrders() {
            console.log('Loading Practical Hub orders...');

            const tableBody = document.getElementById('ordersTableBody');
            if (!tableBody) {
                console.error('ordersTableBody element not found!');
                return;
            }

            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px;"><i class="fas fa-spinner fa-spin"></i> Loading orders...</td></tr>';

            db.ref('practicalHub/orders').orderByChild('createdAt').once('value').then((snapshot) => {
                const data = snapshot.val();
                console.log('Orders data:', data);

                if (!data) {
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px;">No orders yet.</td></tr>';
                    return;
                }

                // Convert to array and sort by date (newest first)
                const ordersArray = Object.keys(data).map(key => ({
                    id: key,
                    ...data[key]
                })).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                console.log('Processed orders:', ordersArray);
                displayPracticalHubOrders(ordersArray);
            }).catch((error) => {
                console.error('Error loading orders:', error);
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">Error loading orders: ' + error.message + '</td></tr>';
            });
        }

        // Display orders in table
        // Display orders in admin dashboard
        function displayPracticalHubOrders(orders) {
            const tableBody = document.getElementById('ordersTableBody');
            if (!tableBody) return;

            tableBody.innerHTML = '';

            if (orders.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px;">No orders yet.</td></tr>';
                return;
            }

            orders.forEach(order => {
                const date = new Date(order.createdAt);
                const formattedDate = date.toLocaleDateString() + ' ' +
                    date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                // Status badge
                let statusClass, statusText;
                switch (order.status) {
                    case 'pending':
                        statusClass = 'status-scheduled';
                        statusText = 'Pending';
                        break;
                    case 'processing':
                        statusClass = 'status-active';
                        statusText = 'Processing';
                        break;
                    case 'completed':
                        statusClass = 'status-active';
                        statusText = 'Completed';
                        break;
                    case 'cancelled':
                        statusClass = 'status-expired';
                        statusText = 'Cancelled';
                        break;
                    default:
                        statusClass = '';
                        statusText = order.status;
                }

                // Shorten product list for display
                const productList = order.items && order.items.length > 0
                    ? order.items.slice(0, 2).map(item => `${item.name} √ó ${item.quantity}`).join(', ')
                    : 'No items';
                const moreItems = order.items && order.items.length > 2 ? ` +${order.items.length - 2} more` : '';

                const row = document.createElement('tr');
                row.innerHTML = `
            <td><strong>${order.id}</strong></td>
            <td>${order.customer ? order.customer.name : 'N/A'}<br>
                <small>${order.customer ? order.customer.studentId : ''}</small>
            </td>
            <td>${productList}${moreItems}</td>
            <td>Ksh ${order.summary ? order.summary.total.toLocaleString() : '0'}</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>${formattedDate}</td>
            <td>
                <div class="table-actions">
                    <button class="table-btn btn-view" onclick="event.stopPropagation(); viewOrderDetails('${order.id}')" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="table-btn btn-delete" onclick="event.stopPropagation(); deleteOrder('${order.id}')" title="Delete Order">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;

                // Make row clickable to view details
                row.style.cursor = 'pointer';
                row.addEventListener('click', () => viewOrderDetails(order.id));

                tableBody.appendChild(row);
            });
        }
        // Delete order function
        function deleteOrder(orderId) {
            if (confirm('Are you sure you want to delete this order?\n\nThis action cannot be undone and will permanently remove the order from the system.')) {

                // Optional: Restore stock before deleting (if order was not cancelled)
                restoreOrderStock(orderId);

                // Delete from Firebase
                db.ref('practicalHub/orders/' + orderId).remove()
                    .then(() => {
                        showNotification('‚úÖ Order deleted successfully!', 'success');
                        loadPracticalHubOrders(); // Refresh the table
                    })
                    .catch(error => {
                        console.error('Error deleting order:', error);
                        showNotification('‚ùå Error deleting order: ' + error.message, 'error');
                    });
            }
        }

        // Helper function to restore stock if needed (optional)
        function restoreOrderStock(orderId) {
            // First get the order details
            db.ref('practicalHub/orders/' + orderId).once('value')
                .then(snapshot => {
                    const order = snapshot.val();
                    if (!order || order.status === 'cancelled') return;

                    // If order is pending or processing, restore stock
                    if (order.status === 'pending' || order.status === 'processing') {
                        if (order.items && order.items.length > 0) {
                            order.items.forEach(item => {
                                if (item.productId) {
                                    const productRef = db.ref('practicalHub/products/' + item.productId);
                                    productRef.once('value').then(productSnap => {
                                        const product = productSnap.val();
                                        if (product) {
                                            const newStock = (product.stock || 0) + (item.quantity || 1);
                                            productRef.update({ stock: newStock });
                                        }
                                    });
                                }
                            });
                        }
                    }
                })
                .catch(error => {
                    console.error('Error restoring stock:', error);
                });
        }
        // View order details
        function viewOrderDetails(orderId) {
            console.log('Viewing order details for:', orderId);

            db.ref('practicalHub/orders/' + orderId).once('value').then((snapshot) => {
                const order = snapshot.val();
                if (!order) {
                    alert('Order not found');
                    return;
                }

                const date = new Date(order.createdAt);
                const formattedDate = date.toLocaleString();

                // Build items HTML
                let itemsHTML = '<p>No items in order</p>';
                if (order.items && order.items.length > 0) {
                    itemsHTML = order.items.map(item => `
                <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;">
                    <div>
                        <strong>${item.name || 'Product'}</strong><br>
                        <small>Quantity: ${item.quantity || 1} √ó Ksh ${item.price || 0}</small>
                    </div>
                    <div>Ksh ${(item.price || 0) * (item.quantity || 1)}</div>
                </div>
            `).join('');
                }

                const detailsHTML = `
            <div style="padding: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h4 style="color: #004080;">Customer Information</h4>
                        <p><strong>Name:</strong> ${order.customer ? order.customer.name : 'N/A'}</p>
                        <p><strong>Student ID:</strong> ${order.customer ? order.customer.studentId : 'N/A'}</p>
                        <p><strong>Phone:</strong> ${order.customer ? order.customer.phone : 'N/A'}</p>
                        ${order.customer && order.customer.email ? `<p><strong>Email:</strong> ${order.customer.email}</p>` : ''}
                        <p><strong>Delivery:</strong> ${order.customer ? order.customer.deliveryPreference : 'N/A'}</p>
                    </div>
                    <div>
                        <h4 style="color: #004080;">Order Information</h4>
                        <p><strong>Order ID:</strong> ${order.id}</p>
                        <p><strong>Status:</strong> <span class="status-badge status-${order.status || 'pending'}">${order.status || 'Pending'}</span></p>
                        <p><strong>Date:</strong> ${formattedDate}</p>
                        <p><strong>Payment:</strong> ${order.paymentMethod || 'cash_on_delivery'}</p>
                    </div>
                </div>

                <h4 style="color: #004080; margin-top: 20px;">Order Items</h4>
                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin: 10px 0; max-height: 300px; overflow-y: auto;">
                    ${itemsHTML}
                </div>

                <div style="background: #e8f5e8; border-radius: 8px; padding: 15px; margin: 20px 0;">
                    <div style="display: flex; justify-content: space-between; font-size: 1.1em;">
                        <strong>Subtotal:</strong>
                        <span>Ksh ${order.summary ? (order.summary.subtotal || 0) : 0}</span>
                    </div>
                    ${order.summary && order.summary.deliveryFee > 0 ? `
                        <div style="display: flex; justify-content: space-between;">
                            <span>Delivery Fee:</span>
                            <span>Ksh ${order.summary.deliveryFee}</span>
                        </div>
                    ` : ''}
                    <div style="display: flex; justify-content: space-between; font-size: 1.2em; font-weight: bold; margin-top: 10px; padding-top: 10px; border-top: 2px solid #ccc;">
                        <span>Total:</span>
                        <span>Ksh ${order.summary ? (order.summary.total || 0) : 0}</span>
                    </div>
                </div>

                ${order.notes ? `
                    <div style="margin: 20px 0;">
                        <h4 style="color: #004080;">Customer Notes</h4>
                        <div style="background: #f0f8ff; padding: 15px; border-radius: 8px;">
                            ${order.notes}
                        </div>
                    </div>
                ` : ''}

                <div style="margin-top: 30px; text-align: center;">
                    ${(!order.status || order.status !== 'processing') ? `
                        <button class="btn" onclick="updateOrderStatus('${orderId}', 'processing')" style="margin: 5px;">
                            <i class="fas fa-cog"></i> Mark as Processing
                        </button>
                    ` : ''}
                    ${(!order.status || order.status !== 'completed') ? `
                        <button class="btn" style="background: #28a745; margin: 5px;" onclick="updateOrderStatus('${orderId}', 'completed')">
                            <i class="fas fa-check"></i> Mark as Completed
                        </button>
                    ` : ''}
                    ${(!order.status || order.status !== 'cancelled') ? `
                        <button class="btn" style="background: #dc3545; margin: 5px;" onclick="updateOrderStatus('${orderId}', 'cancelled')">
                            <i class="fas fa-times"></i> Cancel Order
                        </button>
                    ` : ''}
                </div>
            </div>
        `;

                // Get or create modal
                let modal = document.getElementById('orderDetailsModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'orderDetailsModal';
                    modal.className = 'modal';
                    modal.style.display = 'none';
                    modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <span class="closeBtn" onclick="closeOrderDetailsModal()">&times;</span>
                    <h3 id="orderDetailsTitle">Order Details</h3>
                    <div id="orderDetailsContent"></div>
                </div>
            `;
                    document.body.appendChild(modal);
                }

                document.getElementById('orderDetailsTitle').textContent = 'Order Details - ' + order.id;
                document.getElementById('orderDetailsContent').innerHTML = detailsHTML;
                modal.style.display = 'block';

                // Close modal when clicking outside
                modal.onclick = function (event) {
                    if (event.target === modal) {
                        closeOrderDetailsModal();
                    }
                };

            }).catch((error) => {
                console.error('Error loading order details:', error);
                alert('Error loading order details: ' + error.message);
            });
        }

        function closeOrderDetailsModal() {
            const modal = document.getElementById('orderDetailsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function updateOrderStatus(orderId, status) {
            if (confirm(`Change order status to "${status}"?`)) {
                const updates = {
                    status: status,
                    updatedAt: new Date().toISOString()
                };

                db.ref('practicalHub/orders/' + orderId).update(updates)
                    .then(() => {
                        alert('‚úÖ Order status updated!');
                        loadPracticalHubOrders();
                        closeOrderDetailsModal();
                    })
                    .catch(error => {
                        console.error('Error updating order:', error);
                        alert('‚ùå Error updating order: ' + error.message);
                    });
            }
        }

        // Make sure the showHubTab function calls loadPracticalHubOrders
        // Find this function in your code and update it:
        function showHubTab(tabName) {
            console.log('Showing tab:', tabName);

            document.querySelectorAll('#practicalHubSection .tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.querySelectorAll('#practicalHubSection .tab-content').forEach(content => {
                content.style.display = 'none';
            });

            event.target.classList.add('active');

            const targetTab = document.getElementById(tabName + 'HubTab');
            if (targetTab) {
                targetTab.style.display = 'block';

                // Load data when tab is clicked
                if (tabName === 'orders') {
                    console.log('Loading orders tab...');
                    loadPracticalHubOrders();
                } else if (tabName === 'products') {
                    console.log('Loading products tab...');
                    loadPracticalHubProducts();
                }
            }
        }

        // Initialize Practical Hub
        function initializePracticalHub() {
            console.log('üöÄ Initializing Practical Hub...');

            // Set up tab event listeners
            document.querySelectorAll('#practicalHubSection .tab').forEach(tab => {
                // Remove any existing onclick
                tab.onclick = null;

                tab.addEventListener('click', function (e) {
                    const tabText = this.textContent.trim().toLowerCase();
                    let tabName = 'products';

                    if (tabText.includes('orders')) tabName = 'orders';
                    else if (tabText.includes('inventory')) tabName = 'inventory';
                    else if (tabText.includes('analytics')) tabName = 'analytics';

                    showHubTab(tabName);
                });
            });

            // Load products initially
            loadPracticalHubProducts();

            console.log('‚úÖ Practical Hub initialized');
        }

        // Initialize when Practical Hub section is shown
        const originalShowSection = window.showSection;
        window.showSection = function (sectionName) {
            if (originalShowSection) originalShowSection(sectionName);

            if (sectionName === 'practicalHub') {
                setTimeout(initializePracticalHub, 100);
            }
        };

        // Make sure all functions are globally available
        window.showHubTab = showHubTab;
        window.addNewProduct = addNewProduct;
        window.handleImageUpload = handleImageUpload;
        window.handleImageUploadEdit = handleImageUploadEdit;
        window.removeUploadedImage = removeUploadedImage;
        window.removeUploadedImageEdit = removeUploadedImageEdit;
        window.uploadImageToStorage = uploadImageToStorage;
        window.uploadImageToStorageEdit = uploadImageToStorageEdit;
        window.savePracticalHubProductWithImage = savePracticalHubProductWithImage;
        window.editPracticalHubProduct = editPracticalHubProduct;
        window.updatePracticalHubProductWithImage = updatePracticalHubProductWithImage;
        window.deletePracticalHubProduct = deletePracticalHubProduct;
        window.closeProductEditor = closeProductEditor;



        // Optional: Optimize Base64 image size
        function optimizeBase64Image(base64Data, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function () {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // Calculate new dimensions
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Convert back to Base64 with compression
                    const optimizedBase64 = canvas.toDataURL('image/jpeg', quality);
                    resolve(optimizedBase64);
                };

                img.onerror = function () {
                    // If optimization fails, return original
                    resolve(base64Data);
                };

                img.src = base64Data;
            });
        }

    </script>
</body>

</html>
