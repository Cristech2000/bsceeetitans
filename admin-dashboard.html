<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!-- Add this to the head section of your HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - BSCEEE Y2S1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .logo {
            text-align: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .logo h2 {
            color: #004080;
            font-size: 1.5em;
        }

        .logo p {
            color: #666;
            font-size: 0.9em;
        }

        .nav-links {
            list-style: none;
            padding: 20px 0;
        }

        .nav-links li {
            padding: 12px 25px;
            margin: 5px 0;
        }

        .nav-links li a {
            text-decoration: none;
            color: #333;
            display: flex;
            align-items: center;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-links li a i {
            margin-right: 10px;
            font-size: 1.2em;
            width: 20px;
            text-align: center;
        }

        .nav-links li a:hover {
            color: #004080;
            transform: translateX(5px);
        }

        .nav-links li.active a {
            color: #004080;
            background: rgba(0, 64, 128, 0.1);
            border-radius: 8px;
            margin: 0 -10px;
            padding: 12px 15px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #004080;
            font-size: 2em;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #004080;
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card i {
            font-size: 2.5em;
            color: #004080;
            margin-bottom: 15px;
        }

        .card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .card .number {
            font-size: 2em;
            font-weight: bold;
            color: #004080;
            margin: 10px 0;
        }

        .card .description {
            color: #666;
            font-size: 0.9em;
        }

        /* Content Sections */
        .content-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .section-header h2 {
            color: #004080;
            font-size: 1.5em;
        }

        .btn {
            background: #004080;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s ease;
        }

        .btn:hover {
            background: #003366;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            color: #004080;
            font-weight: 600;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .tab {
            padding: 12px 25px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1em;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #004080;
            border-bottom: 2px solid #004080;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #004080;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-item {
            background: linear-gradient(135deg, #004080, #0066cc);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .action-btn {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .action-btn:hover {
            border-color: #004080;
            transform: translateY(-2px);
        }

        .action-btn i {
            font-size: 2em;
            color: #004080;
            margin-bottom: 10px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
            }

            .dashboard-cards {
                grid-template-columns: 1fr;
            }
        }








        /* Timetable Styles */
        .timetable-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
        }

        .timetable-table th {
            background: #004080;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
        }

        .timetable-table td {
            padding: 10px;
            border: 1px solid #ddd;
            vertical-align: top;
        }

        .timetable-table input,
        .timetable-table textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .timetable-table textarea {
            height: 60px;
            resize: vertical;
        }

        .timetable-table .time-slot {
            background: #f8f9fa;
            font-weight: 600;
            text-align: center;
        }

        .timetable-table .delete-row {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .timetable-table .delete-row:hover {
            background: #c82333;
        }





        /* Section Creator Styles - NEW VERSION */
        .section-fields {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #004080;
            position: relative;
            z-index: 1;
        }

        .item-preview {
            background: white;
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .item-preview .item-info {
            flex: 1;
        }

        .item-preview .item-actions {
            display: flex;
            gap: 5px;
        }

        .section-preview-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
        }

        .section-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .section-type-badge {
            background: #004080;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .section-content-preview {
            max-height: 200px;
            overflow: hidden;
            position: relative;
        }

        .section-content-preview::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(transparent, white);
        }

        /* Ensure buttons are clickable */
        #sectionCreatorTab .btn {
            position: relative;
            z-index: 1000;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #sectionCreatorTab .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        #createSectionBtn {
            background: #28a745 !important;
            border-color: #1e7e34 !important;
        }

        #createSectionBtn:hover {
            background: #218838 !important;
            transform: translateY(-2px) !important;
        }

        #testButton {
            background: #17a2b8 !important;
            border-color: #117a8b !important;
        }

        #testButton:hover {
            background: #138496 !important;
        }



        /* Add this to your CSS */
        .badge {
            background: #004080;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>

    <div class="admin-container">

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <h2><i class="fas fa-cogs"></i> Admin Panel</h2>
                <p>BSCEEE Y2S1</p>
            </div>
            <ul class="nav-links">
                <li class="active"><a href="#" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt"></i>
                        Dashboard</a></li>
                <li><a href="#" onclick="showSection('content')"><i class="fas fa-edit"></i> Content Management</a></li>
                <li><a href="#" onclick="showSection('registrations')"><i class="fas fa-users"></i> Student
                        Registrations</a></li>
                <!-- In the sidebar section, add this line after the "Pending Students" menu item -->
                <li><a href="#" onclick="showSection('tripShifts')"><i class="fas fa-bus"></i> Trip Shifts</a></li>
                <li><a href="#" onclick="showSection('complaints')"><i class="fas fa-exclamation-circle"></i> Academic
                        Complaints</a></li>
                <li><a href="#" onclick="showSection('groups')"><i class="fas fa-layer-group"></i> Group Management</a>
                </li>
                <li><a href="#" onclick="showSection('pending')"><i class="fas fa-clock"></i> Pending Students</a></li>
                <li><a href="#" onclick="showSection('announcements')"><i class="fas fa-bullhorn"></i> Announcements</a>
                </li>
                <li><a href="#" onclick="showSection('users')"><i class="fas fa-user-shield"></i> User Management</a>
                </li>
                <li><a href="#" onclick="showSection('settings')"><i class="fas fa-cog"></i> Settings</a></li>
                <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">

            <!-- Header -->
            <div class="header">
                <h1 id="currentSection">Dashboard Overview</h1>
                <div class="user-info">
                    <img src="https://ui-avatars.com/api/?name=Admin+User&background=004080&color=fff" alt="Admin">
                    <span id="adminName">Welcome, Admin</span>
                </div>
            </div>

            <!-- Dashboard Overview -->
            <div id="dashboardSection" class="content-section">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="totalStudents">0</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalGroups">0</div>
                        <div class="stat-label">Groups Formed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="pendingStudents">0</div>
                        <div class="stat-label">Pending Students</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="completionRate">0%</div>
                        <div class="stat-label">Registration Complete</div>
                    </div>
                </div>

                <div class="quick-actions">
                    <div class="action-btn" onclick="showSection('content')">
                        <i class="fas fa-edit"></i>
                        <h3>Edit Website</h3>
                        <p>Update homepage content</p>
                    </div>
                    <div class="action-btn" onclick="showSection('registrations')">
                        <i class="fas fa-users"></i>
                        <h3>View Registrations</h3>
                        <p>Student applications</p>
                    </div>
                    <div class="action-btn" onclick="showSection('groups')">
                        <i class="fas fa-layer-group"></i>
                        <h3>Manage Groups</h3>
                        <p>Group assignments</p>
                    </div>
                    <div class="action-btn" onclick="showSection('announcements')">
                        <i class="fas fa-bullhorn"></i>
                        <h3>Post Announcement</h3>
                        <p>Class updates</p>
                    </div>
                </div>

                <div class="dashboard-cards">
                    <div class="card">
                        <i class="fas fa-user-plus"></i>
                        <h3>Individual Registrations</h3>
                        <div class="number" id="individualRegs">0</div>
                        <p class="description">Students registered individually</p>
                    </div>
                    <div class="card">
                        <i class="fas fa-users"></i>
                        <h3>Group Registrations</h3>
                        <div class="number" id="groupRegs">0</div>
                        <p class="description">Complete groups formed</p>
                    </div>
                    <div class="card">
                        <i class="fas fa-clock"></i>
                        <h3>Pending Approval</h3>
                        <div class="number" id="pendingApproval">0</div>
                        <p class="description">Awaiting group placement</p>
                    </div>
                    <div class="card">
                        <i class="fas fa-chart-line"></i>
                        <h3>Progress</h3>
                        <div class="number" id="progressPercent">0%</div>
                        <p class="description">Overall completion</p>
                    </div>
                </div>
            </div>
            <!-- Registrations Section -->
            <div id="registrationsSection" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-users"></i> Student Registrations</h2>
                    <button class="btn" onclick="downloadRegistrations()">
                        <i class="fas fa-download"></i> Export Excel
                    </button>
                </div>
                <div class="table-container">
                    <table id="registrationsTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Full Name</th>
                                <th>Reg Number</th>
                                <th>Phone Number</th>
                                <th>Timestamp</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 20px;">
                                    Click "Load Registrations" to view data
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="loadRegistrationsTable()">
                        <i class="fas fa-sync"></i> Load Registrations
                    </button>
                </div>
            </div>
            <!-- Add this after the existing sections, before the closing </div> of main-content -->
            <div id="tripShiftsSection" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-bus"></i> Trip Shift Registrations</h2>
                    <button class="btn" onclick="exportTripShifts()">
                        <i class="fas fa-download"></i> Export Excel
                    </button>
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="showTripShiftTab('shift1')">Shift 1 (51 students)</div>
                    <div class="tab" onclick="showTripShiftTab('shift2')">Shift 2 (52 students)</div>
                    <div class="tab" onclick="showTripShiftTab('stats')">Statistics</div>
                </div>

                <!-- Shift 1 Tab -->
                <div id="shift1Tab" class="tab-content active">
                    <h3>Shift 1 Registrations <span id="shift1Count" class="badge">0/51</span></h3>
                    <div class="table-container">
                        <table id="shift1Table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Full Name</th>
                                    <th>Registration Number</th>
                                    <th>Timestamp</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 20px;">
                                        Click "Load Shift 1" to view registrations
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="loadTripShift('shift1')">
                            <i class="fas fa-sync"></i> Load Shift 1
                        </button>
                    </div>
                </div>

                <!-- Shift 2 Tab -->
                <div id="shift2Tab" class="tab-content" style="display: none;">
                    <h3>Shift 2 Registrations <span id="shift2Count" class="badge">0/52</span></h3>
                    <div class="table-container">
                        <table id="shift2Table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Full Name</th>
                                    <th>Registration Number</th>
                                    <th>Timestamp</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 20px;">
                                        Click "Load Shift 2" to view registrations
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="loadTripShift('shift2')">
                            <i class="fas fa-sync"></i> Load Shift 2
                        </button>
                    </div>
                </div>

                <!-- Statistics Tab -->
                <div id="statsTab" class="tab-content" style="display: none;">
                    <h3>Trip Shift Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="totalTripRegs">0</div>
                            <div class="stat-label">Total Registered</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="shift1Percentage">0%</div>
                            <div class="stat-label">Shift 1 Capacity</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="shift2Percentage">0%</div>
                            <div class="stat-label">Shift 2 Capacity</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="availableSpots">0</div>
                            <div class="stat-label">Remaining Spots</div>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="loadTripShiftStats()">
                            <i class="fas fa-chart-bar"></i> Load Statistics
                        </button>
                    </div>
                </div>
            </div>
            <!-- Complaints Section -->
            <div id="complaintsSection" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-exclamation-circle"></i> Academic Support Complaints</h2>
                    <button class="btn" onclick="exportComplaintsToExcel()">
                        <i class="fas fa-download"></i> Export to Excel
                    </button>
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="showComplaintsSubTab('missingMarks')">Missing Marks Complaints
                    </div>
                    <div class="tab" onclick="showComplaintsSubTab('anonymousIssues')">Anonymous Class Issues</div>
                </div>

                <!-- Missing Marks Complaints -->
                <div id="missingMarksTab" class="tab-content active">
                    <div class="tabs">
                        <div class="tab active" onclick="showComplaintsYear('year1')">1st Year</div>
                        <div class="tab" onclick="showComplaintsYear('year2')">2nd Year</div>
                        <div class="tab" onclick="showComplaintsYear('year3')">3rd Year</div>
                        <div class="tab" onclick="showComplaintsYear('year4')">4th Year</div>
                        <div class="tab" onclick="showComplaintsYear('year5')">5th Year</div>
                    </div>

                    <div id="complaintsContent">
                        <h3 id="complaintsYearTitle">1st Year Complaints</h3>
                        <div class="table-container">
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Registration No</th>
                                        <th>Unit</th>
                                        <th>Lecturer</th>
                                        <th>Submitted At</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="complaintsTableBody">
                                    <tr>
                                        <td colspan="6" style="text-align: center; padding: 20px;">
                                            Select a year and click "Load Complaints" to view data
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn" onclick="loadComplaintsForYear(currentComplaintsYear)">
                                <i class="fas fa-sync"></i> Load Complaints
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Anonymous Issues -->
                <div id="anonymousIssuesTab" class="tab-content" style="display: none;">
                    <h3>Anonymous Class Issues</h3>
                    <div class="table-container">
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Issue Type</th>
                                    <th>Description</th>
                                    <th>Year</th>
                                    <th>Submitted At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="anonymousIssuesTableBody">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 20px;">
                                        Click "Load Issues" to view data
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="loadAnonymousIssues()">
                            <i class="fas fa-sync"></i> Load Issues
                        </button>
                    </div>
                </div>
            </div>
            <!-- Content Management Section -->
            <div id="contentSection" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-edit"></i> Website Content Management</h2>
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="showContentTab('homepage')">Homepage</div>
                    <div class="tab" onclick="showContentTab('announcements')">Announcements</div>
                    <div class="tab" onclick="showContentTab('timetable')">Timetable</div>
                    <div class="tab" onclick="showContentTab('quiz')">Weekly Quiz</div>
                    <div class="tab" onclick="showContentTab('studydocs')">Study Documents</div>
                    <div class="tab" onclick="showContentTab('personnel')">Personnel</div>
                    <div class="tab" onclick="showContentTab('sectionCreator')">Section Editor</div>
                </div>
                <div id="homepageTab" class="tab-content active">
                    <h3>Homepage Sections</h3>
                    <div class="quick-actions">
                        <div class="action-btn" onclick="editContent('hero')">
                            <i class="fas fa-heading"></i>
                            <h3>Hero Section</h3>
                            <p>Main title & subtitle</p>
                        </div>
                        <div class="action-btn" onclick="editContent('about')">
                            <i class="fas fa-info-circle"></i>
                            <h3>About Section</h3>
                            <p>Website description</p>
                        </div>
                        <div class="action-btn" onclick="editContent('features')">
                            <i class="fas fa-users"></i>
                            <h3>Who We Are</h3>
                            <p>Class information</p>
                        </div>
                        <div class="action-btn" onclick="editContent('news')">
                            <i class="fas fa-newspaper"></i>
                            <h3>Latest News</h3>
                            <p>News & updates</p>
                        </div>
                        <div class="action-btn" onclick="editContent('funFacts')">
                            <i class="fas fa-lightbulb"></i>
                            <h3>Fun Facts</h3>
                            <p>Engineering facts</p>
                        </div>
                        <div class="action-btn" onclick="editContent('spotlight')">
                            <i class="fas fa-star"></i>
                            <h3>Student Spotlight</h3>
                            <p>Featured students</p>
                        </div>
                    </div>
                </div>

                <!-- STUDY DOCS TAB - MOVED TO BE AT SAME LEVEL AS OTHER TABS -->
                <div id="studydocsTab" class="tab-content" style="display: none;">
                    <h3>Study Documents Management</h3>

                    <div class="form-group">
                        <label>Select Semester:</label>
                        <select id="semesterSelect" class="form-control" onchange="toggleCustomInputs()">
                            <option value="year1sem1">Year 1 Semester 1</option>
                            <option value="year1sem2">Year 1 Semester 2</option>
                            <option value="year2sem1">Year 2 Semester 1</option>
                            <option value="year2sem2">Year 2 Semester 2</option>
                            <option value="other">Other (Custom)</option>
                        </select>
                    </div>

                    <div id="customSemesterGroup" class="form-group" style="display: none;">
                        <label>Custom Semester Name:</label>
                        <input type="text" id="customSemester" class="form-control"
                            placeholder="e.g., Year 3 Semester 1, Year 1 Trimester 2">
                        <small>Enter any semester name (will be converted to lowercase, no spaces)</small>
                    </div>

                    <div class="form-group">
                        <label>Select Course:</label>
                        <select id="courseSelect" class="form-control" onchange="toggleCustomInputs()">
                            <option value="EENG111">EENG 111</option>
                            <option value="EENG112">EENG 112</option>
                            <option value="EENG291">EENG 291</option>
                            <option value="EENG271">EENG 271</option>
                            <option value="other">Other (Custom)</option>
                        </select>
                    </div>

                    <div id="customCourseGroup" class="form-group" style="display: none;">
                        <label>Custom Course Code:</label>
                        <input type="text" id="customCourse" class="form-control"
                            placeholder="e.g., MATH 201, PHYS 101">
                        <small>Enter any course code (will be converted to uppercase, no spaces)</small>
                    </div>

                    <div class="form-group">
                        <label>Document Type:</label>
                        <select id="docTypeSelect" class="form-control">
                            <option value="exam">Exam Paper</option>
                            <option value="cat">CAT</option>
                            <option value="notes">Notes</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Document Title:</label>
                        <input type="text" id="docTitle" class="form-control"
                            placeholder="e.g., EXAM 2024/2025, Final Notes, Assignment 1">
                    </div>

                    <div class="form-group">
                        <label>Google Drive Link:</label>
                        <input type="url" id="driveLink" class="form-control"
                            placeholder="https://drive.google.com/file/d/...">
                    </div>

                    <button class="btn" onclick="addStudyDocument()">
                        <i class="fas fa-plus"></i> Add Document
                    </button>

                    <hr style="margin: 20px 0;">

                    <h4>Existing Documents</h4>
                    <div id="existingDocsList" class="table-container">
                        <!-- Existing documents will be listed here -->
                    </div>
                </div>

                <!-- Add other tab contents here -->
                <div id="announcementsTab" class="tab-content" style="display: none;">
                    <h3>Announcements Management</h3>
                    <p>Announcements content goes here...</p>
                </div>

                <div id="timetableTab" class="tab-content" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-calendar-alt"></i> Timetable Management</h2>
                        <div>
                            <button class="btn btn-secondary" onclick="loadTimetableData()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                            <button class="btn" onclick="saveTimetableData()">
                                <i class="fas fa-save"></i> Save All Changes
                            </button>
                        </div>
                    </div>

                    <div class="tabs">
                        <div class="tab active" onclick="showTimetableTab('regular')">Regular Timetable</div>
                        <div class="tab" onclick="showTimetableTab('exam')">Exam Timetable</div>
                    </div>

                    <!-- Regular Timetable -->
                    <div id="regularTimetableTab" class="tab-content active">
                        <h3>Regular Class Timetable</h3>

                        <div class="form-group">
                            <label>Academic Period:</label>
                            <input type="text" id="regularPeriod" class="form-control"
                                placeholder="e.g., SEMESTER 2 2024/2025 ACADEMIC YEAR">
                        </div>

                        <div class="table-container">
                            <table class="timetable-table">
                                <thead>
                                    <tr>
                                        <th>Time/Day</th>
                                        <th>Monday</th>
                                        <th>Tuesday</th>
                                        <th>Wednesday</th>
                                        <th>Thursday</th>
                                        <th>Friday</th>
                                    </tr>
                                </thead>
                                <tbody id="regularTimetableBody">
                                    <!-- Times will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Exam Timetable -->
                    <div id="examTimetableTab" class="tab-content" style="display: none;">
                        <h3>Examination Timetable</h3>

                        <div class="form-group">
                            <label>Examination Period:</label>
                            <input type="text" id="examPeriod" class="form-control"
                                placeholder="e.g., END OF SEMESTER 2 EXAMINATIONS 2024/2025">
                        </div>

                        <div class="table-container">
                            <table class="timetable-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Time</th>
                                        <th>Unit Code</th>
                                        <th>Unit Name</th>
                                        <th>Venue</th>
                                    </tr>
                                </thead>
                                <tbody id="examTimetableBody">
                                    <!-- Exam schedule will be populated by JavaScript -->
                                </tbody>
                            </table>
                            <button type="button" class="btn" onclick="addExamRow()" style="margin-top: 10px;">
                                <i class="fas fa-plus"></i> Add Exam Row
                            </button>
                        </div>
                    </div>
                </div>

                <div id="quizTab" class="tab-content" style="display: none;">
                    <h3>Weekly Quiz Management</h3>
                    <p>Quiz content goes here...</p>
                </div>
                <!-- Personnel Management Tab -->
                <div id="personnelTab" class="tab-content" style="display: none;">
                    <h3>Personnel Management</h3>

                    <div class="tabs">
                        <div class="tab active" onclick="showPersonnelSubTab('classLeadership')">Class Leadership</div>
                        <div class="tab" onclick="showPersonnelSubTab('facultyLeadership')">Faculty Leadership</div>
                        <div class="tab" onclick="showPersonnelSubTab('lecturers')">Lecturers</div>
                    </div>

                    <!-- Class Leadership Sub-tab -->
                    <div id="classLeadershipTab" class="tab-content active">
                        <h4>Class Leadership Management</h4>
                        <button class="btn" onclick="addPersonnelRow('classLeadership')" style="margin-bottom: 15px;">
                            <i class="fas fa-plus"></i> Add Class Leader
                        </button>

                        <div class="table-container">
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Position</th>
                                        <th>Name</th>
                                        <th>Phone</th>
                                        <th>Role Description</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="classLeadershipBody">
                                    <!-- Dynamic content will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Faculty Leadership Sub-tab -->
                    <div id="facultyLeadershipTab" class="tab-content" style="display: none;">
                        <h4>Faculty Leadership Management</h4>
                        <button class="btn" onclick="addPersonnelRow('facultyLeadership')" style="margin-bottom: 15px;">
                            <i class="fas fa-plus"></i> Add Faculty Leader
                        </button>

                        <div class="table-container">
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Position</th>
                                        <th>Name</th>
                                        <th>Phone</th>
                                        <th>Role Description</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="facultyLeadershipBody">
                                    <!-- Dynamic content will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>





                <!-- Lecturers Sub-tab -->
                <div id="lecturersTab" class="tab-content" style="display: none;">
                    <h4>Lecturers Management</h4>

                    <div class="form-group">
                        <label>Select Semester:</label>
                        <select id="lecturerSemester" class="form-control" onchange="loadLecturers()">
                            <option value="year1sem1">Year 1 Semester 1</option>
                            <option value="year1sem2">Year 1 Semester 2</option>
                            <option value="year2sem1">Year 2 Semester 1</option>
                            <option value="year2sem2">Year 2 Semester 2</option>
                            <option value="year3sem1">Year 3 Semester 1</option>
                            <option value="year3sem2">Year 3 Semester 2</option>
                            <option value="year4sem1">Year 4 Semester 1</option>
                            <option value="year4sem2">Year 4 Semester 2</option>
                            <option value="year5sem1">Year 5 Semester 1</option>
                            <option value="year5sem2">Year 5 Semester 2</option>
                        </select>
                    </div>

                    <button class="btn" onclick="addLecturerRow()" style="margin-bottom: 15px;">
                        <i class="fas fa-plus"></i> Add Lecturer
                    </button>

                    <div class="table-container">
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Course Code</th>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="lecturersBody">
                                <!-- Dynamic content will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>



                <!-- Section Creator Tab -->
                <div id="sectionCreatorTab" class="tab-content" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-plus-circle"></i> Section Creator</h2>
                        <p>Add new sections to the homepage dynamically</p>
                    </div>

                    <!-- REMOVED the nested .content-section div and placed content directly -->
                    <div
                        style="background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); margin-bottom: 20px;">
                        <h3>Create New Section</h3>

                        <div class="form-group">
                            <label>Section Type:</label>
                            <select id="sectionType" class="form-control">
                                <option value="text">Text Content</option>
                                <option value="documents">Documents List</option>
                                <option value="links">Links List</option>
                                <option value="custom">Custom HTML</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Section Title:</label>
                            <input type="text" id="sectionTitle" class="form-control"
                                placeholder="e.g., Important Announcements, Resources, etc.">
                        </div>

                        <div class="form-group">
                            <label>Section ID (no spaces):</label>
                            <input type="text" id="sectionId" class="form-control"
                                placeholder="e.g., announcements, resources, links">
                            <small>This will be used as the HTML ID and Firebase reference</small>
                        </div>

                        <!-- Text Content Fields -->
                        <div id="textFields" class="section-fields">
                            <div class="form-group">
                                <label>Content:</label>
                                <textarea id="sectionContent" class="form-control" rows="6"
                                    placeholder="Enter the content for this section..."></textarea>
                            </div>
                        </div>

                        <!-- Documents Fields -->
                        <div id="documentsFields" class="section-fields" style="display: none;">
                            <div class="form-group">
                                <label>Document Title:</label>
                                <input type="text" id="docItemTitle" class="form-control" placeholder="Document title">
                            </div>
                            <div class="form-group">
                                <label>Document Link:</label>
                                <input type="url" id="docItemLink" class="form-control"
                                    placeholder="https://drive.google.com/...">
                            </div>
                            <div class="form-group">
                                <label>Description:</label>
                                <textarea id="docItemDesc" class="form-control" rows="3"
                                    placeholder="Document description"></textarea>
                            </div>
                            <button type="button" class="btn btn-secondary" id="addDocumentBtn">
                                <i class="fas fa-plus"></i> Add Document
                            </button>
                            <div id="documentsList" style="margin-top: 15px;">
                                <h4>Documents to Add:</h4>
                                <div id="docItemsPreview"></div>
                            </div>
                        </div>

                        <!-- Links Fields -->
                        <div id="linksFields" class="section-fields" style="display: none;">
                            <div class="form-group">
                                <label>Link Text:</label>
                                <input type="text" id="linkText" class="form-control" placeholder="Link display text">
                            </div>
                            <div class="form-group">
                                <label>Link URL:</label>
                                <input type="url" id="linkUrl" class="form-control" placeholder="https://example.com">
                            </div>
                            <div class="form-group">
                                <label>Description (optional):</label>
                                <input type="text" id="linkDesc" class="form-control" placeholder="Brief description">
                            </div>
                            <button type="button" class="btn btn-secondary" id="addLinkBtn">
                                <i class="fas fa-plus"></i> Add Link
                            </button>
                            <div id="linksList" style="margin-top: 15px;">
                                <h4>Links to Add:</h4>
                                <div id="linkItemsPreview"></div>
                            </div>
                        </div>

                        <!-- Custom HTML Fields -->
                        <div id="customFields" class="section-fields" style="display: none;">
                            <div class="form-group">
                                <label>Custom HTML:</label>
                                <textarea id="customHTML" class="form-control" rows="8"
                                    placeholder="Enter your custom HTML here..."></textarea>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Section Order:</label>
                            <input type="number" id="sectionOrder" class="form-control" value="0" min="0">
                            <small>Lower numbers appear first. Existing sections: Hero(0), About(1), Features(2),
                                News(3), Fun Facts(4), Spotlight(5), Quiz(6)</small>
                        </div>

                        <div class="form-group">
                            <label>Background Color:</label>
                            <select id="sectionBgColor" class="form-control">
                                <option value="white">White</option>
                                <option value="#f8f9fa">Light Gray</option>
                                <option value="#004080">Dark Blue</option>
                                <option value="#e3f2fd">Light Blue</option>
                                <option value="#f3e5f5">Light Purple</option>
                                <option value="#e8f5e8">Light Green</option>
                            </select>
                        </div>

                        <button class="btn" id="createSectionBtn"
                            style="background: #28a745; border: 2px solid #1e7e34;">
                            <i class="fas fa-plus-circle"></i> Create New Section
                        </button>

                        <!-- Test Button -->
                        <button class="btn" id="testButton" style="background: #17a2b8; margin-left: 10px;">
                            <i class="fas fa-check"></i> Test Button
                        </button>
                    </div>

                    <div
                        style="background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); margin-top: 30px;">
                        <h3>Existing Custom Sections</h3>
                        <div id="existingSectionsList">
                            <p><i class="fas fa-spinner fa-spin"></i> Loading sections...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Content Editor Modal - NUCLEAR OPTION -->
    <div id="editorModal"
        style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); overflow: auto;">
        <div
            style="background: white; padding: 30px; border-radius: 10px; max-width: 800px; margin: 50px auto; position: relative; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <span
                style="position: absolute; top: 15px; right: 25px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;"
                onclick="closeEditor()">&times;</span>
            <h3 id="editorTitle">Edit Content</h3>
            <textarea id="contentEditor"
                style="width: 100%; height: 400px; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 16px; resize: vertical;"></textarea>
            <div style="margin-top: 20px; text-align: right;">
                <button onclick="closeEditor()"
                    style="padding: 10px 20px; margin-right: 10px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                <button onclick="saveContent()"
                    style="padding: 10px 20px; background: #004080; color: white; border: none; border-radius: 5px; cursor: pointer;">Save
                    Changes</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD3oMlsv9C3Qepvkw_Y1JVfhVJiMwZLox4",
            authDomain: "bsceee-webpage.firebaseapp.com",
            databaseURL: "https://bsceee-webpage-default-rtdb.firebaseio.com",
            projectId: "bsceee-webpage",
            storageBucket: "bsceee-webpage.appspot.com",
            messagingSenderId: "281106710079",
            appId: "1:281106710079:web:2c6ab931bc3cab8e4e428a",
            measurementId: "G-B1M7SSEZYP"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let currentEditingSection = '';
        let currentContentTab = 'homepage';

        // Check authentication
        auth.onAuthStateChanged((user) => {
            if (user) {
                // Check if user is admin
                db.ref('admins/' + user.uid).once('value').then((snapshot) => {
                    if (snapshot.exists()) {
                        const adminData = snapshot.val();
                        document.getElementById('adminName').textContent = `Welcome, ${adminData.name || 'Admin'}`;
                        loadDashboardData();
                    } else {
                        // Not admin, redirect to login
                        window.location.href = 'admin-login.html';
                    }
                });
            } else {
                // Not logged in, redirect to login
                window.location.href = 'admin-login.html';
            }
        });

        // Navigation functions
        function showSection(sectionName) {
            console.log('Showing section:', sectionName);

            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });

            // Show selected section
            const targetSection = document.getElementById(sectionName + 'Section');
            if (targetSection) {
                targetSection.style.display = 'block';
            }

            // Update current section title
            const titles = {
                'dashboard': 'Dashboard Overview',
                'content': 'Content Management',
                'registrations': 'Student Registrations',
                'complaints': 'Academic Complaints Management',
                'groups': 'Group Management',
                'pending': 'Pending Students',
                'announcements': 'Announcements Management',
                'users': 'User Management',
                'settings': 'System Settings'
            };
            document.getElementById('currentSection').textContent = titles[sectionName] || sectionName;

            // Update active nav
            document.querySelectorAll('.nav-links li').forEach(li => {
                li.classList.remove('active');
            });
            event.target.closest('li').classList.add('active');
        }

        function showContentTab(tabName) {
            console.log('Showing tab:', tabName);

            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });

            event.target.classList.add('active');
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.style.display = 'block';
            }
            currentContentTab = tabName;
        }

        // Content editing functions
        function editContent(section) {
            console.log('Editing section:', section);
            currentEditingSection = section;
            const modal = document.getElementById('editorModal');
            const editor = document.getElementById('contentEditor');
            const title = document.getElementById('editorTitle');

            if (!modal || !editor || !title) {
                console.error('Modal elements not found!');
                return;
            }

            // Set title
            const sectionTitles = {
                'hero': 'Edit Hero Section',
                'about': 'Edit About Section',
                'features': 'Edit Features Section',
                'news': 'Edit News Section',
                'funFacts': 'Edit Fun Facts',
                'spotlight': 'Edit Student Spotlight',
                'quiz': 'Edit Weekly Quiz'
            };
            title.textContent = sectionTitles[section] || 'Edit Content';

            // Load current content
            db.ref('websiteContent/' + section).once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    if (section === 'hero') {
                        editor.value = (data.title || '') + '\n---\n' + (data.subtitle || '');
                    } else if (section === 'funFacts' && data.items) {
                        editor.value = data.items.join('\n');
                    } else {
                        editor.value = data.content || '';
                    }
                } else {
                    editor.value = ''; // Empty if no data
                }

                // Show modal after content is loaded
                modal.style.display = 'block';
            }).catch(error => {
                console.error('Error loading content:', error);
                editor.value = '';
                modal.style.display = 'block';
            });
        }

        function closeEditor() {
            const modal = document.getElementById('editorModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function saveContent() {
            const editor = document.getElementById('contentEditor');
            if (!editor) {
                console.error('Editor not found!');
                return;
            }

            const newContent = editor.value;
            console.log('Saving content for:', currentEditingSection);

            let updatePromise;

            if (currentEditingSection === 'hero') {
                const lines = newContent.split('\n---\n');
                updatePromise = db.ref('websiteContent/hero').set({
                    title: lines[0] || '',
                    subtitle: lines[1] || ''
                });
            } else if (currentEditingSection === 'funFacts') {
                const facts = newContent.split('\n').filter(fact => fact.trim() !== '');
                updatePromise = db.ref('websiteContent/funFacts').set({
                    items: facts
                });
            } else {
                updatePromise = db.ref('websiteContent/' + currentEditingSection).set({
                    content: newContent
                });
            }

            updatePromise.then(() => {
                closeEditor();
                alert(' Content updated successfully! Changes will appear on the website immediately.');
            }).catch(error => {
                console.error('Error saving content:', error);
                alert(' Error saving content: ' + error.message);
            });
        }

        // Load dashboard data
        function loadDashboardData() {
            // In loadDashboardData() function - update registration stats:
            // Load registration stats
            db.ref('registrations').once('value').then(snapshot => {
                const data = snapshot.val();
                let count = 0;

                if (data) {
                    // Count all students in nested structure
                    for (let part1 in data) {
                        const level1 = data[part1];
                        if (level1 && typeof level1 === 'object') {
                            for (let part2 in level1) {
                                const level2 = level1[part2];
                                if (level2 && typeof level2 === 'object') {
                                    for (let part3 in level2) {
                                        count++;
                                    }
                                }
                            }
                        }
                    }
                }

                document.getElementById('individualRegs').textContent = count;
                document.getElementById('totalStudents').textContent = count;
            });

            // Load group stats
            db.ref('groups').once('value').then(snapshot => {
                const data = snapshot.val();
                const count = data ? Object.keys(data).length : 0;
                document.getElementById('groupRegs').textContent = count;
                document.getElementById('totalGroups').textContent = count;
            });

            // Load pending stats
            db.ref('pending').once('value').then(snapshot => {
                const data = snapshot.val();
                let count = 0;
                if (data) {
                    // Count all pending students (handle nested structure)
                    for (let key in data) {
                        if (typeof data[key] === 'object') {
                            count += Object.keys(data[key]).length;
                        }
                    }
                }
                document.getElementById('pendingApproval').textContent = count;
                document.getElementById('pendingStudents').textContent = count;
            });
        }

        // Logout function
        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'admin-login.html';
            });
        }

        // Download functions
        function downloadRegistrations() {
            alert(' Export feature will be implemented soon!');
        }

        // Initialize modal close functionality
        document.addEventListener('DOMContentLoaded', function () {
            const modal = document.getElementById('editorModal');
            if (modal) {
                window.onclick = function (event) {
                    if (event.target === modal) {
                        closeEditor();
                    }
                }
            }

            // Add click listeners to action buttons for debugging
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    console.log('Action button clicked:', this.querySelector('h3').textContent);
                });
            });
        });



        // Temporary debug function - add this to your script
        function debugModal() {
            const modal = document.getElementById('editorModal');
            if (modal) {
                // Force proper styling
                modal.style.display = 'block';
                modal.style.position = 'fixed';
                modal.style.zIndex = '10000';
                modal.style.left = '0';
                modal.style.top = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
                modal.style.overflow = 'auto';

                console.log('Modal forced to show with proper styles');
            } else {
                console.log('Modal element not found');
            }
        }

        // Test it by calling debugModal() in console







        // Replace your existing editContent function with this:
        function editContent(section) {
            console.log('Editing section:', section);
            currentEditingSection = section;

            // Get modal elements
            const modal = document.getElementById('editorModal');
            const editor = document.getElementById('contentEditor');
            const title = document.getElementById('editorTitle');

            if (!modal || !editor || !title) {
                console.error('Modal elements not found!');
                return;
            }

            // Force modal styles
            modal.style.display = 'block';
            modal.style.position = 'fixed';
            modal.style.zIndex = '10000';
            modal.style.left = '0';
            modal.style.top = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
            modal.style.overflow = 'auto';

            // Set title
            const sectionTitles = {
                'hero': 'Edit Hero Section',
                'about': 'Edit About Section',
                'features': 'Edit Features Section',
                'news': 'Edit News Section',
                'funFacts': 'Edit Fun Facts',
                'spotlight': 'Edit Student Spotlight',
                'quiz': 'Edit Weekly Quiz'
            };
            title.textContent = sectionTitles[section] || 'Edit Content';

            // Load current content
            db.ref('websiteContent/' + section).once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    if (section === 'hero') {
                        editor.value = (data.title || '') + '\n---\n' + (data.subtitle || '');
                    } else if (section === 'funFacts' && data.items) {
                        editor.value = data.items.join('\n');
                    } else {
                        editor.value = data.content || '';
                    }
                } else {
                    editor.value = '';
                }
            }).catch(error => {
                console.error('Error loading content:', error);
                editor.value = '';
            });
        }


        // Debug function to check Firebase content
        function debugContent() {
            console.log('=== DEBUG: Checking Firebase Content ===');
            db.ref('websiteContent').once('value').then((snapshot) => {
                const allContent = snapshot.val();
                console.log('All website content:', allContent);

                if (allContent) {
                    for (let section in allContent) {
                        console.log(`Section "${section}":`, allContent[section]);
                    }
                } else {
                    console.log('No website content found in Firebase!');
                }
            }).catch(error => {
                console.error('Debug error:', error);
            });
        }

        // Run debug on page load
        setTimeout(debugContent, 2000);




        // Fixed function for nested registration structure
        function loadRegistrationsTable() {
            const tableBody = document.querySelector('#registrationsTable tbody');
            tableBody.innerHTML = `
        <tr>
            <td colspan="5" style="text-align: center; padding: 20px;">
                <i class="fas fa-spinner fa-spin"></i> Loading registrations...
            </td>
        </tr>
    `;

            db.ref('registrations').once('value').then(snapshot => {
                const data = snapshot.val();
                console.log('Raw registrations data:', data);

                if (!data) {
                    tableBody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 20px;">
                        No student registrations found in the database.
                    </td>
                </tr>
            `;
                    return;
                }

                const allRecords = [];

                // Process the nested structure: EB24  74481  24  data
                for (let part1 in data) { // EB24
                    const level1 = data[part1];
                    if (level1 && typeof level1 === 'object') {
                        for (let part2 in level1) { // 74481
                            const level2 = level1[part2];
                            if (level2 && typeof level2 === 'object') {
                                for (let part3 in level2) { // 24
                                    const studentData = level2[part3];
                                    if (studentData && typeof studentData === 'object') {
                                        // Build the full registration number
                                        const fullRegNo = `${part1}/${part2}/${part3}`;

                                        allRecords.push({
                                            name: studentData.name || "N/A",
                                            regNo: fullRegNo, // This will be "EB24/74481/24"
                                            phone: studentData.phone || "N/A",
                                            timestamp: studentData.timestamp || "N/A"
                                        });

                                        console.log(`Found student: ${fullRegNo}`, studentData);
                                    }
                                }
                            }
                        }
                    }
                }

                console.log('All processed records:', allRecords);

                // Sort: oldest to newest
                allRecords.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                // Clear and populate table
                tableBody.innerHTML = '';

                if (allRecords.length === 0) {
                    tableBody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 20px;">
                        No valid registration data found.
                    </td>
                </tr>
            `;
                } else {
                    allRecords.forEach((record, index) => {
                        const formattedDate = formatDate(record.timestamp);
                        const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${record.name}</td>
                        <td><strong>${record.regNo}</strong></td>
                        <td>${record.phone}</td>
                        <td>${formattedDate}</td>
                    </tr>
                `;
                        tableBody.insertAdjacentHTML("beforeend", row);
                    });
                }

            }).catch(error => {
                console.error("Error loading registrations:", error);
                tableBody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; color: red;">
                    Error loading registrations: ${error.message}
                </td>
            </tr>
        `;
            });
        }

        // Update the download function in admin dashboard
        function downloadRegistrations() {
            const tableBody = document.querySelector('#registrationsTable tbody');
            const rows = tableBody.querySelectorAll('tr');

            if (rows.length === 0 || rows[0].querySelector('td[colspan]')) {
                alert("Please load registrations first by clicking 'Load Registrations'");
                return;
            }

            alert("Export feature will be implemented soon! For now, use the separate registration viewer page.");
        }

        // ... all your existing JavaScript code ...

        // Add this at the very end, before the closing tag
        function formatDate(timestamp) {
            if (!timestamp || timestamp === 'N/A') return 'N/A';
            try {
                const date = new Date(timestamp);
                return date.toLocaleString();
            } catch (e) {
                return timestamp;
            }
        }










        // ===== STUDY DOCUMENTS FUNCTIONS =====
        function addStudyDocument() {
            const semester = document.getElementById('semesterSelect').value;
            const course = document.getElementById('courseSelect').value;
            const docType = document.getElementById('docTypeSelect').value;
            const title = document.getElementById('docTitle').value;
            const driveLink = document.getElementById('driveLink').value;

            // Get custom inputs if "other" is selected
            const customSemester = document.getElementById('customSemester').value;
            const customCourse = document.getElementById('customCourse').value;

            if (!title || !driveLink) {
                alert('Please fill in both document title and Google Drive link');
                return;
            }

            // Use custom values if provided, otherwise use dropdown values
            const finalSemester = semester === 'other' ? customSemester.toLowerCase().replace(/\s+/g, '') : semester;
            const finalCourse = course === 'other' ? customCourse.toUpperCase().replace(/\s+/g, '') : course;

            if (!finalSemester) {
                alert('Please enter a semester name');
                return;
            }

            if (!finalCourse) {
                alert('Please enter a course code');
                return;
            }

            const docData = {
                title: title,
                type: docType,
                driveLink: driveLink,
                timestamp: new Date().toISOString(),
                addedBy: auth.currentUser.uid
            };

            const docId = Date.now().toString();
            const docPath = `studyDocuments/${finalSemester}/${finalCourse}/${docId}`;

            db.ref(docPath).set(docData)
                .then(() => {
                    alert(' Document added successfully!');
                    clearStudyDocForm();
                    loadExistingStudyDocs();
                })
                .catch(error => {
                    console.error('Error adding document:', error);
                    alert(' Error adding document: ' + error.message);
                });
        }

        function toggleCustomInputs() {
            const semesterSelect = document.getElementById('semesterSelect').value;
            const courseSelect = document.getElementById('courseSelect').value;

            // Show/hide custom semester input
            if (semesterSelect === 'other') {
                document.getElementById('customSemesterGroup').style.display = 'block';
            } else {
                document.getElementById('customSemesterGroup').style.display = 'none';
                document.getElementById('customSemester').value = '';
            }

            // Show/hide custom course input
            if (courseSelect === 'other') {
                document.getElementById('customCourseGroup').style.display = 'block';
            } else {
                document.getElementById('customCourseGroup').style.display = 'none';
                document.getElementById('customCourse').value = '';
            }
        }

        function clearStudyDocForm() {
            // Safe clearing with null checks
            const elements = {
                'docTitle': '',
                'driveLink': '',
                'customSemester': '',
                'customCourse': ''
            };

            for (const [id, value] of Object.entries(elements)) {
                const element = document.getElementById(id);
                if (element) {
                    element.value = value;
                }
            }

            // Hide custom input groups
            const customSemesterGroup = document.getElementById('customSemesterGroup');
            const customCourseGroup = document.getElementById('customCourseGroup');
            if (customSemesterGroup) customSemesterGroup.style.display = 'none';
            if (customCourseGroup) customCourseGroup.style.display = 'none';

            // Reset dropdowns to default
            const semesterSelect = document.getElementById('semesterSelect');
            const courseSelect = document.getElementById('courseSelect');
            const docTypeSelect = document.getElementById('docTypeSelect');
            if (semesterSelect) semesterSelect.value = 'year1sem1';
            if (courseSelect) courseSelect.value = 'EENG111';
            if (docTypeSelect) docTypeSelect.value = 'exam';
        }
        // The loadExistingStudyDocs and deleteStudyDoc functions remain the same
        function loadExistingStudyDocs() {
            const container = document.getElementById('existingDocsList');
            container.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Loading documents...</p>';

            console.log('Loading existing study docs...');

            db.ref('studyDocuments').once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    console.log('Raw Firebase data:', data);

                    if (!data) {
                        container.innerHTML = '<p>No documents found in the database.</p>';
                        return;
                    }

                    let html = '<table style="width: 100%; border: 1px solid #ddd;"><thead><tr style="background: #f8f9fa;"><th>Semester</th><th>Course</th><th>Title</th><th>Type</th><th>Actions</th></tr></thead><tbody>';

                    let docCount = 0;

                    for (const semester in data) {
                        if (data.hasOwnProperty(semester)) {
                            for (const course in data[semester]) {
                                if (data[semester].hasOwnProperty(course)) {
                                    for (const docId in data[semester][course]) {
                                        if (data[semester][course].hasOwnProperty(docId)) {
                                            const doc = data[semester][course][docId];
                                            const semesterDisplay = getSemesterDisplayName(semester);
                                            html += `
                                        <tr>
                                            <td><strong>${semesterDisplay}</strong></td>
                                            <td><code>${course}</code></td>
                                            <td>${doc.title}</td>
                                            <td><span style="background: #e9ecef; padding: 2px 6px; border-radius: 4px; font-size: 0.8em;">${doc.type}</span></td>
                                            <td>
                                                <button onclick="deleteStudyDoc('${semester}', '${course}', '${docId}')" class="btn btn-secondary" style="padding: 5px 10px; margin: 2px; background: #dc3545;">Delete</button>
                                            </td>
                                        </tr>
                                    `;
                                            docCount++;
                                        }
                                    }
                                }
                            }
                        }
                    }

                    if (docCount === 0) {
                        html = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No documents found in the database structure.</td></tr>';
                    }

                    html += '</tbody></table>';
                    html += `<p style="margin-top: 10px; color: #666;">Total documents: ${docCount}</p>`;

                    container.innerHTML = html;
                    console.log(`Displayed ${docCount} documents`);
                })
                .catch(error => {
                    console.error('Error loading documents:', error);
                    container.innerHTML = `<p style="color: red;">Error loading documents: ${error.message}</p>`;
                });
        }

        function deleteStudyDoc(semester, course, docId) {
            if (confirm('Are you sure you want to delete this document?')) {
                const docPath = `studyDocuments/${semester}/${course}/${docId}`;
                db.ref(docPath).remove()
                    .then(() => {
                        alert(' Document deleted successfully!');
                        loadExistingStudyDocs();
                    })
                    .catch(error => {
                        console.error('Error deleting document:', error);
                        alert(' Error deleting document: ' + error.message);
                    });
            }
        }

        function getSemesterDisplayName(semesterKey) {
            const names = {
                'year1sem1': 'Year 1 Semester 1',
                'year1sem2': 'Year 1 Semester 2',
                'year2sem1': 'Year 2 Semester 1',
                'year2sem2': 'Year 2 Semester 2'
            };
            return names[semesterKey] || semesterKey; // Return custom name if not in predefined list
        }



















        // ===== MIGRATION SCRIPT - Run this once to import existing documents =====
        function migrateExistingDocuments() {
            if (!confirm('This will import all your existing study documents to Firebase. Continue?')) {
                return;
            }

            const documentsToImport = [
                // Year 1 Semester 1
                { semester: 'year1sem1', course: 'EENG111', type: 'exam', title: 'EXAM 2024/2025', link: 'https://drive.google.com/file/d/1QJrQWIMP0tYOBlEj5mR-ZG5GF8VYI90J/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'EENG112', type: 'exam', title: 'EXAM 2024/2025', link: 'https://drive.google.com/file/d/1REVn1DN97hDvPnzcKDN22uQJ5PYfN6tt/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'CHEM110', type: 'exam', title: 'EXAM 2024/2025', link: 'https://drive.google.com/file/d/1fp06-1XxW6lnmNCqa3Y6a_FuHKBZCvz6/view?usp=sharing' },
                { semester: 'year1sem1', course: 'CHEM110', type: 'cat', title: 'CAT', link: 'https://drive.google.com/file/d/1JUJqYgeMvOI1ReZ6JPkkHY4WDQwWHFN0/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'PHYS112', type: 'exam', title: 'EXAM 2024/2025', link: 'https://drive.google.com/file/d/1qsEaTDzqfQ5TvBlTPlxUEAhzUt7lWEwM/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'PHYS112', type: 'cat', title: 'CAT', link: 'https://drive.google.com/file/d/1URzodwdwE4CjeSYMOwHjiyo0Vv8mr72l/view?usp=sharing' },
                { semester: 'year1sem1', course: 'PHYS121', type: 'exam', title: 'EXAM 2024/2025', link: 'https://drive.google.com/file/d/1fyTMWRu75SQ216SeDkwB_jDOHTmXQORv/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'COSC121', type: 'exam', title: 'EXAM 2024/2025', link: 'https://drive.google.com/file/d/1LwUcdnsYAOPGwHyqDu1O6A0Et060vR0p/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'COSC121', type: 'cat', title: 'CAT', link: 'https://drive.google.com/file/d/1EodLFtCVemhQEJuSYsAS_PobhXL83Z63/view?usp=sharing' },
                { semester: 'year1sem1', course: 'COMS101', type: 'exam', title: 'EXAM 2024/2025', link: 'https://drive.google.com/file/d/1d6JODYtjigXzJyWHY-B9U_4yLHAtBzTW/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'MATH121', type: 'exam', title: 'EXAM 2024/2025', link: 'https://drive.google.com/file/d/17YZyEANfHkp1uPip2WvO1nxav5p2RGhe/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'MATH122', type: 'exam', title: 'EXAM 2024/2025', link: 'https://drive.google.com/file/d/1bSlw1vuTFhaUnA2yIbjziRXuHM6bIAZW/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'MATH122', type: 'notes', title: 'CHAP 1 NOTES', link: 'https://drive.google.com/file/d/1BhJoyTRkHPeUGFrUBCRxyx0rgRzrRVMB/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'MATH122', type: 'notes', title: 'CHAP 2 NOTES', link: 'https://drive.google.com/file/d/1QkCuGOFlmfAFelN-1ckMBzZDLgzjf3eO/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'MATH122', type: 'notes', title: 'CHAP 3 NOTES', link: 'https://drive.google.com/file/d/1uWeEfdP9Ev3jESKbxt4_O0dvakAoQeGa/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'MATH122', type: 'notes', title: 'CHAP 4 NOTES', link: 'https://drive.google.com/file/d/1H7DEENUgyZyskHQ6If-HFIp_DnDR-tCY/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'MATH122', type: 'notes', title: 'CHAP 5 NOTES', link: 'https://drive.google.com/file/d/1zFcfJUePpwZZ_voLvixtPtNq_9lt0CWl/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'MATH122', type: 'notes', title: 'CHAP 6 NOTES', link: 'https://drive.google.com/file/d/14UhDKvI4nO_rlmuU5RbjnjsCBoZtpKCQ/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'MATH122', type: 'notes', title: 'CHAP 7 NOTES', link: 'https://drive.google.com/file/d/1RL47la967qSHTI5_-CvVxC5g9VkoV_jf/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'MATH122', type: 'cat', title: 'CAT 2024/2025', link: 'https://drive.google.com/file/d/1VGJo6lRoj0otq4lzqnjMmld14U8FG8kl/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'MATH124', type: 'exam', title: 'EXAM 2024/2025', link: 'https://drive.google.com/file/d/1Ibov9ufvy5KrigiOldchXJs-Lzw3CPLJ/view?usp=drive_link' },
                { semester: 'year1sem1', course: 'ZOOL143', type: 'cat', title: 'CAT', link: 'https://drive.google.com/file/d/17nv0oDRoVP8N6efXYRgKe0bNj5QHyujk/view?usp=sharing' },

                // Year 1 Semester 2
                { semester: 'year1sem2', course: 'EENG113', type: 'exam', title: 'EXAM 2024-2025', link: 'https://drive.google.com/file/d/1kgGwJgY2eNEVE5IMZ4EwPkdxNj2CzssT/view?usp=drive_link' },
                { semester: 'year1sem2', course: 'EENG113', type: 'cat', title: 'CAT', link: 'https://drive.google.com/file/d/1HFQhF9Exn5npidFUZgtdayvXDWUX0GU3/view?usp=sharing' },
                { semester: 'year1sem2', course: 'EENG114', type: 'exam', title: 'EXAM 2024-2025', link: 'https://drive.google.com/file/d/1a6nKh_J9l6J1bJVhjEM8Rdxu_dbyA5J2/view?usp=sharing' },
                { semester: 'year1sem2', course: 'EENG114', type: 'cat', title: 'CAT', link: 'https://drive.google.com/file/d/1IErq7xdcjIZfdoVgPh1covpJjqVY4g04/view?usp=drive_link' },
                { semester: 'year1sem2', course: 'PHYS113', type: 'exam', title: 'EXAM 2024-2025', link: 'https://drive.google.com/file/d/1LgO9Fhl_BuixQiNKKfFKVL5rT2VJA4AL/view?usp=drive_link' },
                { semester: 'year1sem2', course: 'PHYS113', type: 'cat', title: 'CAT', link: 'https://drive.google.com/file/d/16CWddnqdNfkhLNYi5OZI_IBf3AHNeuh3/view?usp=sharing' },
                { semester: 'year1sem2', course: 'PHYS122', type: 'exam', title: 'EXAM 2024-2025', link: 'https://drive.google.com/file/d/1Ya1L2CghH4Jf1w3ehxSafjMM3lzku9Iy/view?usp=drive_link' },
                { semester: 'year1sem2', course: 'COSC113', type: 'exam', title: 'EXAM 2024-2025', link: 'https://drive.google.com/file/d/1_h59cXbB-K-afahzdI5VDhpyy2XlChQe/view?usp=drive_link' },
                { semester: 'year1sem2', course: 'PHIL100', type: 'exam', title: 'EXAM 2024-2025', link: 'https://drive.google.com/file/d/1iZ69dZ0wnhtUdP90VTUBxvi0PsLml7ll/view?usp=drive_link' },
                { semester: 'year1sem2', course: 'MATH141', type: 'exam', title: 'EXAM 2024-2025', link: 'https://drive.google.com/file/d/10KyKkv0UaOvHvZvN8BhVVqmf8KQ18-rn/view?usp=drive_link' },
                { semester: 'year1sem2', course: 'CHEM120', type: 'cat', title: 'CAT', link: 'https://drive.google.com/file/d/15T3mxCIR3mExDqdQxQa4v2OCfqwFFzQ0/view?usp=drive_link' },

                // Year 2 Semester 1
                { semester: 'year2sem1', course: 'EENG291', type: 'notes', title: 'EENG 291 COURSE CONTENT', link: 'https://docs.google.com/document/d/1TTsZoSWrREe2Y7zFcAu2xFpCpRP9XGLP/edit?usp=drive_link&ouid=113351626153168999137&rtpof=true&sd=true' },
                { semester: 'year2sem1', course: 'EENG291', type: 'notes', title: 'WEEK 2 NOTES', link: 'https://drive.google.com/file/d/1Tfy591E54GbKw9RQ0J32ctvHOVkem968/view?usp=drive_link' },
                { semester: 'year2sem1', course: 'EENG291', type: 'notes', title: 'WEEK 3 NOTES', link: 'https://docs.google.com/document/d/11a9GuxEp87PKa78rxm1CIbShivSzIm_z/edit?usp=sharing&ouid=113351626153168999137&rtpof=true&sd=true' },
                { semester: 'year2sem1', course: 'EENG291', type: 'notes', title: 'WEEK 4 NOTES', link: 'https://drive.google.com/file/d/1MZj-kISNohgTgMZDtQBnOZBet-cLbvGp/view?usp=sharing' },
                { semester: 'year2sem1', course: 'EENG291', type: 'notes', title: 'WEEK 4B NOTES', link: 'https://docs.google.com/document/d/13etf-COBHqmz95Z-0ZhXMbjpfnTl56UW/edit?usp=sharing&ouid=113351626153168999137&rtpof=true&sd=true' },
                { semester: 'year2sem1', course: 'EENG271', type: 'notes', title: 'EENG 271 COURSE CONTENT', link: 'https://drive.google.com/file/d/1-t-xpkjPISKrqhpFJRhNtzKKlKptoFUt/view?usp=drive_link' },
                { semester: 'year2sem1', course: 'EENG271', type: 'notes', title: 'WEEK 2 NOTES', link: 'https://drive.google.com/file/d/1HkpEjb4K-KyDs5KMQq6P5SJ0LBqwNxj_/view?usp=sharing' },
                { semester: 'year2sem1', course: 'EENG271', type: 'notes', title: 'WEEK 3 NOTES', link: 'https://docs.google.com/document/d/110nFOfuHm2mUQ3kcQpi_Ollm46lNBFGt/edit?usp=sharing&ouid=113351626153168999137&rtpof=true&sd=true' },
                { semester: 'year2sem1', course: 'EENG271', type: 'notes', title: 'WEEK 4 NOTES', link: 'https://docs.google.com/document/d/1Gss-R3n_7yfQf_zq3bbKI0vwymRtdK-Y/edit?usp=sharing&ouid=113351626153168999137&rtpof=true&sd=true' }
            ];

            let importedCount = 0;
            const totalCount = documentsToImport.length;

            documentsToImport.forEach((doc, index) => {
                const docData = {
                    title: doc.title,
                    type: doc.type,
                    driveLink: doc.link,
                    timestamp: new Date().toISOString(),
                    addedBy: auth.currentUser.uid
                };

                const docId = Date.now().toString() + index; // Unique ID for each doc
                const docPath = `studyDocuments/${doc.semester}/${doc.course}/${docId}`;

                db.ref(docPath).set(docData)
                    .then(() => {
                        importedCount++;
                        console.log(`Imported: ${doc.course} - ${doc.title}`);

                        if (importedCount === totalCount) {
                            alert(` Successfully imported ${importedCount} documents to Firebase!`);
                            loadExistingStudyDocs();
                        }
                    })
                    .catch(error => {
                        console.error(`Error importing ${doc.course} - ${doc.title}:`, error);
                        importedCount++;
                    });
            });
        }



        function showContentTab(tabName) {
            console.log('Showing tab:', tabName);

            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });

            event.target.classList.add('active');
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.style.display = 'block';
            }
            currentContentTab = tabName;

            // ADD THIS LINE - Load study docs when tab is opened
            if (tabName === 'studydocs') {
                loadExistingStudyDocs();
            }
        }





        // Timetable Management Functions
        let currentTimetableTab = 'regular';

        function showTimetableTab(tabName) {
            currentTimetableTab = tabName;

            // Update tabs
            document.querySelectorAll('#timetableTab .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#timetableTab .tab-content').forEach(content => {
                content.style.display = 'none';
            });

            event.target.classList.add('active');
            document.getElementById(tabName + 'TimetableTab').style.display = 'block';
        }

        function loadTimetableData() {
            console.log('Loading timetable data...');

            // Load regular timetable
            db.ref('timetable/regular').once('value').then(snapshot => {
                const data = snapshot.val();
                if (data) {
                    document.getElementById('regularPeriod').value = data.period || '';
                    populateRegularTimetable(data.schedule);
                } else {
                    initializeRegularTimetable();
                }
            });

            // Load exam timetable
            db.ref('timetable/exam').once('value').then(snapshot => {
                const data = snapshot.val();
                if (data) {
                    document.getElementById('examPeriod').value = data.period || '';
                    populateExamTimetable(data.schedule);
                } else {
                    initializeExamTimetable();
                }
            });
        }

        function initializeRegularTimetable() {
            const timeSlots = [
                '7:00 AM - 10:00 AM',
                '10:00 AM - 1:00 PM',
                '1:00 PM - 4:00 PM',
                '4:00 PM - 7:00 PM'
            ];

            const timetableBody = document.getElementById('regularTimetableBody');
            timetableBody.innerHTML = '';

            timeSlots.forEach(time => {
                const row = document.createElement('tr');
                row.innerHTML = `
            <td class="time-slot">${time}</td>
            <td><textarea placeholder="Unit code, venue..."></textarea></td>
            <td><textarea placeholder="Unit code, venue..."></textarea></td>
            <td><textarea placeholder="Unit code, venue..."></textarea></td>
            <td><textarea placeholder="Unit code, venue..."></textarea></td>
            <td><textarea placeholder="Unit code, venue..."></textarea></td>
        `;
                timetableBody.appendChild(row);
            });
        }
        function populateRegularTimetable(schedule) {
            if (!schedule || !Array.isArray(schedule)) {
                initializeRegularTimetable();
                return;
            }

            const timetableBody = document.getElementById('regularTimetableBody');
            timetableBody.innerHTML = '';

            // Sort the schedule array to ensure correct order (in case it gets messed up)
            const sortedSchedule = [...schedule].sort((a, b) => {
                const timeOrder = {
                    '7:00 AM - 10:00 AM': 1,
                    '10:00 AM - 1:00 PM': 2,
                    '1:00 PM - 4:00 PM': 3,
                    '4:00 PM - 7:00 PM': 4
                };
                return (timeOrder[a.timeSlot] || 0) - (timeOrder[b.timeSlot] || 0);
            });

            sortedSchedule.forEach((dayData, index) => {
                const row = document.createElement('tr');

                row.innerHTML = `
            <td class="time-slot">${dayData.timeSlot || getDefaultTimeSlot(index)}</td>
            <td><textarea>${dayData.Monday || ''}</textarea></td>
            <td><textarea>${dayData.Tuesday || ''}</textarea></td>
            <td><textarea>${dayData.Wednesday || ''}</textarea></td>
            <td><textarea>${dayData.Thursday || ''}</textarea></td>
            <td><textarea>${dayData.Friday || ''}</textarea></td>
        `;

                timetableBody.appendChild(row);
            });
        }

        function getDefaultTimeSlot(index) {
            const defaultSlots = [
                '7:00 AM - 10:00 AM',
                '10:00 AM - 1:00 PM',
                '1:00 PM - 4:00 PM',
                '4:00 PM - 7:00 PM'
            ];
            return defaultSlots[index] || '';
        }
        function initializeExamTimetable() {
            const examBody = document.getElementById('examTimetableBody');
            examBody.innerHTML = `
        <tr>
            <td><input type="date" placeholder="Date"></td>
            <td><input type="text" placeholder="e.g., 8:00 AM - 11:00 AM"></td>
            <td><input type="text" placeholder="Unit code"></td>
            <td><input type="text" placeholder="Unit name"></td>
            <td><input type="text" placeholder="Venue"></td>
            <td><button type="button" class="delete-row" onclick="deleteExamRow(this)"></button></td>
        </tr>
    `;
        }

        function populateExamTimetable(schedule) {
            const examBody = document.getElementById('examTimetableBody');
            examBody.innerHTML = '';

            if (!schedule || Object.keys(schedule).length === 0) {
                initializeExamTimetable();
                return;
            }

            Object.keys(schedule).forEach(examId => {
                const exam = schedule[examId];
                const row = document.createElement('tr');

                row.innerHTML = `
            <td><input type="date" value="${exam.date || ''}"></td>
            <td><input type="text" value="${exam.time || ''}" placeholder="e.g., 8:00 AM - 11:00 AM"></td>
            <td><input type="text" value="${exam.unitCode || ''}" placeholder="Unit code"></td>
            <td><input type="text" value="${exam.unitName || ''}" placeholder="Unit name"></td>
            <td><input type="text" value="${exam.venue || ''}" placeholder="Venue"></td>
            <td><button type="button" class="delete-row" onclick="deleteExamRow(this)"></button></td>
        `;

                examBody.appendChild(row);
            });
        }

        function addExamRow() {
            const examBody = document.getElementById('examTimetableBody');
            const newRow = document.createElement('tr');

            newRow.innerHTML = `
        <td><input type="date"></td>
        <td><input type="text" placeholder="e.g., 8:00 AM - 11:00 AM"></td>
        <td><input type="text" placeholder="Unit code"></td>
        <td><input type="text" placeholder="Unit name"></td>
        <td><input type="text" placeholder="Venue"></td>
        <td><button type="button" class="delete-row" onclick="deleteExamRow(this)"></button></td>
    `;

            examBody.appendChild(newRow);
        }

        function deleteExamRow(button) {
            if (document.querySelectorAll('#examTimetableBody tr').length > 1) {
                button.closest('tr').remove();
            } else {
                alert('Cannot delete the last row. At least one exam entry is required.');
            }
        }

        function saveTimetableData() {
            // Save regular timetable
            const regularPeriod = document.getElementById('regularPeriod').value;
            const regularRows = document.querySelectorAll('#regularTimetableBody tr');

            // Use array to maintain order
            const regularSchedule = [
                '7:00 AM - 10:00 AM',
                '10:00 AM - 1:00 PM',
                '1:00 PM - 4:00 PM',
                '4:00 PM - 7:00 PM'
            ].map((timeSlot, index) => {
                const cells = regularRows[index].querySelectorAll('textarea');
                return {
                    timeSlot: timeSlot,
                    Monday: cells[0].value,
                    Tuesday: cells[1].value,
                    Wednesday: cells[2].value,
                    Thursday: cells[3].value,
                    Friday: cells[4].value
                };
            });

            // Save exam timetable (this can remain as object since order doesn't matter as much)
            const examPeriod = document.getElementById('examPeriod').value;
            const examRows = document.querySelectorAll('#examTimetableBody tr');
            const examSchedule = {};

            examRows.forEach((row, index) => {
                const inputs = row.querySelectorAll('input');
                examSchedule[`exam_${index}`] = {
                    date: inputs[0].value,
                    time: inputs[1].value,
                    unitCode: inputs[2].value,
                    unitName: inputs[3].value,
                    venue: inputs[4].value
                };
            });

            // Save to Firebase
            const updates = {
                'timetable/regular': {
                    period: regularPeriod,
                    schedule: regularSchedule  // Now this is an array, not an object
                },
                'timetable/exam': {
                    period: examPeriod,
                    schedule: examSchedule
                }
            };

            db.ref().update(updates)
                .then(() => {
                    alert(' Timetable saved successfully!');
                })
                .catch(error => {
                    console.error('Error saving timetable:', error);
                    alert(' Error saving timetable: ' + error.message);
                });
        }

        // Load timetable data when the tab is opened
        function showContentTab(tabName) {
            console.log('Showing tab:', tabName);

            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });

            event.target.classList.add('active');
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.style.display = 'block';
            }
            currentContentTab = tabName;

            // Load data when specific tabs are opened
            if (tabName === 'studydocs') {
                loadExistingStudyDocs();
            }
            if (tabName === 'timetable') {
                loadTimetableData();
            }
        }





        // Personnel Management Functions
        let currentPersonnelSubTab = 'classLeadership';

        function showPersonnelSubTab(tabName) {
            currentPersonnelSubTab = tabName;

            // Update tabs
            document.querySelectorAll('#personnelTab .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#personnelTab .tab-content').forEach(content => {
                content.style.display = 'none';
            });

            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').style.display = 'block';

            // Load data for the selected tab
            if (tabName === 'lecturers') {
                loadLecturers();
            } else {
                loadPersonnelData(tabName);
            }
        }

        function loadPersonnelData(section) {
            const bodyId = section + 'Body';
            const tableBody = document.getElementById(bodyId);

            tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';

            db.ref('personnel/' + section).once('value').then(snapshot => {
                const data = snapshot.val();
                tableBody.innerHTML = '';

                if (!data) {
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No data found. Add new entries using the button above.</td></tr>';
                    return;
                }

                Object.keys(data).forEach(key => {
                    const person = data[key];
                    const row = document.createElement('tr');

                    if (section === 'lecturers') {
                        row.innerHTML = `
                    <td><input type="text" value="${person.course || ''}" class="personnel-input" data-field="course"></td>
                    <td><input type="text" value="${person.name || ''}" class="personnel-input" data-field="name"></td>
                    <td><input type="text" value="${person.phone || ''}" class="personnel-input" data-field="phone"></td>
                    <td>
                        <button class="btn" onclick="savePersonnelRow('${section}', '${key}', this)">Save</button>
                        <button class="btn btn-secondary" onclick="deletePersonnelRow('${section}', '${key}')">Delete</button>
                    </td>
                `;
                    } else {
                        row.innerHTML = `
                    <td><input type="text" value="${person.position || ''}" class="personnel-input" data-field="position"></td>
                    <td><input type="text" value="${person.name || ''}" class="personnel-input" data-field="name"></td>
                    <td><input type="text" value="${person.phone || ''}" class="personnel-input" data-field="phone"></td>
                    <td><textarea class="personnel-input" data-field="role" style="width: 100%; height: 60px; resize: vertical;">${person.role || ''}</textarea></td>
                    <td>
                        <button class="btn" onclick="savePersonnelRow('${section}', '${key}', this)">Save</button>
                        <button class="btn btn-secondary" onclick="deletePersonnelRow('${section}', '${key}')">Delete</button>
                    </td>
                `;
                    }

                    tableBody.appendChild(row);
                });
            }).catch(error => {
                console.error('Error loading personnel data:', error);
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">Error loading data</td></tr>';
            });
        }

        function loadLecturers() {
            const semester = document.getElementById('lecturerSemester').value;
            const tableBody = document.getElementById('lecturersBody');

            tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Loading lecturers...</td></tr>';

            db.ref('personnel/lecturers/' + semester).once('value').then(snapshot => {
                const data = snapshot.val();
                tableBody.innerHTML = '';

                if (!data) {
                    tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">No lecturers found for this semester.</td></tr>';
                    return;
                }

                Object.keys(data).forEach(key => {
                    const lecturer = data[key];
                    const row = document.createElement('tr');

                    row.innerHTML = `
                <td><input type="text" value="${lecturer.course || ''}" class="personnel-input" data-field="course"></td>
                <td><input type="text" value="${lecturer.name || ''}" class="personnel-input" data-field="name"></td>
                <td><input type="text" value="${lecturer.phone || ''}" class="personnel-input" data-field="phone"></td>
                <td>
                    <button class="btn" onclick="saveLecturerRow('${semester}', '${key}', this)">Save</button>
                    <button class="btn btn-secondary" onclick="deleteLecturerRow('${semester}', '${key}')">Delete</button>
                </td>
            `;

                    tableBody.appendChild(row);
                });
            }).catch(error => {
                console.error('Error loading lecturers:', error);
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: red;">Error loading lecturers</td></tr>';
            });
        }

        function addPersonnelRow(section) {
            const tableBody = document.getElementById(section + 'Body');
            const newId = 'new_' + Date.now();

            let row;
            if (section === 'lecturers') {
                row = document.createElement('tr');
                row.innerHTML = `
            <td><input type="text" placeholder="Course code" class="personnel-input" data-field="course"></td>
            <td><input type="text" placeholder="Lecturer name" class="personnel-input" data-field="name"></td>
            <td><input type="text" placeholder="Phone number" class="personnel-input" data-field="phone"></td>
            <td>
                <button class="btn" onclick="savePersonnelRow('${section}', '${newId}', this)">Save</button>
                <button class="btn btn-secondary" onclick="this.closest('tr').remove()">Cancel</button>
            </td>
        `;
            } else {
                row = document.createElement('tr');
                row.innerHTML = `
            <td><input type="text" placeholder="Position" class="personnel-input" data-field="position"></td>
            <td><input type="text" placeholder="Name" class="personnel-input" data-field="name"></td>
            <td><input type="text" placeholder="Phone" class="personnel-input" data-field="phone"></td>
            <td><textarea placeholder="Role description" class="personnel-input" data-field="role" style="width: 100%; height: 60px; resize: vertical;"></textarea></td>
            <td>
                <button class="btn" onclick="savePersonnelRow('${section}', '${newId}', this)">Save</button>
                <button class="btn btn-secondary" onclick="this.closest('tr').remove()">Cancel</button>
            </td>
        `;
            }

            tableBody.appendChild(row);
        }

        function addLecturerRow() {
            const semester = document.getElementById('lecturerSemester').value;
            const tableBody = document.getElementById('lecturersBody');
            const newId = 'new_' + Date.now();

            const row = document.createElement('tr');
            row.innerHTML = `
        <td><input type="text" placeholder="Course code" class="personnel-input" data-field="course"></td>
        <td><input type="text" placeholder="Lecturer name" class="personnel-input" data-field="name"></td>
        <td><input type="text" placeholder="Phone number" class="personnel-input" data-field="phone"></td>
        <td>
            <button class="btn" onclick="saveLecturerRow('${semester}', '${newId}', this)">Save</button>
            <button class="btn btn-secondary" onclick="this.closest('tr').remove()">Cancel</button>
        </td>
    `;

            tableBody.appendChild(row);
        }

        function savePersonnelRow(section, key, button) {
            const row = button.closest('tr');
            const inputs = row.querySelectorAll('.personnel-input');

            const data = {};
            inputs.forEach(input => {
                data[input.getAttribute('data-field')] = input.value;
            });

            db.ref('personnel/' + section + '/' + key).set(data)
                .then(() => {
                    alert(' Saved successfully!');
                    loadPersonnelData(section);
                })
                .catch(error => {
                    console.error('Error saving personnel data:', error);
                    alert(' Error saving data: ' + error.message);
                });
        }

        function saveLecturerRow(semester, key, button) {
            const row = button.closest('tr');
            const inputs = row.querySelectorAll('.personnel-input');

            const data = {};
            inputs.forEach(input => {
                data[input.getAttribute('data-field')] = input.value;
            });

            db.ref('personnel/lecturers/' + semester + '/' + key).set(data)
                .then(() => {
                    alert(' Lecturer saved successfully!');
                    loadLecturers();
                })
                .catch(error => {
                    console.error('Error saving lecturer:', error);
                    alert(' Error saving lecturer: ' + error.message);
                });
        }

        function deletePersonnelRow(section, key) {
            if (confirm('Are you sure you want to delete this entry?')) {
                db.ref('personnel/' + section + '/' + key).remove()
                    .then(() => {
                        alert(' Entry deleted successfully!');
                        loadPersonnelData(section);
                    })
                    .catch(error => {
                        console.error('Error deleting entry:', error);
                        alert(' Error deleting entry: ' + error.message);
                    });
            }
        }

        function deleteLecturerRow(semester, key) {
            if (confirm('Are you sure you want to delete this lecturer?')) {
                db.ref('personnel/lecturers/' + semester + '/' + key).remove()
                    .then(() => {
                        alert(' Lecturer deleted successfully!');
                        loadLecturers();
                    })
                    .catch(error => {
                        console.error('Error deleting lecturer:', error);
                        alert(' Error deleting lecturer: ' + error.message);
                    });
            }
        }

        // Update the showContentTab function to load personnel data
        function showContentTab(tabName) {
            console.log('Showing tab:', tabName);

            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });

            event.target.classList.add('active');
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.style.display = 'block';
            }
            currentContentTab = tabName;

            // Load data when specific tabs are opened
            if (tabName === 'studydocs') {
                loadExistingStudyDocs();
            }
            if (tabName === 'timetable') {
                loadTimetableData();
            }
            if (tabName === 'personnel') {
                loadPersonnelData('classLeadership');
            }
        }








        // ===== SECTION CREATOR - COMPLETE NEW VERSION =====

        // Section Creator Variables
        let documentItems = [];
        let linkItems = [];

        // Initialize section creator
        function initSectionCreator() {
            console.log(' Initializing section creator...');

            // Set up event listeners
            setupEventListeners();

            // Initialize form fields
            toggleSectionFields();
            updatePreviews();

            // Load existing sections
            loadExistingSections();

            console.log(' Section creator initialized successfully');
        }

        // Set up all event listeners
        function setupEventListeners() {
            console.log(' Setting up event listeners...');

            // Section type change
            const sectionTypeSelect = document.getElementById('sectionType');
            if (sectionTypeSelect) {
                sectionTypeSelect.addEventListener('change', toggleSectionFields);
                console.log(' Section type listener added');
            }

            // Create section button
            const createBtn = document.getElementById('createSectionBtn');
            if (createBtn) {
                createBtn.addEventListener('click', handleCreateSection);
                console.log(' Create section button listener added');
            }

            // Test button
            const testBtn = document.getElementById('testButton');
            if (testBtn) {
                testBtn.addEventListener('click', handleTestButton);
                console.log(' Test button listener added');
            }

            // Add document button
            const addDocBtn = document.getElementById('addDocumentBtn');
            if (addDocBtn) {
                addDocBtn.addEventListener('click', addDocumentItem);
                console.log(' Add document button listener added');
            }

            // Add link button
            const addLinkBtn = document.getElementById('addLinkBtn');
            if (addLinkBtn) {
                addLinkBtn.addEventListener('click', addLinkItem);
                console.log(' Add link button listener added');
            }

            console.log(' All event listeners setup complete');
        }

        // Handle create section button click
        function handleCreateSection(event) {
            event.preventDefault();
            console.log(' Create section button clicked!');
            createNewSection();
        }

        // Handle test button click
        function handleTestButton(event) {
            event.preventDefault();
            console.log(' Test button clicked!');
            alert(' Test button is working! Section creator is ready.');
        }

        // Toggle form fields based on section type
        function toggleSectionFields() {
            const sectionType = document.getElementById('sectionType').value;
            console.log(' Toggling fields for:', sectionType);

            // Hide all fields
            const allFields = ['text', 'documents', 'links', 'custom'];
            allFields.forEach(type => {
                const field = document.getElementById(type + 'Fields');
                if (field) {
                    field.style.display = 'none';
                    console.log(' Hiding:', type + 'Fields');
                }
            });

            // Show relevant fields
            const targetField = document.getElementById(sectionType + 'Fields');
            if (targetField) {
                targetField.style.display = 'block';
                console.log(' Showing:', sectionType + 'Fields');
            }

            // Reset arrays when switching types
            if (sectionType !== 'documents') documentItems = [];
            if (sectionType !== 'links') linkItems = [];
            updatePreviews();
        }

        // Add document item
        function addDocumentItem() {
            const title = document.getElementById('docItemTitle').value;
            const link = document.getElementById('docItemLink').value;
            const desc = document.getElementById('docItemDesc').value;

            if (!title || !link) {
                alert('Please fill in title and link');
                return;
            }

            documentItems.push({
                title: title,
                link: link,
                description: desc,
                id: 'doc_' + Date.now()
            });

            // Clear form
            document.getElementById('docItemTitle').value = '';
            document.getElementById('docItemLink').value = '';
            document.getElementById('docItemDesc').value = '';

            updatePreviews();
            console.log(' Document added:', title);
        }

        // Add link item
        function addLinkItem() {
            const text = document.getElementById('linkText').value;
            const url = document.getElementById('linkUrl').value;
            const desc = document.getElementById('linkDesc').value;

            if (!text || !url) {
                alert('Please fill in link text and URL');
                return;
            }

            linkItems.push({
                text: text,
                url: url,
                description: desc,
                id: 'link_' + Date.now()
            });

            // Clear form
            document.getElementById('linkText').value = '';
            document.getElementById('linkUrl').value = '';
            document.getElementById('linkDesc').value = '';

            updatePreviews();
            console.log(' Link added:', text);
        }

        // Update previews
        function updatePreviews() {
            // Update documents preview
            const docPreview = document.getElementById('docItemsPreview');
            if (docPreview) {
                docPreview.innerHTML = documentItems.length === 0 ?
                    '<p style="color: #666; font-style: italic;">No documents added yet</p>' :
                    documentItems.map(doc => `
                <div class="item-preview">
                    <div class="item-info">
                        <strong>${doc.title}</strong><br>
                        <small>${doc.description || 'No description'}</small>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-secondary" onclick="removeDocumentItem('${doc.id}')" style="padding: 2px 8px; font-size: 12px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            }

            // Update links preview
            const linkPreview = document.getElementById('linkItemsPreview');
            if (linkPreview) {
                linkPreview.innerHTML = linkItems.length === 0 ?
                    '<p style="color: #666; font-style: italic;">No links added yet</p>' :
                    linkItems.map(link => `
                <div class="item-preview">
                    <div class="item-info">
                        <strong>${link.text}</strong><br>
                        <small>${link.url}</small>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-secondary" onclick="removeLinkItem('${link.id}')" style="padding: 2px 8px; font-size: 12px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            }
        }

        // Remove document item
        function removeDocumentItem(id) {
            documentItems = documentItems.filter(doc => doc.id !== id);
            updatePreviews();
            console.log(' Document removed:', id);
        }

        // Remove link item
        function removeLinkItem(id) {
            linkItems = linkItems.filter(link => link.id !== id);
            updatePreviews();
            console.log(' Link removed:', id);
        }

        // Create new section - MAIN FUNCTION
        function createNewSection() {
            console.log(' Starting section creation...');

            const sectionType = document.getElementById('sectionType').value;
            const title = document.getElementById('sectionTitle').value;
            const sectionId = document.getElementById('sectionId').value;
            const order = parseInt(document.getElementById('sectionOrder').value);
            const bgColor = document.getElementById('sectionBgColor').value;

            console.log(' Form values:', { sectionType, title, sectionId, order, bgColor });

            // Validation
            if (!title || !sectionId) {
                alert(' Please fill in section title and ID');
                return;
            }

            // Validate section ID
            const validId = sectionId.toLowerCase().replace(/\s+/g, '');
            if (validId !== sectionId) {
                alert('Section ID should be lowercase with no spaces. Suggested: ' + validId);
                document.getElementById('sectionId').value = validId;
                return;
            }

            console.log(' Checking if section exists...');

            // Check if section already exists
            db.ref('customSections/' + validId).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    alert(' A section with this ID already exists. Please choose a different ID.');
                    return;
                }

                console.log(' Section ID is available');

                // Create section data
                const sectionData = {
                    id: validId,
                    title: title,
                    type: sectionType,
                    order: order,
                    backgroundColor: bgColor,
                    createdAt: new Date().toISOString(),
                    createdBy: auth.currentUser.uid
                };

                // Add content based on type
                switch (sectionType) {
                    case 'text':
                        sectionData.content = document.getElementById('sectionContent').value;
                        break;
                    case 'documents':
                        sectionData.documents = documentItems;
                        break;
                    case 'links':
                        sectionData.links = linkItems;
                        break;
                    case 'custom':
                        sectionData.customHTML = document.getElementById('customHTML').value;
                        break;
                }

                console.log(' Saving section data to Firebase...', sectionData);

                // Save to Firebase
                db.ref('customSections/' + validId).set(sectionData)
                    .then(() => {
                        console.log(' Section saved successfully!');
                        alert(' Section created successfully! It will appear on the homepage.');
                        clearSectionForm();
                        loadExistingSections();
                    })
                    .catch(error => {
                        console.error(' Error creating section:', error);
                        alert(' Error creating section: ' + error.message);
                    });
            }).catch(error => {
                console.error(' Error checking section existence:', error);
                alert(' Error checking section: ' + error.message);
            });
        }

        // Clear section form
        function clearSectionForm() {
            document.getElementById('sectionTitle').value = '';
            document.getElementById('sectionId').value = '';
            document.getElementById('sectionContent').value = '';
            document.getElementById('customHTML').value = '';
            document.getElementById('sectionOrder').value = '0';
            document.getElementById('sectionBgColor').value = 'white';

            documentItems = [];
            linkItems = [];
            updatePreviews();

            console.log(' Section form cleared');
        }

        // Load existing sections
        function loadExistingSections() {
            const container = document.getElementById('existingSectionsList');
            if (!container) {
                console.log(' Existing sections container not found');
                return;
            }

            console.log(' Loading existing sections...');
            container.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Loading sections...</p>';

            db.ref('customSections').once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    console.log(' Sections data:', data);

                    if (!data) {
                        container.innerHTML = '<p>No custom sections created yet.</p>';
                        console.log(' No sections found');
                        return;
                    }

                    let html = '';
                    Object.keys(data).forEach(sectionId => {
                        const section = data[sectionId];
                        html += `
                    <div class="section-preview-card">
                        <div class="section-preview-header">
                            <div>
                                <h4>${section.title}</h4>
                                <small>ID: ${section.id} | Order: ${section.order} | Type: <span class="section-type-badge">${section.type}</span></small>
                            </div>
                            <div>
                                <button class="btn" onclick="editSection('${sectionId}')" style="padding: 5px 10px;">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-secondary" onclick="deleteSection('${sectionId}')" style="padding: 5px 10px; background: #dc3545;">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                        <div class="section-content-preview">
                            ${getSectionPreview(section)}
                        </div>
                    </div>
                `;
                    });

                    container.innerHTML = html;
                    console.log(` Loaded ${Object.keys(data).length} sections`);
                })
                .catch(error => {
                    console.error(' Error loading sections:', error);
                    container.innerHTML = '<p style="color: red;">Error loading sections</p>';
                });
        }

        // Get section preview
        function getSectionPreview(section) {
            switch (section.type) {
                case 'text':
                    return `<p>${section.content?.substring(0, 200)}...</p>`;
                case 'documents':
                    return `<p>${section.documents?.length || 0} document(s)</p>`;
                case 'links':
                    return `<p>${section.links?.length || 0} link(s)</p>`;
                case 'custom':
                    return `<div style="color: #666;">Custom HTML content</div>`;
                default:
                    return '<p>No content preview</p>';
            }
        }

        // Edit section
        function editSection(sectionId) {
            console.log(' Editing section:', sectionId);

            // Load section data into editor
            db.ref('customSections/' + sectionId).once('value')
                .then(snapshot => {
                    const section = snapshot.val();
                    if (section) {
                        // Populate form fields
                        document.getElementById('sectionTitle').value = section.title;
                        document.getElementById('sectionId').value = section.id;
                        document.getElementById('sectionType').value = section.type;
                        document.getElementById('sectionOrder').value = section.order;
                        document.getElementById('sectionBgColor').value = section.backgroundColor;

                        // Populate content based on type
                        switch (section.type) {
                            case 'text':
                                document.getElementById('sectionContent').value = section.content || '';
                                break;
                            case 'documents':
                                documentItems = section.documents || [];
                                break;
                            case 'links':
                                linkItems = section.links || [];
                                break;
                            case 'custom':
                                document.getElementById('customHTML').value = section.customHTML || '';
                                break;
                        }

                        toggleSectionFields();
                        updatePreviews();

                        alert('Section loaded for editing. Make changes and click "Create Section" to update.');
                    }
                });
        }

        // Delete section
        function deleteSection(sectionId) {
            if (confirm('Are you sure you want to delete this section? This cannot be undone.')) {
                console.log(' Deleting section:', sectionId);

                db.ref('customSections/' + sectionId).remove()
                    .then(() => {
                        console.log(' Section deleted successfully');
                        alert(' Section deleted successfully!');
                        loadExistingSections();
                    })
                    .catch(error => {
                        console.error(' Error deleting section:', error);
                        alert(' Error deleting section: ' + error.message);
                    });
            }
        }

        // Update the showContentTab function to initialize section creator
        const originalShowContentTab = showContentTab;
        showContentTab = function (tabName) {
            originalShowContentTab(tabName);

            if (tabName === 'sectionCreator') {
                console.log(' Section Creator tab opened - initializing...');
                setTimeout(initSectionCreator, 100);
            }
        };

        console.log(' Section Creator JavaScript loaded successfully');





        // Complaints Management Functions - CORRECTED VERSION
        let currentComplaintsYear = 'year1';
        let currentComplaintsSubTab = 'missingMarks';

        function showComplaintsSubTab(tabName) {
            currentComplaintsSubTab = tabName;

            document.querySelectorAll('#complaintsSection .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#complaintsSection .tab-content').forEach(content => {
                content.style.display = 'none';
            });

            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').style.display = 'block';

            if (tabName === 'missingMarks') {
                loadComplaintsForYear(currentComplaintsYear);
            } else if (tabName === 'anonymousIssues') {
                loadAnonymousIssues(); // This line ensures issues load when tab is clicked
            }
        }
        function showComplaintsYear(year) {
            currentComplaintsYear = year;

            // Update year tabs
            document.querySelectorAll('#missingMarksTab .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update title
            const yearTitles = {
                'year1': '1st Year',
                'year2': '2nd Year',
                'year3': '3rd Year',
                'year4': '4th Year',
                'year5': '5th Year'
            };
            document.getElementById('complaintsYearTitle').textContent = yearTitles[year] + ' Complaints';

            // Load complaints for selected year
            loadComplaintsForYear(year);
        }

        function loadComplaintsForYear(year) {
            const tableBody = document.getElementById('complaintsTableBody');
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Loading complaints...</td></tr>';

            // Determine the Firebase path based on year
            const complaintsPath = year === 'year2' ? 'complaints' : `complaints_${year}`;

            console.log(`Loading complaints from: ${complaintsPath}`);

            if (year === 'year2') {
                // For 2nd year: Load both complaints and registrations to match names
                Promise.all([
                    db.ref(complaintsPath).once('value'),
                    db.ref('registrations').once('value')
                ]).then(([complaintsSnap, registrationsSnap]) => {
                    const complaintsData = complaintsSnap.val() || {};
                    const registrationsData = registrationsSnap.val() || {};

                    console.log('Year2 Complaints data:', complaintsData);
                    console.log('Year2 Registrations data:', registrationsData);

                    const allComplaints = [];

                    // Handle year2 complaints structure: EB24 >> 74506 >> 24 >> timestamp >> data
                    for (const part1 in complaintsData) { // EB24
                        const level1 = complaintsData[part1];
                        if (level1 && typeof level1 === 'object') {
                            for (const part2 in level1) { // 74506
                                const level2 = level1[part2];
                                if (level2 && typeof level2 === 'object') {
                                    for (const part3 in level2) { // 24
                                        const level3 = level2[part3];
                                        if (level3 && typeof level3 === 'object') {
                                            for (const timestamp in level3) {
                                                const complaint = level3[timestamp];
                                                if (complaint && typeof complaint === 'object') {
                                                    // Build the full registration number from the path
                                                    const fullRegNo = `${part1}/${part2}/${part3}`;

                                                    // Extract name from registrations database
                                                    let name = "Unknown";
                                                    if (fullRegNo && typeof fullRegNo === 'string') {
                                                        const regParts = fullRegNo.split('/');
                                                        if (regParts.length === 3) {
                                                            const [group, middle, last] = regParts;
                                                            // Navigate the nested registration structure
                                                            const student = registrationsData[group] &&
                                                                registrationsData[group][middle] &&
                                                                registrationsData[group][middle][last];
                                                            name = student ? student.name : "Unknown";
                                                        }
                                                    }

                                                    allComplaints.push({
                                                        name: name,
                                                        regNo: fullRegNo,
                                                        unit: complaint.unit || 'N/A',
                                                        lecturer: complaint.lecturer || 'N/A',
                                                        timestamp: complaint.submittedAt || timestamp,
                                                        rawTimestamp: timestamp,
                                                        year: year
                                                    });

                                                    console.log(`Found year2 complaint: ${fullRegNo}`, {
                                                        name: name,
                                                        complaintData: complaint
                                                    });
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }

                    displayComplaints(allComplaints, year);
                }).catch(error => {
                    console.error('Error loading year2 complaints:', error);
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">Error loading complaints: ' + error.message + '</td></tr>';
                });
            } else {
                // For other years: Only load complaints (names are stored in complaint data)
                db.ref(complaintsPath).once('value').then(complaintsSnap => {
                    const complaintsData = complaintsSnap.val() || {};
                    console.log(`${year} Complaints data:`, complaintsData);

                    const allComplaints = [];

                    // Process other years structure: EB24  74506  24  timestamp  complaint data
                    for (const part1 in complaintsData) { // EB24
                        const level1 = complaintsData[part1];
                        if (level1 && typeof level1 === 'object') {
                            for (const part2 in level1) { // 74506
                                const level2 = level1[part2];
                                if (level2 && typeof level2 === 'object') {
                                    for (const part3 in level2) { // 24
                                        const level3 = level2[part3];
                                        if (level3 && typeof level3 === 'object') {
                                            for (const timestamp in level3) {
                                                const complaint = level3[timestamp];
                                                if (complaint && typeof complaint === 'object') {
                                                    // Build the full registration number from the path
                                                    const fullRegNo = `${part1}/${part2}/${part3}`;

                                                    // For other years, name is stored directly in complaint data
                                                    const name = complaint.name || "Unknown";

                                                    allComplaints.push({
                                                        name: name,
                                                        regNo: fullRegNo,
                                                        unit: complaint.unit || 'N/A',
                                                        lecturer: complaint.lecturer || 'N/A',
                                                        timestamp: complaint.submittedAt || timestamp,
                                                        rawTimestamp: timestamp,
                                                        year: year
                                                    });
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }

                    displayComplaints(allComplaints, year);
                }).catch(error => {
                    console.error(`Error loading ${year} complaints:`, error);
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">Error loading complaints: ' + error.message + '</td></tr>';
                });
            }
        }

        function displayComplaints(allComplaints, year) {
            const tableBody = document.getElementById('complaintsTableBody');

            console.log(`Displaying ${allComplaints.length} complaints for ${year}`);

            // Sort by timestamp (newest first)
            allComplaints.sort((a, b) => {
                const timeA = a.timestamp ? new Date(a.timestamp).getTime() : parseInt(a.rawTimestamp);
                const timeB = b.timestamp ? new Date(b.timestamp).getTime() : parseInt(b.rawTimestamp);
                return timeB - timeA;
            });

            // Populate table
            tableBody.innerHTML = '';

            if (allComplaints.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No complaints found for this year.</td></tr>';
                return;
            }

            allComplaints.forEach(complaint => {
                const row = document.createElement('tr');

                // Format timestamp properly
                let formattedDate = 'N/A';
                try {
                    if (complaint.timestamp && complaint.timestamp !== 'N/A') {
                        formattedDate = new Date(complaint.timestamp).toLocaleString();
                    } else if (complaint.rawTimestamp) {
                        formattedDate = new Date(parseInt(complaint.rawTimestamp)).toLocaleString();
                    }
                } catch (e) {
                    console.error('Error formatting date:', e);
                    formattedDate = 'Invalid Date';
                }

                row.innerHTML = `
            <td>${complaint.name}</td>
            <td><strong>${complaint.regNo}</strong></td>
            <td>${complaint.unit}</td>
            <td>${complaint.lecturer}</td>
            <td>${formattedDate}</td>
            <td>
                <button class="btn btn-secondary" onclick="resolveComplaint('${complaint.year}', '${complaint.regNo}', '${complaint.rawTimestamp}')" style="padding: 5px 10px; font-size: 0.9em;">
                    Mark Resolved
                </button>
            </td>
        `;
                tableBody.appendChild(row);
            });
        }
        // Helper function to find student name in registration data
        function findStudentName(registrationsData, regNo) {
            // Try to find student by matching registration number in nested structure
            for (const level1 in registrationsData) {
                const groupData = registrationsData[level1];
                if (groupData && typeof groupData === 'object') {
                    for (const level2 in groupData) {
                        const middleData = groupData[level2];
                        if (middleData && typeof middleData === 'object') {
                            for (const level3 in middleData) {
                                const student = middleData[level3];
                                const currentRegNo = `${level1}/${level2}/${level3}`;
                                if (currentRegNo === regNo && student && student.name) {
                                    return student.name;
                                }
                            }
                        }
                    }
                }
            }
            return "Unknown";
        }

        function resolveComplaint(year, regNo, timestamp) {
            if (confirm('Mark this complaint as resolved?')) {
                let fullPath;

                if (year === 'year2') {
                    // Year2 structure: complaints/EB24/74506/24/timestamp
                    const regParts = regNo.split('/');
                    if (regParts.length !== 3) {
                        alert('Invalid registration number format');
                        return;
                    }
                    const [part1, part2, part3] = regParts;
                    fullPath = `complaints/${part1}/${part2}/${part3}/${timestamp}`;
                } else {
                    // Other years structure: complaints_yearX/EB24/74506/24/timestamp
                    const regParts = regNo.split('/');
                    if (regParts.length !== 3) {
                        alert('Invalid registration number format');
                        return;
                    }
                    const [part1, part2, part3] = regParts;
                    fullPath = `complaints_${year}/${part1}/${part2}/${part3}/${timestamp}`;
                }

                console.log(`Deleting complaint at path: ${fullPath}`);

                db.ref(fullPath).remove()
                    .then(() => {
                        alert(' Complaint marked as resolved!');
                        loadComplaintsForYear(year);
                    })
                    .catch(error => {
                        console.error('Error resolving complaint:', error);
                        alert(' Error resolving complaint: ' + error.message);
                    });
            }
        }
        function loadAnonymousIssues() {
            const tableBody = document.getElementById('anonymousIssuesTableBody');
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Loading anonymous issues...</td></tr>';

            db.ref('anonymous_issues').once('value').then(snapshot => {
                const data = snapshot.val();
                tableBody.innerHTML = '';

                if (!data) {
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No anonymous issues found.</td></tr>';
                    return;
                }

                const allIssues = [];
                for (const year in data) {
                    const yearIssues = data[year];
                    for (const issueId in yearIssues) {
                        allIssues.push({
                            ...yearIssues[issueId],
                            year: year,
                            id: issueId
                        });
                    }
                }

                // Sort by timestamp (newest first)
                allIssues.sort((a, b) => b.timestamp - a.timestamp);

                allIssues.forEach(issue => {
                    const row = document.createElement('tr');
                    const date = new Date(parseInt(issue.timestamp)).toLocaleString();

                    row.innerHTML = `
                <td>${getIssueTypeDisplay(issue.issueType)}</td>
                <td style="max-width: 300px; word-wrap: break-word;">${issue.description}</td>
                <td>${issue.year}</td>
                <td>${date}</td>
                <td>
                    <button class="btn btn-secondary" onclick="resolveAnonymousIssue('${issue.year}', '${issue.id}')" style="padding: 5px 10px; font-size: 0.9em;">
                        Mark Resolved
                    </button>
                </td>
            `;
                    tableBody.appendChild(row);
                });
            }).catch(error => {
                console.error('Error loading anonymous issues:', error);
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">Error loading issues</td></tr>';
            });
        }

        function getIssueTypeDisplay(type) {
            const types = {
                'teaching': 'Teaching Quality',
                'resources': 'Learning Resources',
                'facilities': 'Classroom Facilities',
                'schedule': 'Class Schedule',
                'communication': 'Communication',
                'other': 'Other'
            };
            return types[type] || type;
        }

        function resolveComplaint(year, regNo, timestamp) {
            if (confirm('Mark this complaint as resolved?')) {
                const path = year === 'year2' ? 'complaints' : `complaints_${year}`;
                db.ref(`${path}/${regNo}/${timestamp}`).remove()
                    .then(() => {
                        alert(' Complaint marked as resolved!');
                        loadComplaints();
                    })
                    .catch(error => {
                        console.error('Error resolving complaint:', error);
                        alert(' Error resolving complaint: ' + error.message);
                    });
            }
        }

        function resolveAnonymousIssue(year, issueId) {
            if (confirm('Mark this anonymous issue as resolved?')) {
                db.ref(`anonymous_issues/${year}/${issueId}`).remove()
                    .then(() => {
                        alert(' Issue marked as resolved!');
                        loadAnonymousIssues();
                    })
                    .catch(error => {
                        console.error('Error resolving issue:', error);
                        alert(' Error resolving issue: ' + error.message);
                    });
            }
        }

        function exportComplaintsToExcel() {
            alert(' Export feature will be implemented soon!');
        }










        // Add this debug function
        function debugAnonymousIssues() {
            console.log('=== DEBUG: Checking Anonymous Issues Structure ===');
            db.ref('anonymousIssues').once('value').then(snapshot => {
                const data = snapshot.val();
                console.log('Full anonymous issues data:', data);

                if (!data) {
                    console.log('No data found at "anonymousIssues" path');
                    // Check other possible paths
                    db.ref().once('value').then(fullSnapshot => {
                        const allData = fullSnapshot.val();
                        console.log('All Firebase data:', allData);

                        // Look for any paths that might contain anonymous issues
                        for (const key in allData) {
                            if (key.toLowerCase().includes('anonymous') || key.toLowerCase().includes('issue')) {
                                console.log(`Found potential issues path: ${key}`, allData[key]);
                            }
                        }
                    });
                } else {
                    // Show the structure of existing data
                    for (const year in data) {
                        console.log(`Year: ${year}`, data[year]);
                    }
                }
            }).catch(error => {
                console.error('Debug error:', error);
            });
        }

        // Call this to debug
        setTimeout(debugAnonymousIssues, 3000);







        // Trip Shift Management Functions
        let currentTripShiftTab = 'shift1';

        function showTripShiftTab(tabName) {
            currentTripShiftTab = tabName;

            document.querySelectorAll('#tripShiftsSection .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#tripShiftsSection .tab-content').forEach(content => {
                content.style.display = 'none';
            });

            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').style.display = 'block';

            // Load data when tab is switched
            if (tabName === 'stats') {
                loadTripShiftStats();
            } else {
                loadTripShift(tabName);
            }
        }

        function loadTripShift(shift) {
            const tableId = shift + 'Table';
            const countId = shift + 'Count';
            const tableBody = document.querySelector(`#${tableId} tbody`);

            tableBody.innerHTML = `
        <tr>
            <td colspan="5" style="text-align: center; padding: 20px;">
                <i class="fas fa-spinner fa-spin"></i> Loading ${shift} registrations...
            </td>
        </tr>
    `;

            db.ref(`trip/${shift}`).once('value').then(snapshot => {
                const data = snapshot.val();

                if (!data) {
                    tableBody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 20px;">
                        No registrations found for ${shift}.
                    </td>
                </tr>
            `;
                    document.getElementById(countId).textContent = `0/${shift === 'shift1' ? '51' : '52'}`;
                    return;
                }

                const registrations = [];
                let count = 0;

                // Process the data (it's stored with push() keys)
                for (const key in data) {
                    const registration = data[key];
                    if (registration && typeof registration === 'object') {
                        registrations.push({
                            id: key,
                            name: registration.name || 'N/A',
                            regNo: registration.regNo || 'N/A',
                            timestamp: registration.timestamp || 'N/A'
                        });
                        count++;
                    }
                }

                // Sort by timestamp (newest first)
                registrations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                // Update count display
                document.getElementById(countId).textContent = `${count}/${shift === 'shift1' ? '51' : '52'}`;

                // Populate table
                tableBody.innerHTML = '';

                if (registrations.length === 0) {
                    tableBody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 20px;">
                        No registrations found.
                    </td>
                </tr>
            `;
                } else {
                    registrations.forEach((reg, index) => {
                        const formattedDate = formatDate(reg.timestamp);
                        const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${reg.name}</td>
                        <td><strong>${reg.regNo}</strong></td>
                        <td>${formattedDate}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="removeTripRegistration('${shift}', '${reg.id}')" style="padding: 5px 10px; font-size: 0.9em;">
                                Remove
                            </button>
                        </td>
                    </tr>
                `;
                        tableBody.insertAdjacentHTML("beforeend", row);
                    });
                }

            }).catch(error => {
                console.error(`Error loading ${shift}:`, error);
                tableBody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; color: red;">
                    Error loading data: ${error.message}
                </td>
            </tr>
        `;
            });
        }

        function loadTripShiftStats() {
            // Load both shifts to calculate statistics
            Promise.all([
                db.ref('trip/shift1').once('value'),
                db.ref('trip/shift2').once('value')
            ]).then(([shift1Snap, shift2Snap]) => {
                const shift1Data = shift1Snap.val() || {};
                const shift2Data = shift2Snap.val() || {};

                const shift1Count = Object.keys(shift1Data).length;
                const shift2Count = Object.keys(shift2Data).length;
                const totalCount = shift1Count + shift2Count;

                // Update statistics
                document.getElementById('totalTripRegs').textContent = totalCount;
                document.getElementById('shift1Percentage').textContent =
                    Math.round((shift1Count / 51) * 100) + '%';
                document.getElementById('shift2Percentage').textContent =
                    Math.round((shift2Count / 52) * 100) + '%';

                const availableSpots = (51 - shift1Count) + (52 - shift2Count);
                document.getElementById('availableSpots').textContent = availableSpots;

                // Update count badges
                document.getElementById('shift1Count').textContent = `${shift1Count}/51`;
                document.getElementById('shift2Count').textContent = `${shift2Count}/52`;

            }).catch(error => {
                console.error('Error loading trip stats:', error);
                alert('Error loading statistics: ' + error.message);
            });
        }

        function removeTripRegistration(shift, registrationId) {
            if (confirm('Are you sure you want to remove this registration?')) {
                db.ref(`trip/${shift}/${registrationId}`).remove()
                    .then(() => {
                        alert(' Registration removed successfully!');
                        loadTripShift(shift);
                        loadTripShiftStats();
                    })
                    .catch(error => {
                        console.error('Error removing registration:', error);
                        alert(' Error removing registration: ' + error.message);
                    });
            }
        }

        function exportTripShifts() {
            // First load all data
            Promise.all([
                db.ref('trip/shift1').once('value'),
                db.ref('trip/shift2').once('value')
            ]).then(([shift1Snap, shift2Snap]) => {
                const shift1Data = shift1Snap.val() || {};
                const shift2Data = shift2Snap.val() || {};

                // Prepare data for export
                const exportData = [];

                // Process Shift 1
                Object.keys(shift1Data).forEach((key, index) => {
                    const student = shift1Data[key];
                    exportData.push({
                        'Shift': 'Shift 1',
                        'No.': index + 1,
                        'Full Name': student.name || 'N/A',
                        'Registration Number': student.regNo || 'N/A',
                        'Phone': student.phone || 'N/A',
                        'Email': student.email || 'N/A',
                        'Timestamp': formatDateForExcel(student.timestamp),
                        'Registered At': formatDate(student.timestamp)
                    });
                });

                // Process Shift 2
                Object.keys(shift2Data).forEach((key, index) => {
                    const student = shift2Data[key];
                    exportData.push({
                        'Shift': 'Shift 2',
                        'No.': exportData.filter(item => item['Shift'] === 'Shift 1').length + index + 1,
                        'Full Name': student.name || 'N/A',
                        'Registration Number': student.regNo || 'N/A',
                        'Phone': student.phone || 'N/A',
                        'Email': student.email || 'N/A',
                        'Timestamp': formatDateForExcel(student.timestamp),
                        'Registered At': formatDate(student.timestamp)
                    });
                });

                if (exportData.length === 0) {
                    alert('No trip shift registrations found to export.');
                    return;
                }

                // Create Excel workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);

                // Set column widths
                const wscols = [
                    { wch: 10 }, // Shift
                    { wch: 5 },  // No.
                    { wch: 25 }, // Full Name
                    { wch: 20 }, // Registration Number
                    { wch: 15 }, // Phone
                    { wch: 30 }, // Email
                    { wch: 25 }, // Timestamp (Excel)
                    { wch: 25 }  // Registered At (Formatted)
                ];
                ws['!cols'] = wscols;

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Trip Registrations');

                // Add summary sheet
                const summaryData = [
                    { 'Statistic': 'Shift 1 Registrations', 'Count': Object.keys(shift1Data).length, 'Capacity': '51' },
                    { 'Statistic': 'Shift 2 Registrations', 'Count': Object.keys(shift2Data).length, 'Capacity': '52' },
                    { 'Statistic': 'Total Registrations', 'Count': Object.keys(shift1Data).length + Object.keys(shift2Data).length, 'Capacity': '103' },
                    { 'Statistic': 'Shift 1 Available', 'Count': 51 - Object.keys(shift1Data).length, 'Capacity': '-' },
                    { 'Statistic': 'Shift 2 Available', 'Count': 52 - Object.keys(shift2Data).length, 'Capacity': '-' },
                    { 'Statistic': 'Export Date', 'Count': new Date().toLocaleDateString(), 'Capacity': '-' }
                ];

                const ws2 = XLSX.utils.json_to_sheet(summaryData);
                ws2['!cols'] = [{ wch: 25 }, { wch: 15 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, ws2, 'Summary');

                // Generate filename with timestamp
                const date = new Date();
                const timestamp = `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}_${date.getHours().toString().padStart(2, '0')}${date.getMinutes().toString().padStart(2, '0')}`;
                const filename = `Trip_Shifts_${timestamp}.xlsx`;

                // Export to Excel
                XLSX.writeFile(wb, filename);

                // Show success message
                alert(` Exported ${exportData.length} registrations to ${filename}`);

            }).catch(error => {
                console.error('Error exporting trip shifts:', error);
                alert(' Error exporting trip shifts: ' + error.message);
            });
        }

        // Helper function for Excel date format
        function formatDateForExcel(timestamp) {
            if (!timestamp || timestamp === 'N/A') return 'N/A';
            try {
                const date = new Date(timestamp);
                // Excel uses a different date format (YYYY-MM-DD HH:MM:SS)
                return date.toISOString().split('T')[0] + ' ' +
                    date.toTimeString().split(' ')[0];
            } catch (e) {
                return timestamp;
            }
        }

        // Update the showSection function to include trip shifts
        function showSection(sectionName) {
            console.log('Showing section:', sectionName);

            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });

            // Show selected section
            const targetSection = document.getElementById(sectionName + 'Section');
            if (targetSection) {
                targetSection.style.display = 'block';
            }

            // Update current section title
            const titles = {
                'dashboard': 'Dashboard Overview',
                'content': 'Content Management',
                'registrations': 'Student Registrations',
                'complaints': 'Academic Complaints Management',
                'groups': 'Group Management',
                'pending': 'Pending Students',
                'announcements': 'Announcements Management',
                'users': 'User Management',
                'settings': 'System Settings',
                'tripShifts': 'Trip Shift Registrations'  // Add this line
            };
            document.getElementById('currentSection').textContent = titles[sectionName] || sectionName;

            // Update active nav
            document.querySelectorAll('.nav-links li').forEach(li => {
                li.classList.remove('active');
            });
            event.target.closest('li').classList.add('active');

            // Load data when trip shifts section is opened
            if (sectionName === 'tripShifts') {
                loadTripShift('shift1');
                loadTripShiftStats();
            }
        }
    </script>
</body>

</html>