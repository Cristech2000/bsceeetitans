<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>View Complaints - Academic Support Center</title>
  <script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h2 {
      color: #333;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f5f5f5;
    }
    button {
      margin-top: 20px;
      padding: 8px 12px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>Submitted Complaints</h2>
  <table id="complaintsTable">
    <thead>
      <tr>
        <th>Reg No</th>
        <th>Name</th>
        <th>Phone</th>
        <th>Unit</th>
        <th>Type</th>
        <th>Timestamp</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button onclick="exportToExcel()">Export to Excel</button>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://bsceee-webpage-default-rtdb.firebaseio.com",
      projectId: "bsceee-webpage",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function loadComplaints() {
      const complaintsRef = db.ref("complaints");
      const tableBody = document.querySelector("#complaintsTable tbody");
      tableBody.innerHTML = "";

      complaintsRef.once("value", async (snapshot) => {
        const complaints = snapshot.val();
        if (!complaints) {
          tableBody.innerHTML = "<tr><td colspan='6'>No complaints submitted yet.</td></tr>";
          return;
        }

        for (const regNoKey in complaints) {
          const studentComplaints = complaints[regNoKey];
          for (const timestamp in studentComplaints) {
            const complaint = studentComplaints[timestamp];
            const actualRegNo = complaint.regNo || "N/A";

            // Fetch student name & phone from registration
            let name = "Not Found";
            let phone = "Not Found";
            try {
              const regSnap = await db.ref(`registrations/${actualRegNo}`).once("value");
              if (regSnap.exists()) {
                const data = regSnap.val();
                name = data.name || "N/A";
                phone = data.phone || "N/A";
              }
            } catch (err) {
              console.error("Error fetching registration:", err);
            }

            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${actualRegNo}</td>
              <td>${name}</td>
              <td>${phone}</td>
              <td>${complaint.unit || "-"}</td>
              <td>${complaint.type || "-"}</td>
              <td>${new Date(timestamp).toLocaleString()}</td>
            `;
            tableBody.appendChild(row);
          }
        }
      });
    }

    function exportToExcel() {
      const table = document.getElementById("complaintsTable");
      const wb = XLSX.utils.table_to_book(table, { sheet: "Complaints" });
      XLSX.writeFile(wb, "complaints.xlsx");
    }

    loadComplaints();
  </script>
</body>
</html>
