<!DOCTYPE html>
<html>
<head>
  <title>Submitted Complaints</title>
  <script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    table, th, td {
      border: 1px solid #aaa;
    }
    th, td {
      padding: 10px;
      text-align: left;
    }
    #exportBtn {
      margin-top: 10px;
      padding: 8px 15px;
    }
  </style>
</head>
<body>
  <h2>All Submitted Complaints</h2>
  <button id="exportBtn">Export to Excel</button>
  <table id="complaintsTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Reg No</th>
        <th>Unit</th>
        <th>Type</th>
        <th>Timestamp</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "bsceee-webpage.firebaseapp.com",
      databaseURL: "https://bsceee-webpage-default-rtdb.firebaseio.com",
      projectId: "bsceee-webpage",
      storageBucket: "bsceee-webpage.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Load registration names
    async function loadRegistrations() {
      const snapshot = await db.ref("registrations").once("value");
      const regData = {};

      snapshot.forEach(child1 => {
        const part1 = child1.key; // e.g. '67214'
        child1.forEach(child2 => {
          const part2 = child2.key; // e.g. '23'
          const data = child2.val();
          const fullRegNo = `EB24/${part1}/${part2}`;
          regData[fullRegNo] = data;
        });
      });

      return regData;
    }

    // Load complaints and map with names
    async function loadComplaints() {
      const regMap = await loadRegistrations();
      const complaintSnap = await db.ref("complaints").once("value");
      const tbody = document.querySelector("#complaintsTable tbody");
      tbody.innerHTML = "";

      complaintSnap.forEach(studentNode => {
        const regNo = studentNode.key;
        studentNode.forEach(entry => {
          const { unit = "-", type = "-", timestamp = "-" } = entry.val() || {};
          const student = regMap[regNo] || {};
          const name = student.name || "-";

          const row = tbody.insertRow();
          row.insertCell(0).innerText = name;
          row.insertCell(1).innerText = regNo;
          row.insertCell(2).innerText = unit;
          row.insertCell(3).innerText = type;
          row.insertCell(4).innerText = new Date(timestamp).toLocaleString();
        });
      });
    }

    loadComplaints();

    // Export to Excel
    document.getElementById("exportBtn").addEventListener("click", () => {
      const table = document.getElementById("complaintsTable");
      const workbook = XLSX.utils.table_to_book(table, { sheet: "Complaints" });
      XLSX.writeFile(workbook, "complaints.xlsx");
    });
  </script>
</body>
</html>
